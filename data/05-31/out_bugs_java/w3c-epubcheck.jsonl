{"repository": "w3c/epubcheck", "strategy": "UNKNOWN", "clone_url": "https://github.com/w3c/epubcheck.git", "commit_timestamp": "2023-05-30T19:21:12.290670Z", "timestamp": "2023-05-30T19:21:12.290670Z", "commit_hash": "1b425fd1cdcbf4f51fa797fdeb2e34cca64f80ec", "commit_message": "fix: allow remote URLs in HTML \"cite\" attributes\n\nThe resources referenced in `cite` attribute URLs are not publication resources.\n\nThis commit disables the publication-resource-specific URL checks for the `cite` attribute. For instance, the referenced document is not subject to resource location restrictions.\n\nThe URL is still registered in the reference registry, so that the existence of the underlying container resource is checked (for relative URLs).\n\nFix #1495\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\nindex 7e48144..9f63ab7 100644\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n@@ -448,7 +448,7 @@ public class OPSHandler30 extends OPSHandler\n \n   private void checkCiteAttribute()\n   {\n-    URL url = checkResourceURL(currentElement().getAttribute(\"cite\"));\n+    URL url = checkURL(currentElement().getAttribute(\"cite\"));\n     registerReference(url, Type.CITE);\n   }\n \ndiff --git a/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java b/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java\nindex 214750a..c4c91a9 100755\n--- a/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java\n+++ b/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java\n@@ -177,7 +177,7 @@ public class ResourceReferencesChecker\n           report.message(MessageId.RSC_012, reference.location.context(reference.url.toString()));\n           throw new CheckAbortException();\n         }\n-        \n+\n         switch (reference.type)\n         {\n         case SVG_PAINT:\n@@ -189,6 +189,7 @@ public class ResourceReferencesChecker\n           }\n           break;\n         case SVG_SYMBOL:\n+        case CITE:\n         case HYPERLINK:\n         case OVERLAY_TEXT_LINK:\n           if (targetIDType != reference.type && targetIDType != Reference.Type.GENERIC)\n@@ -334,7 +335,8 @@ public class ResourceReferencesChecker\n         // links and remote hyperlinks are not Publication Resources\n         && !(reference.type == Reference.Type.LINK\n             || container.isRemote(reference.targetResource)\n-                && reference.type == Reference.Type.HYPERLINK))\n+                && (reference.type == Reference.Type.HYPERLINK\n+                    || reference.type == Reference.Type.CITE)))\n     {\n       undeclared.add(reference.targetResource);\n       report.message(MessageId.RSC_008, reference.location,\n@@ -351,7 +353,8 @@ public class ResourceReferencesChecker\n \n     // Check if the remote reference is allowed\n     if (// remote links and hyperlinks are not Publication Resources\n-    !EnumSet.of(Reference.Type.LINK, Reference.Type.HYPERLINK).contains(reference.type)\n+    !EnumSet.of(Reference.Type.CITE, Reference.Type.LINK, Reference.Type.HYPERLINK)\n+        .contains(reference.type)\n         // spine items are checked in OPFChecker30\n         && !(version == EPUBVersion.VERSION_3 && targetResource.isPresent()\n             && targetResource.get().isInSpine())\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..e10cd67\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t\t<q cite=\"https://example.org/cite.html\">text</q>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/nav.xhtml b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/package.opf b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..0d1eec6\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/EPUB/package.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/META-INF/container.xml b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/mimetype b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-xhtml-cite-absolute-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/04-ocf/ocf.feature b/src/test/resources/epub3/04-ocf/ocf.feature\nindex b5c1117..fb53334 100644\n--- a/src/test/resources/epub3/04-ocf/ocf.feature\n+++ b/src/test/resources/epub3/04-ocf/ocf.feature\n@@ -156,8 +156,12 @@ Feature: EPUB 3 \u2014 Open Container Format\n \n   #### resource existence checks:\n \n+  Scenario: Allow an absolute `cite` URL\n+    When checking EPUB 'url-xhtml-cite-absolute-valid'\n+    Then no errors or warnings are reported\n+\n   @spec @xref:sec-container-iri\n-  Scenario: Report a reference from an XHTML `cite` attribute not declared in the manifest\n+  Scenario: Report a relative `cite` URL when the resource is not found in the manifest\n     When checking EPUB 'url-xhtml-cite-missing-resource-error'\n     Then error RSC-007 is reported 4 times\n     And no other errors or warnings are reported\n@@ -168,7 +172,7 @@ Feature: EPUB 3 \u2014 Open Container Format\n     Then error RSC-007 is reported\n     And no other errors or warnings are reported\n \n-  @spec @xref:sec-exempt-resources\n+  @spec @xref:sec-container-iri\n   Scenario: Report a reference from an XHTML `track` not declared in the manifest\n     When checking EPUB 'url-xhtml-track-missing-resource-error'\n     Then error RSC-007 is reported\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T19:28:51.788412Z", "commit_hash": "2332d53fcc9e160ee34121200beb20cb44503348", "commit_message": "feat: allow \"pageBreakSource\" package metadata (incubation)\n\nThe [\"pageBreakSource\"](https://www.w3.org/publishing/a11y/page-source-id/#pageBreakSource) package metadata property is planned to be added to EPUB, after 3.3.\n\nThis commit allows this property to start incubating its use.\n\nFix #1491\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\nindex c66a4d1..e625e5c 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n@@ -45,6 +45,7 @@ import static com.adobe.epubcheck.vocab.PackageVocabs.LINKREL_VOCAB;\n import static com.adobe.epubcheck.vocab.PackageVocabs.LINK_VOCAB;\n import static com.adobe.epubcheck.vocab.PackageVocabs.LINK_VOCAB_URI;\n import static com.adobe.epubcheck.vocab.PackageVocabs.META_VOCAB;\n+import static com.adobe.epubcheck.vocab.PackageVocabs.META_VOCAB_CAMEL;\n import static com.adobe.epubcheck.vocab.PackageVocabs.META_VOCAB_URI;\n \n import java.util.Deque;\n@@ -65,6 +66,7 @@ import com.adobe.epubcheck.opf.ResourceCollection.Roles;\n import com.adobe.epubcheck.util.EpubConstants;\n import com.adobe.epubcheck.util.FeatureEnum;\n import com.adobe.epubcheck.vocab.AccessibilityVocab;\n+import com.adobe.epubcheck.vocab.AggregateVocab;\n import com.adobe.epubcheck.vocab.DCMESVocab;\n import com.adobe.epubcheck.vocab.EpubCheckVocab;\n import com.adobe.epubcheck.vocab.MediaOverlaysVocab;\n@@ -94,7 +96,7 @@ public class OPFHandler30 extends OPFHandler\n       .put(DCTERMS_PREFIX, DCTERMS_VOCAB).put(MARC_PREFIX, MARC_VOCAB).put(ONIX_PREFIX, ONIX_VOCAB)\n       .put(SCHEMA_PREFIX, SCHEMA_VOCAB).put(XSD_PREFIX, XSD_VOCAB).build();\n   private static final Map<String, Vocab> RESERVED_META_VOCABS = new ImmutableMap.Builder<String, Vocab>()\n-      .put(\"\", META_VOCAB).put(AccessibilityVocab.PREFIX, AccessibilityVocab.META_VOCAB)\n+      .put(\"\", AggregateVocab.of(META_VOCAB, META_VOCAB_CAMEL)).put(AccessibilityVocab.PREFIX, AccessibilityVocab.META_VOCAB)\n       .put(MediaOverlaysVocab.PREFIX, MediaOverlaysVocab.VOCAB)\n       .put(RenditionVocabs.PREFIX, RenditionVocabs.META_VOCAB).putAll(RESERVED_VOCABS).build();\n   private static final Map<String, Vocab> RESERVED_ITEM_VOCABS = new ImmutableMap.Builder<String, Vocab>()\ndiff --git a/src/main/java/com/adobe/epubcheck/vocab/PackageVocabs.java b/src/main/java/com/adobe/epubcheck/vocab/PackageVocabs.java\nindex b13509b..12f38fc 100644\n--- a/src/main/java/com/adobe/epubcheck/vocab/PackageVocabs.java\n+++ b/src/main/java/com/adobe/epubcheck/vocab/PackageVocabs.java\n@@ -3,6 +3,7 @@ package com.adobe.epubcheck.vocab;\n import java.util.Set;\n \n import com.adobe.epubcheck.opf.ValidationContext;\n+import com.google.common.base.CaseFormat;\n import com.google.common.base.Preconditions;\n import com.google.common.collect.ImmutableSet;\n \n@@ -37,6 +38,14 @@ public final class PackageVocabs\n     TITLE_TYPE\n   }\n \n+  public static EnumVocab<META_PROPERTIES_CAMEL> META_VOCAB_CAMEL = new EnumVocab<META_PROPERTIES_CAMEL>(\n+      META_PROPERTIES_CAMEL.class, CaseFormat.LOWER_CAMEL, META_VOCAB_URI);\n+\n+  public static enum META_PROPERTIES_CAMEL\n+  {\n+    PAGE_BREAK_SOURCE,\n+  }\n+\n   public static EnumVocab<ITEM_PROPERTIES> ITEM_VOCAB = new EnumVocab<ITEM_PROPERTIES>(\n       ITEM_PROPERTIES.class, ITEM_VOCAB_URI);\n \ndiff --git a/src/test/resources/epub3/D-vocabularies/files/metadata-meta-pageBreakSource-valid.opf b/src/test/resources/epub3/D-vocabularies/files/metadata-meta-pageBreakSource-valid.opf\nnew file mode 100644\nindex 0000000..c85853c\n--- /dev/null\n+++ b/src/test/resources/epub3/D-vocabularies/files/metadata-meta-pageBreakSource-valid.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" unique-identifier=\"uid\"\n+    xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <metadata>\n+        <dc:title>Title</dc:title>\n+        <dc:language>en</dc:language>\n+        <dc:identifier id=\"uid\">NOID</dc:identifier>\n+        <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n+        <meta property=\"pageBreakSource\">example</meta>\n+    </metadata>\n+    <manifest>\n+        <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\n+    </manifest>\n+    <spine>\n+        <itemref idref=\"t001\"/>\n+    </spine>\n+</package>\n", "test_patch": "diff --git a/src/test/resources/epub3/D-vocabularies/meta-properties.feature b/src/test/resources/epub3/D-vocabularies/meta-properties.feature\nindex 470eb37..d5ee39c 100644\n--- a/src/test/resources/epub3/D-vocabularies/meta-properties.feature\n+++ b/src/test/resources/epub3/D-vocabularies/meta-properties.feature\n@@ -250,3 +250,12 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Meta properties vocabulary\n     Then error RSC-005 is reported\n     And the message contains '\"title-type\" cannot be declared more than once'\n     And no other errors or warnings are reported\n+\n+\n+  ## Incubation\n+\n+  @spec @xref:sec-title-type\n+  Scenario: 'pageBreakSource' metadata is allowed \n+    When checking file 'metadata-meta-pageBreakSource-valid.opf'\n+    Then no errors or warnings are reported\n+\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T19:35:33.027094Z", "commit_hash": "03236685b6bf3b1422a3c2b90a51c8c94bd9a0ea", "commit_message": "fix: normalize URLs before checking if the resources exist\n\nURLs were not normalized before performing existence checks. So percent-encoded URLs sometimes triggered `RSC-001` or `RSC-007` errors.\n\nThis commit introduces a new `normalize(URL)` method in the `URLUtils` class. Normalization is now used when checking a URL. This notably applies to resource and ID existence checks.\n\nImportant Note:\n  URL normalization is not well-defined. Some percent-encoding normalization is described in RFC3986, but is not defined in the URL standard. Also, normalization (as useful for EPUBCheck) is also dependent on the URL scheme.\n  The normalization we apply is quite na\u00efve and might need to be improved in the future. It should however cover the majority of HTTP URL real-world scenarios.\n\nFix #1479\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/ocf/OCFContainer.java b/src/main/java/com/adobe/epubcheck/ocf/OCFContainer.java\nindex 6ebf171..ebaf4d0 100644\n--- a/src/main/java/com/adobe/epubcheck/ocf/OCFContainer.java\n+++ b/src/main/java/com/adobe/epubcheck/ocf/OCFContainer.java\n@@ -79,7 +79,14 @@ public final class OCFContainer implements GenericResourceProvider\n \n   public boolean contains(URL resource)\n   {\n-    return resources.containsKey(resource);\n+    if (resources.containsKey(resource))\n+    {\n+      return true;\n+    }\n+    else\n+    {\n+      return resources.containsKey(URLUtils.normalize(resource));\n+    }\n   }\n \n   @Override\n@@ -134,5 +141,4 @@ public final class OCFContainer implements GenericResourceProvider\n     }\n   }\n \n-\n }\ndiff --git a/src/main/java/org/w3c/epubcheck/core/references/URLChecker.java b/src/main/java/org/w3c/epubcheck/core/references/URLChecker.java\nindex 080e6f0..f7ba681 100644\n--- a/src/main/java/org/w3c/epubcheck/core/references/URLChecker.java\n+++ b/src/main/java/org/w3c/epubcheck/core/references/URLChecker.java\n@@ -2,6 +2,8 @@ package org.w3c.epubcheck.core.references;\n \n import java.net.URI;\n \n+import org.w3c.epubcheck.util.url.URLUtils;\n+\n import com.adobe.epubcheck.api.EPUBLocation;\n import com.adobe.epubcheck.api.Report;\n import com.adobe.epubcheck.messages.MessageId;\n@@ -64,7 +66,7 @@ public class URLChecker\n \n   public URL checkURL(String string, EPUBLocation location)\n   {\n-    URL url = resolveURL(string, false, location);\n+    URL url = URLUtils.normalize(resolveURL(string, false, location));\n     return url;\n   }\n \ndiff --git a/src/main/java/org/w3c/epubcheck/util/url/URLUtils.java b/src/main/java/org/w3c/epubcheck/util/url/URLUtils.java\nindex 526e869..e58146e 100644\n--- a/src/main/java/org/w3c/epubcheck/util/url/URLUtils.java\n+++ b/src/main/java/org/w3c/epubcheck/util/url/URLUtils.java\n@@ -14,6 +14,7 @@ import com.google.common.base.Preconditions;\n import io.mola.galimatias.GalimatiasParseException;\n import io.mola.galimatias.ParseIssue;\n import io.mola.galimatias.URL;\n+import io.mola.galimatias.canonicalize.DecodeUnreservedCanonicalizer;\n \n //FIXME 2022 add unit tests\n public final class URLUtils\n@@ -79,9 +80,9 @@ public final class URLUtils\n    * in EPUB (to test for remote resources compared to container URLs).\n    * \n    * @param test\n-   *          the URL to test\n+   *        the URL to test\n    * @param local\n-   *          the URL it is tested against\n+   *        the URL it is tested against\n    * @return `true` if and only if `test` is remote compared to `local`.\n    */\n   public static boolean isRemote(URL test, URL local)\n@@ -151,13 +152,33 @@ public final class URLUtils\n     return percentDecode(string);\n   }\n \n+  public static URL normalize(URL url)\n+  {\n+    URL normalized = url;\n+    if (url != null)\n+    {\n+      try\n+      {\n+        if (url.isHierarchical() && url.path() != null)\n+        {\n+          normalized = url.withPath(URLUtils.encodePath(URLUtils.decode(url.path())));\n+        }\n+        normalized = new DecodeUnreservedCanonicalizer().canonicalize(normalized);\n+      } catch (GalimatiasParseException unexpected)\n+      {\n+        throw new AssertionError(unexpected);\n+      }\n+    }\n+    return normalized;\n+  }\n+\n   /**\n    * Returns the MIME type of a `data:` URL.\n    * \n    * @param url\n-   *          a URL, can be `null`.\n+   *        a URL, can be `null`.\n    * @return the MIME type declared in the data URL (can be an empty string), or\n-   *         `null` if `url` is not a data URL.\n+   *           `null` if `url` is not a data URL.\n    */\n   public static String getDataURLType(URL url)\n   {\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/content&001.xhtml b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/content&001.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/content&001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/nav.xhtml b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..7f34f30\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content%26001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/package.opf b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..552655b\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/EPUB/package.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content%26001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/META-INF/container.xml b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/mimetype b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/04-ocf/files/url-percent-encoded-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/04-ocf/ocf.feature b/src/test/resources/epub3/04-ocf/ocf.feature\nindex 7a0dba3..b5c1117 100644\n--- a/src/test/resources/epub3/04-ocf/ocf.feature\n+++ b/src/test/resources/epub3/04-ocf/ocf.feature\n@@ -114,6 +114,12 @@ Feature: EPUB 3 \u2014 Open Container Format\n     When checking EPUB 'url-in-xhtml-valid.xhtml'\n     And no errors or warnings are reported\n \n+  @spec @xref:sec-container-iri\n+  Scenario: Allow percent-encoded URLs\n+    When checking EPUB 'url-percent-encoded-valid'\n+    And no errors or warnings are reported\n+\n+\n   #### Invalid container URLs\n \n   @spec @xref:sec-container-iri\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T19:42:40.818369Z", "commit_hash": "fc5e360b80b4e6aad66608e70d75ededee12d560", "commit_message": "fix: allow decimal viewport dimensions in fixed-layout\n\nThe spec only says dimensions must be a \"positive number\" (or keyword), it does not specifically forbid decimal values.\n\nFix #1481\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/org/w3c/epubcheck/util/microsyntax/ViewportMeta.java b/src/main/java/org/w3c/epubcheck/util/microsyntax/ViewportMeta.java\nindex 2e20feb..f57d59d 100644\n--- a/src/main/java/org/w3c/epubcheck/util/microsyntax/ViewportMeta.java\n+++ b/src/main/java/org/w3c/epubcheck/util/microsyntax/ViewportMeta.java\n@@ -12,8 +12,8 @@ import com.google.common.collect.ListMultimap;\n \n public class ViewportMeta\n {\n-  private static Pattern VIEWPORT_HEIGHT_REGEX = Pattern.compile(\"\\\\d+|device-height\");\n-  private static Pattern VIEWPORT_WIDTH_REGEX = Pattern.compile(\"\\\\d+|device-width\");\n+  private static Pattern VIEWPORT_HEIGHT_REGEX = Pattern.compile(\"\\\\d+(\\\\.\\\\d+)?|device-height\");\n+  private static Pattern VIEWPORT_WIDTH_REGEX = Pattern.compile(\"\\\\d+(\\\\.\\\\d+)?|device-width\");\n \n   public static ViewportMeta parse(String string, ErrorHandler errorHandler)\n   {\n@@ -26,6 +26,7 @@ public class ViewportMeta\n     switch (Preconditions.checkNotNull(name))\n     {\n     case \"width\":\n+      \n       return VIEWPORT_WIDTH_REGEX.matcher(value).matches();\n     case \"height\":\n       return VIEWPORT_HEIGHT_REGEX.matcher(value).matches();\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..a1e1ec9\n--- /dev/null\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<meta name=\"viewport\" content=\"width=600.999,height=1200.5\" />\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/nav.xhtml b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/package.opf b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..d16a30d\n--- /dev/null\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <meta property=\"rendition:layout\">pre-paginated</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/META-INF/container.xml b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/mimetype b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-xhtml-viewport-float-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/08-layout/layout.feature b/src/test/resources/epub3/08-layout/layout.feature\nindex ee1a5cf..b442ed9 100644\n--- a/src/test/resources/epub3/08-layout/layout.feature\n+++ b/src/test/resources/epub3/08-layout/layout.feature\n@@ -215,6 +215,11 @@ Feature: EPUB 3 \u2014 Layout Rendering Control\n     Then no errors or warnings are reported\n \n   @spec @xref:sec-fxl-content-dimensions\n+  Scenario: Verify a fixed-layout XHTML document with non-integer viewport dimensions\n+    When checking EPUB 'content-fxl-xhtml-viewport-float-valid'\n+    Then no errors or warnings are reported\n+\n+  @spec @xref:sec-fxl-content-dimensions\n   Scenario: Verify a fixed-layout XHTML document with a valid viewport with whitespace\n     When checking EPUB 'content-fxl-xhtml-viewport-whitespace-valid'\n     Then no errors or warnings are reported\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T19:51:03.537090Z", "commit_hash": "b81a77d07c796a6ba1841b5b375bfa31d16378f6", "commit_message": "fix: do not check fragment identifiers on PDF references\n\nFix #1482\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java b/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java\nindex 8169de7..214750a 100755\n--- a/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java\n+++ b/src/main/java/org/w3c/epubcheck/core/references/ResourceReferencesChecker.java\n@@ -169,11 +169,15 @@ public class ResourceReferencesChecker\n       {\n         Reference.Type targetIDType = resourceRegistry.getIDType(fragment.getId(),\n             targetResource);\n-        if (targetIDType == null)\n+\n+        // Check that target ID exists (if the target is XHTML or SVG)\n+        if (targetIDType == null\n+            && (MIMEType.SVG.is(targetMimetype) || MIMEType.XHTML.is(targetMimetype)))\n         {\n           report.message(MessageId.RSC_012, reference.location.context(reference.url.toString()));\n           throw new CheckAbortException();\n         }\n+        \n         switch (reference.type)\n         {\n         case SVG_PAINT:\ndiff --git a/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..9f58a88\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t\t<object data=\"test.pdf#view=FitV\" type=\"application/pdf\"></object>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/nav.xhtml b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/package.opf b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..3f950dc\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"pdf\" href=\"test.pdf\" media-type=\"application/pdf\" fallback=\"content_001\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/test.pdf b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/EPUB/test.pdf\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/META-INF/container.xml b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/mimetype b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/object-pdf-fragment-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex faf46a1..28769d1 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -523,6 +523,11 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n     And no other errors or warnings are reported\n \n \n+  #### Objects\n+\n+  Scenario: Allow fragment identifiers on PDFs\n+    When checking EPUB 'object-pdf-fragment-valid'\n+    Then no errors or warnings are reported\n \n   ####  Schematron Assertions\n \n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T20:05:57.375298Z", "commit_hash": "3c8dab363161be9e7f074d09fe9bba59425b3d39", "commit_message": "fix: allow nav items containing multiple images\n\nA bug in the Schematron XPath expressions caused a fatal error to be reported when nav doc items contained multiple images.\n\nThis commit fix the relevant expressions by using the `string-join` function instead of `concat`, allowing to join arbitrary sequences of text nodes.\n\nFix #1476\n", "related_issues": "", "bug_patch": "diff --git a/src/main/resources/com/adobe/epubcheck/schema/30/edupub/edu-structure.sch b/src/main/resources/com/adobe/epubcheck/schema/30/edupub/edu-structure.sch\nindex 494c29e..3f55f80 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/edupub/edu-structure.sch\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/edupub/edu-structure.sch\n@@ -35,7 +35,7 @@\n \t\t\t\n \t\t\t<report test=\"count($headings) &gt; 1\">More than one ranked heading found as direct descendant of body.</report>\n \t\t\t\n-\t\t\t<report test=\"count($headings) = 1 and string-length(normalize-space(concat($headings,$headings/html:img/@alt,$headings//@aria-label))) = 0\">Empty ranked heading detected.</report>\n+\t\t\t<report test=\"count($headings) = 1 and string-length(normalize-space(string-join($headings|$headings/html:img/@alt|$headings//@aria-label))) = 0\">Empty ranked heading detected.</report>\n \t\t\t\n \t\t\t<report test=\"@aria-label and (normalize-space($headings) = normalize-space(@aria-label))\">The value of the \"aria-label\" attribute must not be the same as the content of the heading.</report>\n \t\t</rule>\n@@ -53,7 +53,7 @@\n \t\t\t\n \t\t\t<report test=\"count($headings) &gt; 1\">More than one ranked heading found as direct descendant of <value-of select=\"name()\"/>.</report>\n \t\t\t\n-\t\t\t<report test=\"count($headings) = 1 and string-length(normalize-space(concat($headings,$headings/html:img/@alt,$headings//@aria-label))) = 0\">Empty ranked heading detected.</report>\n+\t\t\t<report test=\"count($headings) = 1 and string-length(normalize-space(string-join($headings|$headings/html:img/@alt|$headings//@aria-label))) = 0\">Empty ranked heading detected.</report>\n \t\t\t\n \t\t\t<report test=\"@aria-label and (normalize-space($headings) = normalize-space(@aria-label))\">The value of the \"aria-label\" attribute must not be the same as the content of the heading.</report>\n \t\t</rule>\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.sch b/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.sch\nindex e9856ee..a32720a 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.sch\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.sch\n@@ -47,7 +47,7 @@\n     <pattern id=\"link-labels\">\n         <rule context=\"html:nav[@epub:type]//html:ol//html:a\">\n             <assert\n-                test=\"string-length(normalize-space(concat(.,./html:img/@alt,.//@aria-label))) > 0\"\n+                test=\"string-length(normalize-space(string-join(.|./html:img/@alt|.//@aria-label))) > 0\"\n                 >Anchors within nav elements must contain text</assert>\n         </rule>\n     </pattern>\n@@ -55,7 +55,7 @@\n     <pattern id=\"span-labels\">\n         <rule context=\"html:nav[@epub:type]//html:ol//html:span\">\n             <assert\n-                test=\"string-length(normalize-space(concat(.,./html:img/@alt,.//@aria-label))) > 0\"\n+                test=\"string-length(normalize-space(string-join(.|./html:img/@alt|.//@aria-label))) > 0\"\n                 >Spans within nav elements must contain text</assert>\n         </rule>\n     </pattern>\n@@ -72,7 +72,7 @@\n     <pattern id=\"heading-content\">\n         <rule context=\"html:h1|html:h2|html:h3|html:h4|html:h5|html:h6\">\n             <assert\n-                test=\"string-length(normalize-space(concat(.,./html:img/@alt,.//@aria-label))) > 0\"\n+                test=\"string-length(normalize-space(string-join(.|./html:img/@alt|.//@aria-label))) > 0\"\n                 >Heading elements must contain text</assert>\n         </rule>\n     </pattern>\ndiff --git a/src/test/resources/epub3/07-navigation-document/files/content-model-a-multiple-images-valid.xhtml b/src/test/resources/epub3/07-navigation-document/files/content-model-a-multiple-images-valid.xhtml\nnew file mode 100644\nindex 0000000..71bd0b1\n--- /dev/null\n+++ b/src/test/resources/epub3/07-navigation-document/files/content-model-a-multiple-images-valid.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+    <head>\n+        <meta charset=\"utf-8\"/>\n+            <title>Minimal Nav</title>\n+    </head>\n+    <body>\n+        <nav epub:type=\"toc\">\n+            <ol>\n+                <li><a href=\"content_001.xhtml\"><img src=\"decorative.jpg\" alt=\"\" /><img src=\"textual.jpg\" alt=\"some text\" /></a></li>\n+            </ol>\n+        </nav>\n+    </body>\n+</html>\ndiff --git a/src/test/resources/epub3/07-navigation-document/files/content-model-li-label-multiple-images-valid.xhtml b/src/test/resources/epub3/07-navigation-document/files/content-model-li-label-multiple-images-valid.xhtml\nnew file mode 100644\nindex 0000000..c8aef16\n--- /dev/null\n+++ b/src/test/resources/epub3/07-navigation-document/files/content-model-li-label-multiple-images-valid.xhtml\n@@ -0,0 +1,20 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\"\n+    lang=\"en\">\n+    <head>\n+        <meta charset=\"utf-8\" />\n+            <title>Minimal Nav</title>\n+    </head>\n+    <body>\n+        <nav epub:type=\"toc\">\n+            <ol>\n+                <li>\n+                    <span><img src=\"decorative.jpg\" alt=\"\" /><img src=\"textual.jpg\" alt=\"some text\" /></span>\n+                    <ol>\n+                        <li><a href=\"content_001.xhtml\">content 001</a></li>\n+                    </ol>\n+                </li>\n+            </ol>\n+        </nav>\n+    </body>\n+</html>\n", "test_patch": "diff --git a/src/test/resources/epub3/07-navigation-document/navigation-document.feature b/src/test/resources/epub3/07-navigation-document/navigation-document.feature\nindex aadd659..8dca377 100644\n--- a/src/test/resources/epub3/07-navigation-document/navigation-document.feature\n+++ b/src/test/resources/epub3/07-navigation-document/navigation-document.feature\n@@ -63,6 +63,11 @@ Feature: EPUB 3 \u2014 Navigation Document\n     Then error RSC-005 is reported\n     And the message contains 'Spans within nav elements must contain text'\n     And no other errors or warnings are reported\n+    \n+  Scenario: Allow multiple images in a list item label\n+  \tGiven EPUBCheck configured to check a navigation document\n+    When checking document 'content-model-li-label-multiple-images-valid.xhtml'\n+    Then no errors or warnings are reported\n \n   @spec @xref:sec-nav-def-model\n   Scenario: Report a leaf list item with no link (just a span label)\n@@ -79,6 +84,11 @@ Feature: EPUB 3 \u2014 Navigation Document\n     Then error RSC-005 is reported\n     And the message contains 'Anchors within nav elements must contain text'\n     And no other errors or warnings are reported\n+    \n+  Scenario: Allow multiple images in a nav hyperlink\n+  \tGiven EPUBCheck configured to check a navigation document\n+    When checking document 'content-model-a-multiple-images-valid.xhtml'\n+    Then no errors or warnings are reported\n \n   @spec @xref:sec-nav-def-model\n   Scenario: Report a nav hyperlink without content (but an empty nested span)\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T20:14:22.646265Z", "commit_hash": "0759a82ae40706269aa3c88e9a175bf8ce7a2f54", "commit_message": "feat: use \"audio/ogg; codecs=opus\" as the MIME type for OPUS audio\n\nFix #1473\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\nindex 9fc2495..0338efa 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n@@ -565,7 +565,7 @@ public class OPFChecker30 extends OPFChecker\n \n   public static boolean isBlessedAudioType(String type)\n   {\n-    return type.equals(\"audio/mpeg\") || type.equals(\"audio/mp4\") || type.equals(\"audio/opus\");\n+    return type.equals(\"audio/mpeg\") || type.equals(\"audio/mp4\") || type.matches(\"audio/ogg\\\\s*;\\\\s*codecs=opus\");\n   }\n \n   public static boolean isVideoType(String type)\ndiff --git a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\nindex 290a042..7e48144 100644\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n@@ -644,6 +644,14 @@ public class OPSHandler30 extends OPSHandler\n       // remove any params from the given MIME type string\n       mimetype = MIMEType.removeParams(mimetype);\n \n+      // hack: remove the codecs parameter in the resource type for OPUS audio\n+      // so that the equality check works\n+      // TODO remove this when we implement proper MIME type parsing\n+      if (resourceMimetype != null && resourceMimetype.matches(\"audio/ogg\\\\s*;\\\\s*codecs=opus\"))\n+      {\n+        resourceMimetype = \"audio/ogg\";\n+      }\n+\n       // report any MIME type mismatch as a warning\n       if (resourceMimetype != null && !resourceMimetype.equals(mimetype))\n       {\n", "test_patch": "diff --git a/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/content_001.xhtml\nindex b25c450..a48e30a 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/content_001.xhtml\n@@ -7,6 +7,8 @@\n \t<body>\n \t\t<h1>Loomings</h1>\n \t\t<p>Call me Ishmael.</p>\n-\t\t<audio src=\"audio.opus\" />\n+\t\t<audio>\n+\t\t\t<source src=\"audio.opus\" type=\"audio/ogg; codecs=opus\"/>\n+\t\t</audio>\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/package.opf\nindex 07049c3..2d677f7 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/03-resources/files/resources-cmt-audio-opus-valid/EPUB/package.opf\n@@ -9,7 +9,7 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"audio\" href=\"audio.opus\" media-type=\"audio/opus\"/>\n+  <item id=\"audio\" href=\"audio.opus\" media-type=\"audio/ogg ;  codecs=opus\"/>\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T20:29:30.685535Z", "commit_hash": "f59743a307603cbb8c531bd62f1c6c33cd7c9d02", "commit_message": "fix: allow unknown alternate style sheet class names\n\nA class name found on a `link` element representing a style sheet was\nreported as an error when it was not one of the known keyword defined\nin [EPUB Alternate Style Tags](https://idpf.org/epub/altss-tags/).\n\nThis commit fixes that by allowing any name in the class attribute.\n\nThis commit also downgrades `CSS-005` to a usage; it is reported when\ntwo mutually-exclusive class names are used on the same link element.\nEPUB Alternate Style Tags defines these as mutual exclusive names, but\nit is mostly unimplemeneted and this was never strictly forbidden.\n\nFix #989\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 89c5344..70c47db 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -71,7 +71,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.CSS_002, Severity.ERROR);\n     severities.put(MessageId.CSS_003, Severity.WARNING);\n     severities.put(MessageId.CSS_004, Severity.ERROR);\n-    severities.put(MessageId.CSS_005, Severity.ERROR);\n+    severities.put(MessageId.CSS_005, Severity.USAGE);\n     severities.put(MessageId.CSS_006, Severity.USAGE);\n     severities.put(MessageId.CSS_007, Severity.INFO);\n     severities.put(MessageId.CSS_008, Severity.ERROR);\ndiff --git a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\nindex cb558be..290a042 100644\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n@@ -46,6 +46,7 @@ import com.adobe.epubcheck.vocab.Property;\n import com.adobe.epubcheck.vocab.StagingEdupubVocab;\n import com.adobe.epubcheck.vocab.StructureVocab;\n import com.adobe.epubcheck.vocab.StructureVocab.EPUB_TYPES;\n+import com.adobe.epubcheck.vocab.UncheckedVocab;\n import com.adobe.epubcheck.vocab.Vocab;\n import com.adobe.epubcheck.vocab.VocabUtil;\n import com.adobe.epubcheck.xml.model.XMLAttribute;\n@@ -69,7 +70,7 @@ public class OPSHandler30 extends OPSHandler\n       MagazineNavigationVocab.PREFIX, MagazineNavigationVocab.VOCAB, ForeignVocabs.PRISM_PREFIX,\n       ForeignVocabs.PRISM_VOCAB);\n   private static Map<String, Vocab> ALTCSS_VOCABS = ImmutableMap.<String, Vocab> of(\"\",\n-      AltStylesheetVocab.VOCAB);\n+      AggregateVocab.of(AltStylesheetVocab.VOCAB, new UncheckedVocab(\"\", \"\")));\n   private static Map<String, Vocab> KNOWN_VOCAB_URIS = ImmutableMap.of(MagazineNavigationVocab.URI,\n       MagazineNavigationVocab.VOCAB, ForeignVocabs.PRISM_URI, ForeignVocabs.PRISM_VOCAB);\n   private static Set<String> DEFAULT_VOCAB_URIS = ImmutableSet.of(StructureVocab.URI);\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 0db941e..ea63d66 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -27,7 +27,7 @@ CSS_001=The \"%1$s\" property must not be included in an EPUB Style Sheet.\n CSS_002=Empty or NULL reference found.\n CSS_003=CSS document is encoded in UTF-16. It should be encoded in UTF-8 instead.\n CSS_004=CSS documents must be encoded in UTF-8, detected %1%s;\n-CSS_005=Conflicting alternate style attributes found: %1$s.\n+CSS_005=Conflicting alternate style tags found: %1$s.\n CSS_006=CSS selector specifies fixed position.\n CSS_007=Font-face reference \"%1$s\" refers to non-standard font type \"%2$s\".\n CSS_008=An error occurred while parsing the CSS: %1$s.\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-conflict-usage.xhtml b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-conflict-usage.xhtml\nnew file mode 100644\nindex 0000000..56d5749\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-conflict-usage.xhtml\n@@ -0,0 +1,9 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>alt style tag css declaration</title>\n+\t\t<link rel=\"stylesheet\" href=\"horizontal.css\" class=\"day night\" />\n+\t</head>\n+\t<body></body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-known-valid.xhtml b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-known-valid.xhtml\nnew file mode 100644\nindex 0000000..a0ca307\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-known-valid.xhtml\n@@ -0,0 +1,9 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>alt style tag css declaration</title>\n+\t\t<link rel=\"stylesheet\" href=\"horizontal.css\" class=\"horizontal\" />\n+\t</head>\n+\t<body></body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-unknown-valid.xhtml b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-unknown-valid.xhtml\nnew file mode 100644\nindex 0000000..212d02b\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-unknown-valid.xhtml\n@@ -0,0 +1,9 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>unknown alt style tag css declaration</title>\n+\t\t<link rel=\"stylesheet\" href=\"horizontal.css\" class=\"unknown\" />\n+\t</head>\n+\t<body> </body>\n+</html>\n", "test_patch": "diff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex e9456c7..e91e52b 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -367,14 +367,23 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n   ####  Links\n \n   Scenario: Verify a `link` element with a known alt style tag\n-    When checking document 'link-alt-style-tags-valid.xhtml'\n+    Given the reporting level is set to usage\n+    When checking document 'link-alt-style-tags-known-valid.xhtml'\n+    Then no usages are reported\n+    And no errors or warnings are reported\n+\n+  Scenario: Report a `link` element with an unknown alt style tag\n+    Given the reporting level is set to usage\n+    When checking document 'link-alt-style-tags-unknown-valid.xhtml'\n     Then no errors or warnings are reported\n+    And no usages are reported\n \n   Scenario: Report a `link` element with an unknown alt style tag\n-    When checking document 'link-alt-style-tags-error.xhtml'\n-    Then error OPF-027 is reported\n-    And error CSS-005 is reported\n-    And no other errors or warnings are reported\n+    Given the reporting level is set to usage\n+    When checking document 'link-alt-style-tags-conflict-usage.xhtml'\n+    Then no errors or warnings are reported\n+    And usage CSS-005 is reported\n+    But no other usages are reported\n \n   Scenario: Verify `link` elements used to declare alternative stylesheets\n     When checking document 'link-rel-stylesheet-alternate-valid.xhtml'\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-error.xhtml b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-error.xhtml\ndeleted file mode 100644\nindex a96443d..0000000\n--- a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-error.xhtml\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>invalid alt style tag css declaration</title>\n-\t\t<link rel=\"stylesheet\" href=\"horizontal.css\" class=\"horizontal invalid vertical\" />\n-\t</head>\n-\t<body> </body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-valid.xhtml b/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-valid.xhtml\ndeleted file mode 100644\nindex a0ca307..0000000\n--- a/src/test/resources/epub3/06-content-document/files/link-alt-style-tags-valid.xhtml\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>alt style tag css declaration</title>\n-\t\t<link rel=\"stylesheet\" href=\"horizontal.css\" class=\"horizontal\" />\n-\t</head>\n-\t<body></body>\n-</html>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T20:35:40.121581Z", "commit_hash": "2c76420bda04422367474ec16aa64bcd94892cfa", "commit_message": "feat: check that the manifest is not self-referencing\n\nThis commit adds a new check, reported as `OPF-099` (error), to verify\nthat the package document `manifest` does not include an `item` element\nthat refers to the package document itself.\n\nThis statement was apparently not checked by EPUBCheck previously. Worse,\nthe code was entering an infinite loop, as the package document checker\nwas creating a new checker for itself, recursively.\n\nFix #1453\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 3c009e1..aa89679 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -293,6 +293,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.OPF_096b, Severity.USAGE);\n     severities.put(MessageId.OPF_097, Severity.USAGE);\n     severities.put(MessageId.OPF_098, Severity.ERROR);\n+    severities.put(MessageId.OPF_099, Severity.ERROR);\n \n     // PKG\n     severities.put(MessageId.PKG_001, Severity.WARNING);\ndiff --git a/src/main/java/com/adobe/epubcheck/messages/MessageId.java b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\nindex 1082343..c2b2ab7 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n@@ -287,6 +287,7 @@ public enum MessageId implements Comparable<MessageId>\n   OPF_096b(\"OPF-096b\"),\n   OPF_097(\"OPF-097\"),\n   OPF_098(\"OPF-098\"),\n+  OPF_099(\"OPF-099\"),\n \n   // Messages relating to the entire package\n   PKG_001(\"PKG-001\"),\ndiff --git a/src/main/java/com/adobe/epubcheck/opf/OPFChecker.java b/src/main/java/com/adobe/epubcheck/opf/OPFChecker.java\nindex 9f810c9..caef644 100755\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFChecker.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFChecker.java\n@@ -35,6 +35,7 @@ import org.w3c.epubcheck.core.AbstractChecker;\n import org.w3c.epubcheck.core.Checker;\n import org.w3c.epubcheck.core.CheckerFactory;\n import org.w3c.epubcheck.core.references.ResourceReferencesChecker;\n+import org.w3c.epubcheck.util.url.URLUtils;\n \n import com.adobe.epubcheck.api.EPUBLocation;\n import com.adobe.epubcheck.api.EPUBProfile;\n@@ -215,6 +216,11 @@ public class OPFChecker extends AbstractChecker\n         // FIXME 2022 check duplicates at build time (in OPFHandler)\n         report.message(MessageId.OPF_074, item.getLocation(), item.getPath());\n       }\n+      // check that the manifest does not include the package document itself\n+      else if (item.getURL().equals(context.url))\n+      {\n+        report.message(MessageId.OPF_099, item.getLocation());\n+      }\n       else\n       {\n         checkItem(item, opfHandler);\n@@ -361,6 +367,12 @@ public class OPFChecker extends AbstractChecker\n     {\n       return;\n     }\n+    // Abort if the item is this package document\n+    // (this is disallowed, and reported elsewhere)\n+    if (URLUtils.docURL(item.getURL()).equals(context.url))\n+    {\n+      return;\n+    }\n     // Create a new validation context for the OPF item\n     // FIXME 2022 set context OPFItem here\n     // (instead of from XRefChecker in the builder code)\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex ece3d87..f942fda 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -215,6 +215,7 @@ OPF_096=Non-linear content must be reachable, but found no hyperlink to \"%1$s\".\n OPF_096b=No hyperlink was found to non-linear document \"%1$s\", please check that it can be reached from scripted content.\n OPF_097=Resource \"%1$s\" is listed in the manifest, but no reference to it was found in content documents.\n OPF_098=The \"href\" attribute must reference resources, not elements in the package document, but found URL \"%1$s\".\n+OPF_099=The manifest must not list the package document.\n \n #Package\n PKG_001=Validating the EPUB against version %1$s but detected version %2$s.\ndiff --git a/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error.opf b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error.opf\nnew file mode 100644\nindex 0000000..399eea7\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+  <metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+    <dc:language>en</dc:language>\n+    <dc:identifier id=\"q\">NOID</dc:identifier>\n+    <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  </metadata>\n+  <manifest>\n+    <item id=\"self\" href=\"./manifest-self-referencing-error.opf\" media-type=\"application/oebps-package+xml\"/>\n+    <item id=\"content_001\" href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    <item id=\"nav\" href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"content_001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..24fcbf7\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+  <metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+    <dc:language>en</dc:language>\n+    <dc:identifier id=\"q\">NOID</dc:identifier>\n+    <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  </metadata>\n+  <manifest>\n+    <item id=\"self\" href=\"./package.opf\" media-type=\"application/oebps-package+xml\"/>\n+    <item id=\"content_001\" href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    <item id=\"nav\" href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"content_001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/mimetype b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/manifest-self-referencing-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/05-package-document/package-document.feature b/src/test/resources/epub3/05-package-document/package-document.feature\nindex 46810f1..81874c9 100644\n--- a/src/test/resources/epub3/05-package-document/package-document.feature\n+++ b/src/test/resources/epub3/05-package-document/package-document.feature\n@@ -422,6 +422,18 @@ Feature: EPUB 3 \u2014 Package document\n     Then error RSC-008 is reported\n     And no other errors or warnings are reported\n \n+  @spec @xref:sec-manifest-elem\n+  Scenario: Report a self-referencing manifest (full publication check)\n+    When checking EPUB 'manifest-self-referencing-error'\n+    Then error OPF-099 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-manifest-elem\n+  Scenario: Report a self-referencing manifest (single file check)\n+    When checking file 'manifest-self-referencing-error.opf'\n+    Then error OPF-099 is reported\n+    And no other errors or warnings are reported\n+\n   Scenario: Report (usage) a container resource that is not listed in the manifest\n     Given the reporting level is set to usage  \n     When checking EPUB 'manifest-not-listing-container-resource-usage'\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T20:42:55.146747Z", "commit_hash": "54b5f1ff63d754ebdfc348c52bc065e939b32768", "commit_message": "fix: allow links to resources embedded in content documents\n\nThis commit checks that the linked resource is not in the spine before\nreporting `OPF-067` (\"The resource \"\u2026\" must not be listed both as a\n\"link\" element in the package metadata and as a manifest item.\").\n\nEffectively, this allows package links to publication resources in the\ntwo cases identified in the EPUB 3.3 specification:\n\n> Resources referenced from the link element are publication resources\n> only when they are:\n> - referenced from the spine; or\n> - included or embedded in an EPUB content document\n\nFix #1454\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\nindex 77e104c..9fc2495 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n@@ -412,10 +412,10 @@ public class OPFChecker30 extends OPFChecker\n     LinkedResources links = ((OPFHandler30) opfHandler).getLinkedResources();\n     for (LinkedResource link : links.asList())\n     {\n-      if (opfHandler.getItemByURL(link.getDocumentURL()).isPresent())\n+      Optional<OPFItem> item = opfHandler.getItemByURL(link.getDocumentURL());\n+      if (item.isPresent() && !item.get().isInSpine())\n       {\n-        // FIXME 2022 check how to report the URL\n-        report.message(MessageId.OPF_067, EPUBLocation.of(context), link.getDocumentURL().path());\n+        report.message(MessageId.OPF_067, EPUBLocation.of(context), item.get().getPath());\n       }\n     }\n   }\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex b1493bf..ece3d87 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -214,7 +214,7 @@ OPF_095=The \"media-type\" attribute of \"voicing\" links must be an audio MIME type\n OPF_096=Non-linear content must be reachable, but found no hyperlink to \"%1$s\".\n OPF_096b=No hyperlink was found to non-linear document \"%1$s\", please check that it can be reached from scripted content.\n OPF_097=Resource \"%1$s\" is listed in the manifest, but no reference to it was found in content documents.\n-OPF_098=The \"href\" attribute must not reference resources via elements in the package document itself, but found URL \"%1$s\".\n+OPF_098=The \"href\" attribute must reference resources, not elements in the package document, but found URL \"%1$s\".\n \n #Package\n PKG_001=Validating the EPUB against version %1$s but detected version %2$s.\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..3304c26\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,18 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\"\n+\tlang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t\t<script id=\"meta-json\" type=\"application/ld+json\">\n+\t\t\t{\n+        \"@context\" : \"http://schema.org\",\n+        \"name\" : \"test\"\n+      }\n+    </script>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..955cc04\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+  <metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+    <dc:language>en</dc:language>\n+    <dc:identifier id=\"q\">NOID</dc:identifier>\n+    <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+    <link rel=\"record\" href=\"content_001.xhtml#meta-json\" media-type=\"application/xhtml+xml\" hreflang=\"en\"\n+    />\n+  </metadata>\n+  <manifest>\n+    <item id=\"content_001\" href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    <item id=\"nav\" href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"content_001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/mimetype b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-embedded-resource-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-spine-item-valid.opf b/src/test/resources/epub3/05-package-document/files/link-to-spine-item-valid.opf\nnew file mode 100644\nindex 0000000..bbd9f69\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-spine-item-valid.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" unique-identifier=\"uid\"\n+    xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n+    prefix=\"example: https:example.org\">\n+    <metadata>\n+        <dc:title>Title</dc:title>\n+        <dc:language>en</dc:language>\n+        <dc:identifier id=\"uid\">NOID</dc:identifier>\n+        <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n+        <link rel=\"example:property\" href=\"contents.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    </metadata>\n+    <manifest>\n+        <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\n+    </manifest>\n+    <spine>\n+        <itemref idref=\"t001\"/>\n+    </spine>\n+</package>\n", "test_patch": "diff --git a/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf b/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf\ndeleted file mode 100644\nindex 0430ba6..0000000\n--- a/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf\n+++ /dev/null\n@@ -1,19 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" unique-identifier=\"uid\"\n-    xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n-    prefix=\"example: https:example.org\">\n-    <metadata>\n-        <dc:title>Title</dc:title>\n-        <dc:language>en</dc:language>\n-        <dc:identifier id=\"uid\">NOID</dc:identifier>\n-        <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n-        <!--Linked resources MUST NOT be listed in the manifest.-->\n-        <link rel=\"example:property\" href=\"contents.xhtml#ch1\" media-type=\"application/xhtml+xml\"/>\n-    </metadata>\n-    <manifest>\n-        <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\n-    </manifest>\n-    <spine>\n-        <itemref idref=\"t001\"/>\n-    </spine>\n-</package>\ndiff --git a/src/test/resources/epub3/05-package-document/package-document.feature b/src/test/resources/epub3/05-package-document/package-document.feature\nindex 4b3b722..46810f1 100644\n--- a/src/test/resources/epub3/05-package-document/package-document.feature\n+++ b/src/test/resources/epub3/05-package-document/package-document.feature\n@@ -382,6 +382,16 @@ Feature: EPUB 3 \u2014 Package document\n     When checking file 'link-hreflang-not-well-formed-error.opf'\n     Then error OPF-092 is reported\n     And no other errors or warnings are reported\n+\n+  @spec @xref:sec-link-elem\n+  Scenario: Allow a link to a resource referenced from the spine\n+    When checking file 'link-to-spine-item-valid.opf'\n+    Then no errors or warnings are reported\n+\n+  @spec @xref:sec-link-elem\n+  Scenario: Allow a link to a resource embedded in a content document\n+    When checking EPUB 'link-to-embedded-resource-valid'\n+    Then no errors or warnings are reported\n   \n   \n   ### 5.6 Manifest section\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T20:49:14.579386Z", "commit_hash": "f20993e8e80289275ed915b884fd09f1dcb85b02", "commit_message": "feat: check that non-linear content is reachable\n\nEPUB 3.3 says:\n> EPUB creators MUST provide a means of accessing all non-linear content\n> (e.g., hyperlinks in the content or from the EPUB navigation document).\n\nThis commit adds a check for the above statement.\n- new error `OPF-096` is reported when no hyperlink was found to\n  non-linear content in an EPUB with no script\n- new usage `OPF-096b` is reported when no hyperlink was found to\n  non-linear content in a scripted EPUB (a link may be added via\n  scripting, so we cannot report this as an error)\n\nFix #1451\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 7925789..a007f65 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -289,6 +289,8 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.OPF_093, Severity.ERROR);\n     severities.put(MessageId.OPF_094, Severity.ERROR);\n     severities.put(MessageId.OPF_095, Severity.ERROR);\n+    severities.put(MessageId.OPF_096, Severity.ERROR);\n+    severities.put(MessageId.OPF_096b, Severity.USAGE);\n \n     // PKG\n     severities.put(MessageId.PKG_001, Severity.WARNING);\ndiff --git a/src/main/java/com/adobe/epubcheck/messages/MessageId.java b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\nindex b74f131..c0a8358 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n@@ -283,6 +283,8 @@ public enum MessageId implements Comparable<MessageId>\n   OPF_093(\"OPF-093\"),\n   OPF_094(\"OPF-094\"),\n   OPF_095(\"OPF-095\"),\n+  OPF_096(\"OPF-096\"),\n+  OPF_096b(\"OPF-096b\"),\n \n   // Messages relating to the entire package\n   PKG_001(\"PKG-001\"),\ndiff --git a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\nindex 38427d3..0119939 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n@@ -24,6 +24,7 @@ package com.adobe.epubcheck.opf;\n \n import java.util.Set;\n \n+import org.w3c.epubcheck.core.references.Reference;\n import org.w3c.epubcheck.util.url.URLFragment;\n \n import com.adobe.epubcheck.api.EPUBLocation;\n@@ -183,6 +184,26 @@ public class OPFChecker30 extends OPFChecker\n         }\n       }\n     }\n+\n+    // check that non-linear content documents are reachable\n+    if (item.isInSpine() && !item.isLinear() && context.referenceRegistry.isPresent()\n+    // search the reference registry for any hyperlink pointing to this item\n+        && !context.referenceRegistry.get().asList().stream()\n+            .anyMatch(ref -> ref.type == Reference.Type.HYPERLINK\n+                && ref.targetResource.equals(item.getURL())))\n+    {\n+      // if content is scripted, references can be added by scripting\n+      // se we only report a usage\n+      if (context.featureReport.hasFeature(FeatureEnum.HAS_SCRIPTS))\n+      {\n+        report.message(MessageId.OPF_096b, item.getLocation(), item.getPath());\n+      }\n+      // else, report an error if no hyperlink were found\n+      else\n+      {\n+        report.message(MessageId.OPF_096, item.getLocation(), item.getPath());\n+      }\n+    }\n   }\n \n   @Override\n@@ -194,14 +215,15 @@ public class OPFChecker30 extends OPFChecker\n       return;\n     }\n \n-    String mimeType = item.getMimeType();\n-\n+    // check properties\n     if (item.getProperties()\n         .contains(PackageVocabs.ITEM_VOCAB.get(PackageVocabs.ITEM_PROPERTIES.DATA_NAV)))\n     {\n       report.message(MessageId.OPF_077, item.getLocation());\n     }\n \n+    // check that spine items have content document fallback\n+    String mimeType = item.getMimeType();\n     if (!isBlessedItemType(mimeType, version))\n     {\n       if (!item.hasFallback())\n@@ -213,7 +235,6 @@ public class OPFChecker30 extends OPFChecker\n         report.message(MessageId.OPF_044, item.getLocation(), mimeType);\n       }\n     }\n-\n   }\n \n   private void checkCollections()\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 27fe95b..5d91925 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -210,7 +210,9 @@ OPF_091=The item href URL must not have a fragment identifier.\n OPF_092=Language tag \"%1$s\" is not well-formed: %2$s\n OPF_093=The \"media-type\" attribute is required for linked resources located in the EPUB container\n OPF_094=The \"media-type\" attribute is required for \"%1$s\" links.\n-OPF_095=The \"media-type\" attribute of \"voicing\" links must be an audio MIME type, but found \"%1$s\". \n+OPF_095=The \"media-type\" attribute of \"voicing\" links must be an audio MIME type, but found \"%1$s\".\n+OPF_096=Non-linear content must be reachable, but found no hyperlink to \"%1$s\".\n+OPF_096b=No hyperlink was found to non-linear document \"%1$s\", please check that it can be reached from scripted content.  \n \n #Package\n PKG_001=Validating the EPUB against version %1$s but detected version %2$s.\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-empty-error.opf b/src/test/resources/epub3/05-package-document/files/spine-empty-error.opf\nnew file mode 100644\nindex 0000000..9d41c79\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-empty-error.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+<!--  <itemref idref=\"content_001\" />-->\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-missing-error.opf b/src/test/resources/epub3/05-package-document/files/spine-missing-error.opf\nnew file mode 100644\nindex 0000000..3cda7bd\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-missing-error.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<!--<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>-->\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-no-linear-itemref-error.opf b/src/test/resources/epub3/05-package-document/files/spine-no-linear-itemref-error.opf\nnew file mode 100644\nindex 0000000..7b7beec\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-no-linear-itemref-error.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" linear=\" no \"/>\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/content_002.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/content_002.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/content_002.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..18689b9\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+  <itemref idref=\"content_002\" linear=\"no\"/>\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/mimetype b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-not-reachable-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..563cd4a\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t\t<a href=\"content_002.xhtml\">link</a>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/content_002.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/content_002.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/content_002.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..18689b9\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+  <itemref idref=\"content_002\" linear=\"no\"/>\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/mimetype b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-hyperlink-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/content_002.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/content_002.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/content_002.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..efd4ff1\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/nav.xhtml\n@@ -0,0 +1,15 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t\t<li><a href=\"content_002.xhtml\">content 002</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..18689b9\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+  <itemref idref=\"content_002\" linear=\"no\"/>\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/mimetype b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-nav-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..b3e7a7d\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,19 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t\t<script>\n+\t\t\twindow.addEventListener(\"load\", function(){\n+\t\t\t\tvar link = document.createElement('a');\n+\t\t\t\tlink.setAttribute('href', 'content_002.xhtml');\n+\t\t\t\tlink.innerHTML = \"link\";\n+\t\t\t\tdocument.body.appendChild(link);\n+\t\t\t});\n+\t\t</script>\n+\t</head>\n+\t<body id=\"body\">\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/content_002.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/content_002.xhtml\nnew file mode 100644\nindex 0000000..43a520e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/content_002.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..fa234b9\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"scripted\"/>\n+  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+  <itemref idref=\"content_002\" linear=\"no\"/>\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/mimetype b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-nonlinear-reachable-via-script-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..4931aa3\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/content_001.xhtml\n@@ -0,0 +1,10 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<p><a href=\"content_002.xhtml\">not in spine link</a></p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/content_002.xhtml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/content_002.xhtml\nnew file mode 100644\nindex 0000000..ea29a16\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/content_002.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..556ca5f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..2ca12ef\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/mimetype b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-hyperlink-target-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..ea29a16\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/content_002.xhtml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/content_002.xhtml\nnew file mode 100644\nindex 0000000..ea29a16\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/content_002.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..efd4ff1\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/nav.xhtml\n@@ -0,0 +1,15 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t\t<li><a href=\"content_002.xhtml\">content 002</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..556ca5f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..2ca12ef\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/mimetype b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/spine-not-listing-navigation-document-target-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub-edupub/edupub-publication.feature b/src/test/resources/epub-edupub/edupub-publication.feature\nindex b4e70d7..cb1d341 100644\n--- a/src/test/resources/epub-edupub/edupub-publication.feature\n+++ b/src/test/resources/epub-edupub/edupub-publication.feature\n@@ -51,7 +51,7 @@ Feature: EPUB for Education \u25b8 Full Publication Checks\n \n   ##  4.2 Sectioning\n \n-  Scenario: Verify an non-linear content does not have to follow the sectioning rules\n+  Scenario: Verify that non-linear content does not have to follow the sectioning rules\n     When checking EPUB 'edupub-non-linear-valid'\n     Then no errors or warnings are reported\n \ndiff --git a/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/nav.xhtml b/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/nav.xhtml\nindex 240745e..755db90 100644\n--- a/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/nav.xhtml\n+++ b/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/nav.xhtml\n@@ -8,6 +8,7 @@\n \t\t<nav epub:type=\"toc\">\n \t\t\t<ol>\n \t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t\t<li><a href=\"nonlinear.xhtml\">non-linear</a></li>\n \t\t\t</ol>\n \t\t</nav>\n \t</body>\ndiff --git a/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/package.opf b/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/package.opf\nindex bb13ce5..1029ce8 100644\n--- a/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/package.opf\n+++ b/src/test/resources/epub-edupub/files/epub/edupub-non-linear-valid/EPUB/package.opf\n@@ -11,10 +11,10 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"non\" href=\"nonlinear.xhtml\" media-type=\"application/xhtml+xml\" />\n+  <item id=\"nonlinear\" href=\"nonlinear.xhtml\" media-type=\"application/xhtml+xml\" />\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\n-  <itemref idref=\"non\" linear=\"no\" />\n+  <itemref idref=\"nonlinear\" linear=\"no\" />\n </spine>\n </package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub-region-nav/files/epub/data-nav-in-spine-warning/EPUB/nav.xhtml b/src/test/resources/epub-region-nav/files/epub/data-nav-in-spine-warning/EPUB/nav.xhtml\nindex 240745e..51e90db 100644\n--- a/src/test/resources/epub-region-nav/files/epub/data-nav-in-spine-warning/EPUB/nav.xhtml\n+++ b/src/test/resources/epub-region-nav/files/epub/data-nav-in-spine-warning/EPUB/nav.xhtml\n@@ -8,6 +8,7 @@\n \t\t<nav epub:type=\"toc\">\n \t\t\t<ol>\n \t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t\t<li><a href=\"data-nav.xhtml\">data nav</a></li>\n \t\t\t</ol>\n \t\t</nav>\n \t</body>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/content_001.xhtml\ndeleted file mode 100644\nindex ea29a16..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/content_001.xhtml\n+++ /dev/null\n@@ -1,11 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal EPUB</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Loomings</h1>\n-\t\t<p>Call me Ishmael.</p>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/nav.xhtml\ndeleted file mode 100644\nindex 240745e..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/nav.xhtml\n+++ /dev/null\n@@ -1,14 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal Nav</title>\n-\t</head>\n-\t<body>\n-\t\t<nav epub:type=\"toc\">\n-\t\t\t<ol>\n-\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n-\t\t\t</ol>\n-\t\t</nav>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/package.opf\ndeleted file mode 100644\nindex 3cda7bd..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/EPUB/package.opf\n+++ /dev/null\n@@ -1,16 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n-<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n-  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n-  <dc:language>en</dc:language>\n-  <dc:identifier id=\"q\">NOID</dc:identifier>\n-  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n-</metadata>\n-<manifest>\n-  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n-  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-</manifest>\n-<!--<spine>\n-  <itemref idref=\"content_001\" />\n-</spine>-->\n-</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/META-INF/container.xml\ndeleted file mode 100644\nindex 3187821..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/META-INF/container.xml\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n-<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n-\t<rootfiles>\n-\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n-\t</rootfiles>\n-</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/mimetype b/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/mimetype\ndeleted file mode 100644\nindex 57ef03f..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-spine-missing-error/mimetype\n+++ /dev/null\n@@ -1,1 +0,0 @@\n-application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/package-document.feature b/src/test/resources/epub3/05-package-document/package-document.feature\nindex b03c3b1..909a1b3 100644\n--- a/src/test/resources/epub3/05-package-document/package-document.feature\n+++ b/src/test/resources/epub3/05-package-document/package-document.feature\n@@ -680,10 +680,28 @@ Feature: EPUB 3 \u2014 Package document\n \n   @spec @xref:sec-spine-elem\n   Scenario: Report a missing spine\n-    When checking EPUB 'package-spine-missing-error'\n-    Then the following errors are reported\n-      | RSC-005 | missing required element \"spine\"                 |\n-      | RSC-011 | reference to a resource that is not a spine item | # in the Nav Doc\n+    When checking file 'spine-missing-error.opf'\n+    Then the error RSC-005 is reported\n+    And the message contains 'missing required element \"spine\"'\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-spine-elem\n+  Scenario: Report an empty spine\n+    When checking file 'spine-empty-error.opf'\n+    Then the error RSC-005 is reported\n+    And the message contains 'missing required element \"itemref\"'\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-spine-elem\n+  Scenario: Report when a document hyperlinked from a content document is not in the spine\n+    When checking EPUB 'spine-not-listing-hyperlink-target-error'\n+    Then error RSC-011 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-spine-elem\n+  Scenario: Report when a document hyperlinked from the navigation document is not in the spine\n+    When checking EPUB 'spine-not-listing-navigation-document-target-error'\n+    Then error RSC-011 is reported\n     And no other errors or warnings are reported\n \n \n@@ -708,6 +726,35 @@ Feature: EPUB 3 \u2014 Package document\n     And the message contains \"Itemref refers to the same manifest entry as a previous itemref\"\n     And no other errors or warnings are reported\n \n+  @spec @xref:sec-itemref-elem\n+  Scenario: Report a spine that does not contain at least one linear itemref\n+    When checking file 'spine-no-linear-itemref-error.opf'\n+    Then the error OPF-033 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-itemref-elem\n+  Scenario: Verify an EPUB where non-linear content is reachable via the navigation document\n+    When checking EPUB 'spine-nonlinear-reachable-via-nav-valid'\n+    Then no errors or warnings are reported\n+\n+  @spec @xref:sec-itemref-elem\n+  Scenario: Verify an EPUB where non-linear content is reachable via a hyperlink\n+    When checking EPUB 'spine-nonlinear-reachable-via-hyperlink-valid'\n+    Then no errors or warnings are reported\n+\n+  @spec @xref:sec-itemref-elem\n+  Scenario: Report an EPUB where non-linear content is unreachable\n+    Given the reporting level is set to usage\n+    When checking EPUB 'spine-nonlinear-reachable-via-script-valid'\n+    Then usage OPF-096b is reported\n+    But no errors or warnings are reported\n+\n+  @spec @xref:sec-itemref-elem\n+  Scenario: Report an EPUB where non-linear content is unreachable\n+    When checking EPUB 'spine-nonlinear-not-reachable-error'\n+    Then error OPF-096 is reported\n+    And no other errors or warnings are reported\n+\n \n   ## 5.8 Collections\n   \ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex 70026ee..b82e2d1 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -273,12 +273,6 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n     When checking EPUB 'content-xhtml-link-rel-path-dot-valid'\n     Then no errors or warnings are reported\n \n-  @spec @xref:sec-spine-elem\n-  Scenario: Report a link to a resource that is not in the spine\n-    When checking EPUB 'content-xhtml-link-out-of-spine-error'\n-    Then error RSC-011 is reported\n-    And no other errors or warnings are reported\n-\n   @spec @xref:sec-manifest-elem\n   Scenario: Report a reference from an XHTML doc to a resource not declared in the manifest\n     When checking EPUB 'content-xhtml-referenced-resource-missing-error'\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/content_001.xhtml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/content_001.xhtml\ndeleted file mode 100644\nindex 4931aa3..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/content_001.xhtml\n+++ /dev/null\n@@ -1,10 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal EPUB</title>\n-\t</head>\n-\t<body>\n-\t\t<p><a href=\"content_002.xhtml\">not in spine link</a></p>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/content_002.xhtml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/content_002.xhtml\ndeleted file mode 100644\nindex ea29a16..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/content_002.xhtml\n+++ /dev/null\n@@ -1,11 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal EPUB</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Loomings</h1>\n-\t\t<p>Call me Ishmael.</p>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/nav.xhtml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/nav.xhtml\ndeleted file mode 100644\nindex 240745e..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/nav.xhtml\n+++ /dev/null\n@@ -1,14 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal Nav</title>\n-\t</head>\n-\t<body>\n-\t\t<nav epub:type=\"toc\">\n-\t\t\t<ol>\n-\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n-\t\t\t</ol>\n-\t\t</nav>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/package.opf b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/package.opf\ndeleted file mode 100644\nindex 556ca5f..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/EPUB/package.opf\n+++ /dev/null\n@@ -1,17 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n-<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n-  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n-  <dc:language>en</dc:language>\n-  <dc:identifier id=\"q\">NOID</dc:identifier>\n-  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n-</metadata>\n-<manifest>\n-  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n-  <item id=\"content_002\"  href=\"content_002.xhtml\" media-type=\"application/xhtml+xml\"/>\n-  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-</manifest>\n-<spine>\n-  <itemref idref=\"content_001\" />\n-</spine>\n-</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/META-INF/container.xml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/META-INF/container.xml\ndeleted file mode 100644\nindex 2ca12ef..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/META-INF/container.xml\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n-\t<rootfiles>\n-\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n-\t</rootfiles>\n-</container>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/mimetype b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/mimetype\ndeleted file mode 100644\nindex 57ef03f..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-out-of-spine-error/mimetype\n+++ /dev/null\n@@ -1,1 +0,0 @@\n-application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-error/EPUB/package.opf b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-error/EPUB/package.opf\nindex cfe4a41..b4cf237 100644\n--- a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-error/EPUB/package.opf\n@@ -12,7 +12,6 @@\n         <item id=\"cover\" href=\"cover.svg\" media-type=\"image/svg+xml\"/>\n     </manifest>\n     <spine>\n-        <itemref idref=\"nav\" linear=\"no\"/>\n         <itemref idref=\"cover\"/>\n     </spine>\n </package>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-on-inner-svg-valid/EPUB/package.opf b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-on-inner-svg-valid/EPUB/package.opf\nindex cfe4a41..b4cf237 100644\n--- a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-on-inner-svg-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-on-inner-svg-valid/EPUB/package.opf\n@@ -12,7 +12,6 @@\n         <item id=\"cover\" href=\"cover.svg\" media-type=\"image/svg+xml\"/>\n     </manifest>\n     <spine>\n-        <itemref idref=\"nav\" linear=\"no\"/>\n         <itemref idref=\"cover\"/>\n     </spine>\n </package>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-percent-error/EPUB/package.opf b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-percent-error/EPUB/package.opf\nindex cfe4a41..b4cf237 100644\n--- a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-percent-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-percent-error/EPUB/package.opf\n@@ -12,7 +12,6 @@\n         <item id=\"cover\" href=\"cover.svg\" media-type=\"image/svg+xml\"/>\n     </manifest>\n     <spine>\n-        <itemref idref=\"nav\" linear=\"no\"/>\n         <itemref idref=\"cover\"/>\n     </spine>\n </package>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-units-error/EPUB/package.opf b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-units-error/EPUB/package.opf\nindex cfe4a41..b4cf237 100644\n--- a/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-units-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-svg-no-viewbox-width-height-units-error/EPUB/package.opf\n@@ -12,7 +12,6 @@\n         <item id=\"cover\" href=\"cover.svg\" media-type=\"image/svg+xml\"/>\n     </manifest>\n     <spine>\n-        <itemref idref=\"nav\" linear=\"no\"/>\n         <itemref idref=\"cover\"/>\n     </spine>\n </package>\ndiff --git a/src/test/resources/epub3/08-layout/files/content-fxl-svg-valid/EPUB/package.opf b/src/test/resources/epub3/08-layout/files/content-fxl-svg-valid/EPUB/package.opf\nindex cfe4a41..b4cf237 100644\n--- a/src/test/resources/epub3/08-layout/files/content-fxl-svg-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/08-layout/files/content-fxl-svg-valid/EPUB/package.opf\n@@ -12,7 +12,6 @@\n         <item id=\"cover\" href=\"cover.svg\" media-type=\"image/svg+xml\"/>\n     </manifest>\n     <spine>\n-        <itemref idref=\"nav\" linear=\"no\"/>\n         <itemref idref=\"cover\"/>\n     </spine>\n </package>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T21:00:02.469811Z", "commit_hash": "003234af98b19bf523e915b5bc7e1beb53bea378", "commit_message": "feat: check stylesheets declared in SVG\n\nThis enables checking of CSS declared in SVG inline `style`\nelement, as well as stylesheets declared in  `<?xml-stylesheet?>`\nprocessing instructions.\n\nFix #1450\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/css/CSSHandler.java b/src/main/java/com/adobe/epubcheck/css/CSSHandler.java\nindex 0899ba9..fec6c3f 100644\n--- a/src/main/java/com/adobe/epubcheck/css/CSSHandler.java\n+++ b/src/main/java/com/adobe/epubcheck/css/CSSHandler.java\n@@ -159,7 +159,7 @@ public class CSSHandler implements CssContentHandler, CssErrorHandler\n         }\n         if (uri != null)\n         {\n-          resolveAndRegister(uri, line, col, atRule.toCssString(), Reference.Type.GENERIC);\n+          resolveAndRegister(uri, line, col, atRule.toCssString(), Reference.Type.STYLESHEET);\n         }\n       }\n     }\n@@ -390,7 +390,10 @@ public class CSSHandler implements CssContentHandler, CssErrorHandler\n         if (url != null && context.referenceRegistry.isPresent())\n         {\n           context.referenceRegistry.get().registerReference(url, type, getCorrectedEPUBLocation(line, col, cssContext));\n-          if (context.isRemote(url))\n+          // register that a remote resource was found\n+          // no need to register a remote stylesheet, as these are disallowed\n+          // and will be reported elsewhere\n+          if (type != Reference.Type.STYLESHEET && context.isRemote(url))\n           {\n             detectedProperties.add(ITEM_PROPERTIES.REMOTE_RESOURCES);\n           }\ndiff --git a/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java b/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java\nindex dfcf41c..1867e05 100755\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java\n@@ -25,7 +25,10 @@ package com.adobe.epubcheck.ops;\n import java.util.Locale;\n import java.util.Stack;\n \n+import org.w3c.epubcheck.constants.MIMEType;\n import org.w3c.epubcheck.core.references.Reference;\n+import org.w3c.epubcheck.core.references.Reference.Type;\n+import org.xml.sax.SAXException;\n \n import com.adobe.epubcheck.api.EPUBLocation;\n import com.adobe.epubcheck.css.CSSChecker;\n@@ -40,6 +43,8 @@ import com.adobe.epubcheck.xml.handlers.XMLHandler;\n import com.adobe.epubcheck.xml.model.XMLElement;\n \n import io.mola.galimatias.URL;\n+import net.sf.saxon.trans.XPathException;\n+import net.sf.saxon.tree.util.ProcInstParser;\n \n public class OPSHandler extends XMLHandler\n {\n@@ -190,6 +195,10 @@ public class OPSHandler extends XMLHandler\n     Reference.Type resourceType = Reference.Type.GENERIC;\n     if (ns != null)\n     {\n+      if (name.equals(\"style\"))\n+      {\n+        textNode = new StringBuilder();\n+      }\n       if (ns.equals(\"http://www.w3.org/2000/svg\"))\n       {\n         if (name.equals(\"lineargradient\") || name.equals(\"radialgradient\")\n@@ -246,10 +255,6 @@ public class OPSHandler extends XMLHandler\n         {\n           checkLink();\n         }\n-        else if (name.equals(\"style\"))\n-        {\n-          textNode = new StringBuilder();\n-        }\n         else if (name.equals(\"iframe\"))\n         {\n           checkIFrame();\n@@ -341,20 +346,21 @@ public class OPSHandler extends XMLHandler\n \n     EPUBLocation currentLocation = elementLocationStack.pop();\n \n-    if (EpubConstants.HtmlNamespaceUri.equals(ns))\n+    if (\"style\".equals(name))\n     {\n-\n-      if (\"style\".equals(name))\n+      String style = textNode.toString();\n+      if (style.length() > 0)\n       {\n-        String style = textNode.toString();\n-        if (style.length() > 0)\n-        {\n-          this.hasCSS = true;\n-          new CSSChecker(context, style, currentLocation.getLine(), false).check();\n-        }\n-        textNode = null;\n+        this.hasCSS = true;\n+        new CSSChecker(context, style, currentLocation.getLine(), false).check();\n       }\n-      else if (\"table\".equals(name))\n+      textNode = null;\n+    }\n+\n+    if (EpubConstants.HtmlNamespaceUri.equals(ns))\n+    {\n+\n+      if (\"table\".equals(name))\n       {\n         if (tableDepth > 0)\n         {\n@@ -392,4 +398,39 @@ public class OPSHandler extends XMLHandler\n     }\n   }\n \n+  @Override\n+  public void processingInstruction(String target, String data)\n+    throws SAXException\n+  {\n+    super.processingInstruction(target, data);\n+\n+    // for SVG documents, parse 'xml-stylesheet' processing instructions\n+    if (MIMEType.SVG.is(context.mimeType) && \"xml-stylesheet\".equals(target))\n+    {\n+      checkXMLStylesheetPI(data);\n+    }\n+  }\n+\n+  protected void checkXMLStylesheetPI(String data)\n+  {\n+    assert data != null;\n+    try\n+    {\n+      String type = ProcInstParser.getPseudoAttribute(data, \"type\");\n+      if (type == null || MIMEType.CSS.is(type))\n+      {\n+        String href = ProcInstParser.getPseudoAttribute(data, \"href\");\n+        URL url = checkURL(href);\n+        if (url != null)\n+        {\n+          hasCSS = true;\n+          registerReference(url, Type.STYLESHEET);\n+        }\n+      }\n+    } catch (XPathException e1)\n+    {\n+      // ignore invalid declaration, must have been reported earlier\n+    }\n+  }\n+\n }\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-svg-content-error.svg b/src/test/resources/epub3/03-resources/files/file-url-in-svg-content-error.svg\nnew file mode 100644\nindex 0000000..f16c089\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-svg-content-error.svg\n@@ -0,0 +1,10 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<?xml-stylesheet type=\"text/css\" href=\"file:example\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<style type=\"text/css\">\n+\t\t@import url(file:example);\n+\t</style>\n+\t<desc>Rectangle</desc>\n+\t<rect x=\"0\" y=\"0\" width=\"50\" height=\"50\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/content_001.svg b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..beee238\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/content_001.svg\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<style type=\"text/css\">\n+\t\t@import url(https://example.org/style.css);\n+\t</style>\n+\t<rect x=\"0\" y=\"0\" width=\"50\" height=\"50\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/nav.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..97e2cf4\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/EPUB/package.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/META-INF/container.xml b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/mimetype b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-import-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/content_001.svg b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..0746bd6\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/content_001.svg\n@@ -0,0 +1,7 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<?xml-stylesheet type=\"text/css\" href=\"https://example.org/style.css\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<rect x=\"0\" y=\"0\" width=\"50\" height=\"50\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/nav.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..97e2cf4\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/EPUB/package.opf\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/META-INF/container.xml b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/mimetype b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-stylesheet-svg-xmlpi-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.mp3 b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.mp3\nnew file mode 100644\nindex 0000000..3f140bb\nBinary files /dev/null and b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.mp3 differ\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.smil b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.smil\nnew file mode 100644\nindex 0000000..6ef3de3\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.smil\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<smil xmlns=\"http://www.w3.org/ns/SMIL\" xmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"3.0\">\n+    <body>\n+        <par id=\"par1\">\n+            <text src=\"content_001.svg#c01\"/>\n+            <audio src=\"content_001.mp3\"/>\n+        </par>\n+    </body>\n+</smil>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.svg b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..036ce29\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/content_001.svg\n@@ -0,0 +1,14 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<style type=\"text/css\">\n+\t\t.-epub-media-overlay-active {\n+\t\t  background-color: yellow; \n+\t\t}\n+\t\t.-epub-media-overlay-playing {\n+\t\t  color: gray;\n+\t\t}\n+\t</style>\n+\t<rect id=\"c01\" x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/nav.xhtml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/package.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..cc19a57\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/EPUB/package.opf\n@@ -0,0 +1,22 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <meta property=\"media:duration\">2.5s</meta>\n+  <meta property=\"media:duration\" refines=\"#mo_001\">2.5s</meta>\n+  <meta property=\"media:active-class\">-epub-media-overlay-active</meta>\n+  <meta property=\"media:playback-active-class\">-epub-media-overlay-playing</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\" media-overlay=\"mo_001\"/>\n+  <item id=\"mo_001\"  href=\"content_001.smil\" media-type=\"application/smil+xml\"/>\n+  <item id=\"audio_001\"  href=\"content_001.mp3\" media-type=\"audio/mpeg\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/META-INF/container.xml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/mimetype b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-inline-style-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.mp3 b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.mp3\nnew file mode 100644\nindex 0000000..3f140bb\nBinary files /dev/null and b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.mp3 differ\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.smil b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.smil\nnew file mode 100644\nindex 0000000..6ef3de3\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.smil\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<smil xmlns=\"http://www.w3.org/ns/SMIL\" xmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"3.0\">\n+    <body>\n+        <par id=\"par1\">\n+            <text src=\"content_001.svg#c01\"/>\n+            <audio src=\"content_001.mp3\"/>\n+        </par>\n+    </body>\n+</smil>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.svg b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..cb4d2de\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/content_001.svg\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<rect id=\"c01\" x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/nav.xhtml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/package.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..cc19a57\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/EPUB/package.opf\n@@ -0,0 +1,22 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <meta property=\"media:duration\">2.5s</meta>\n+  <meta property=\"media:duration\" refines=\"#mo_001\">2.5s</meta>\n+  <meta property=\"media:active-class\">-epub-media-overlay-active</meta>\n+  <meta property=\"media:playback-active-class\">-epub-media-overlay-playing</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\" media-overlay=\"mo_001\"/>\n+  <item id=\"mo_001\"  href=\"content_001.smil\" media-type=\"application/smil+xml\"/>\n+  <item id=\"audio_001\"  href=\"content_001.mp3\" media-type=\"audio/mpeg\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/META-INF/container.xml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/mimetype b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-style-not-found-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.mp3 b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.mp3\nnew file mode 100644\nindex 0000000..3f140bb\nBinary files /dev/null and b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.mp3 differ\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.smil b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.smil\nnew file mode 100644\nindex 0000000..6ef3de3\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.smil\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<smil xmlns=\"http://www.w3.org/ns/SMIL\" xmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"3.0\">\n+    <body>\n+        <par id=\"par1\">\n+            <text src=\"content_001.svg#c01\"/>\n+            <audio src=\"content_001.mp3\"/>\n+        </par>\n+    </body>\n+</smil>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.svg b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..f19fbae\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/content_001.svg\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<style type=\"text/css\">\n+\t\t@import url(styles.css);\n+\t</style>\n+\t<rect id=\"c01\" x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/nav.xhtml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/package.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..05c947d\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/package.opf\n@@ -0,0 +1,23 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <meta property=\"media:duration\">2.5s</meta>\n+  <meta property=\"media:duration\" refines=\"#mo_001\">2.5s</meta>\n+  <meta property=\"media:active-class\">-epub-media-overlay-active</meta>\n+  <meta property=\"media:playback-active-class\">-epub-media-overlay-playing</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\" media-overlay=\"mo_001\"/>\n+  <item id=\"mo_001\"  href=\"content_001.smil\" media-type=\"application/smil+xml\"/>\n+  <item id=\"audio_001\"  href=\"content_001.mp3\" media-type=\"audio/mpeg\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"styles\"  href=\"styles.css\" media-type=\"text/css\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/styles.css b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/styles.css\nnew file mode 100644\nindex 0000000..2062937\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/EPUB/styles.css\n@@ -0,0 +1,6 @@\n+.-epub-media-overlay-active {\n+  background-color: yellow; \n+}\n+.-epub-media-overlay-playing {\n+  color: gray;\n+}\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/META-INF/container.xml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/mimetype b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-import-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.mp3 b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.mp3\nnew file mode 100644\nindex 0000000..3f140bb\nBinary files /dev/null and b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.mp3 differ\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.smil b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.smil\nnew file mode 100644\nindex 0000000..6ef3de3\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.smil\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<smil xmlns=\"http://www.w3.org/ns/SMIL\" xmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"3.0\">\n+    <body>\n+        <par id=\"par1\">\n+            <text src=\"content_001.svg#c01\"/>\n+            <audio src=\"content_001.mp3\"/>\n+        </par>\n+    </body>\n+</smil>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.svg b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..7bee699\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/content_001.svg\n@@ -0,0 +1,7 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<link xmlns=\"http://www.w3.org/1999/xhtml\" rel=\"stylesheet\" href=\"styles.css\" type=\"text/css\" />\n+\t<rect id=\"c01\" x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/nav.xhtml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/package.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..05c947d\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/package.opf\n@@ -0,0 +1,23 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <meta property=\"media:duration\">2.5s</meta>\n+  <meta property=\"media:duration\" refines=\"#mo_001\">2.5s</meta>\n+  <meta property=\"media:active-class\">-epub-media-overlay-active</meta>\n+  <meta property=\"media:playback-active-class\">-epub-media-overlay-playing</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\" media-overlay=\"mo_001\"/>\n+  <item id=\"mo_001\"  href=\"content_001.smil\" media-type=\"application/smil+xml\"/>\n+  <item id=\"audio_001\"  href=\"content_001.mp3\" media-type=\"audio/mpeg\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"styles\"  href=\"styles.css\" media-type=\"text/css\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/styles.css b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/styles.css\nnew file mode 100644\nindex 0000000..2062937\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/EPUB/styles.css\n@@ -0,0 +1,6 @@\n+.-epub-media-overlay-active {\n+  background-color: yellow; \n+}\n+.-epub-media-overlay-playing {\n+  color: gray;\n+}\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/META-INF/container.xml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/mimetype b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-link-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.mp3 b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.mp3\nnew file mode 100644\nindex 0000000..3f140bb\nBinary files /dev/null and b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.mp3 differ\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.smil b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.smil\nnew file mode 100644\nindex 0000000..6ef3de3\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.smil\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<smil xmlns=\"http://www.w3.org/ns/SMIL\" xmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"3.0\">\n+    <body>\n+        <par id=\"par1\">\n+            <text src=\"content_001.svg#c01\"/>\n+            <audio src=\"content_001.mp3\"/>\n+        </par>\n+    </body>\n+</smil>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.svg b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.svg\nnew file mode 100644\nindex 0000000..29d2ddf\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/content_001.svg\n@@ -0,0 +1,7 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<?xml-stylesheet type=\"text/css\" href=\"styles.css\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Content Document</title>\n+\t<desc>Rectangle</desc>\n+\t<rect id=\"c01\" x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/nav.xhtml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..b75e440\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.svg\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/package.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..05c947d\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/package.opf\n@@ -0,0 +1,23 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <meta property=\"media:duration\">2.5s</meta>\n+  <meta property=\"media:duration\" refines=\"#mo_001\">2.5s</meta>\n+  <meta property=\"media:active-class\">-epub-media-overlay-active</meta>\n+  <meta property=\"media:playback-active-class\">-epub-media-overlay-playing</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.svg\" media-type=\"image/svg+xml\" media-overlay=\"mo_001\"/>\n+  <item id=\"mo_001\"  href=\"content_001.smil\" media-type=\"application/smil+xml\"/>\n+  <item id=\"audio_001\"  href=\"content_001.mp3\" media-type=\"audio/mpeg\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"styles\"  href=\"styles.css\" media-type=\"text/css\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/styles.css b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/styles.css\nnew file mode 100644\nindex 0000000..2062937\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/EPUB/styles.css\n@@ -0,0 +1,6 @@\n+.-epub-media-overlay-active {\n+  background-color: yellow; \n+}\n+.-epub-media-overlay-playing {\n+  color: gray;\n+}\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/META-INF/container.xml b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/mimetype b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-active-class-svg-stylesheet-xml-pi-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml b/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml\nindex bc75bc2..99e3778 100644\n--- a/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml\n@@ -3,6 +3,9 @@\n \t<head>\n \t\t<meta charset=\"utf-8\"/>\n \t\t<title>Minimal EPUB</title>\n+\t\t<style>\n+\t\t\t@import url(file:example);\n+\t\t</style>\n \t</head>\n \t<body>\n \t\t<h1>Loomings</h1>\ndiff --git a/src/test/resources/epub3/03-resources/resources.feature b/src/test/resources/epub3/03-resources/resources.feature\nindex 2bb733b..c9e49aa 100644\n--- a/src/test/resources/epub3/03-resources/resources.feature\n+++ b/src/test/resources/epub3/03-resources/resources.feature\n@@ -473,6 +473,18 @@\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-resource-locations\n+  Scenario: Report a remote stylesheet declared in SVG XML processing instruction\n+    When checking EPUB 'resources-remote-stylesheet-svg-xmlpi-error'\n+    Then error RSC-006 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-resource-locations\n+  Scenario: Report a remote stylesheet declared in SVG inline style import\n+    When checking EPUB 'resources-remote-stylesheet-svg-import-error'\n+    Then error RSC-006 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-resource-locations\n   Scenario: Warn about a remote resource with a non `https` URL\n     When checking EPUB 'resources-remote-not-https-warning'\n     Then warning RSC-031 is reported 3 times\n@@ -544,9 +556,15 @@\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-file-urls\n-  Scenario: Report a file URL used in a content document\n+  Scenario: Report a file URL used in an XHTML content document\n     When checking document 'file-url-in-xhtml-content-error.xhtml'\n-    Then error RSC-030 is reported\n+    Then error RSC-030 is reported 2 times\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-file-urls\n+  Scenario: Report a file URL used in an SVG content document\n+    When checking document 'file-url-in-svg-content-error.svg'\n+    Then error RSC-030 is reported 2 times\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-file-urls\ndiff --git a/src/test/resources/epub3/09-media-overlays/media-overlays.feature b/src/test/resources/epub3/09-media-overlays/media-overlays.feature\nindex 4727303..9d63ea9 100644\n--- a/src/test/resources/epub3/09-media-overlays/media-overlays.feature\n+++ b/src/test/resources/epub3/09-media-overlays/media-overlays.feature\n@@ -202,44 +202,81 @@ Feature: EPUB 3 \u2014 Media Overlays\n \n \n   ### 9.3.4 Associating style information\n-  \n+\n   @spec @xref:sec-docs-assoc-style\n   Scenario: Verify 'media:active-class' and 'media:playback-active-class' properties referring to classes defined in a stylesheet\n     Given the reporting level is set to USAGE\n     When checking EPUB 'mediaoverlays-active-class-stylesheet-valid'\n-    Then usage CSS-029 is reported 0 times \n-    And no errors or warnings are reported\n-  \n+    Then no errors or warnings are reported\n+    And no usages are reported\n+\n   @spec @xref:sec-docs-assoc-style\n   Scenario: Verify 'media:active-class' and 'media:playback-active-class' properties referring to classes defined inline\n+    Given the reporting level is set to USAGE\n     When checking EPUB 'mediaoverlays-active-class-inline-valid'\n     Then no errors or warnings are reported\n-  \n+    And no usages are reported\n+\n+  @spec @xref:sec-docs-assoc-style\n+  Scenario: Verify 'media:active-class' and 'media:playback-active-class' properties referring to classes defined inline in SVG\n+    Given the reporting level is set to USAGE\n+    When checking EPUB 'mediaoverlays-active-class-svg-inline-style-valid'\n+    Then no errors or warnings are reported\n+    And no usages are reported\n+\n+  @spec @xref:sec-docs-assoc-style\n+  Scenario: Verify 'media:active-class' and 'media:playback-active-class' properties referring to classes defined in stylesheet linked from SVG\n+    Given the reporting level is set to USAGE\n+    When checking EPUB 'mediaoverlays-active-class-svg-stylesheet-link-valid'\n+    Then no errors or warnings are reported\n+    And no usages are reported\n+\n+  @spec @xref:sec-docs-assoc-style\n+  Scenario: Verify 'media:active-class' and 'media:playback-active-class' properties referring to classes defined in stylesheet imported from SVG\n+    Given the reporting level is set to USAGE\n+    When checking EPUB 'mediaoverlays-active-class-svg-stylesheet-import-valid'\n+    Then no errors or warnings are reported\n+    And no usages are reported\n+\n+  @spec @xref:sec-docs-assoc-style\n+  Scenario: Verify 'media:active-class' and 'media:playback-active-class' properties referring to classes defined in stylesheet linked as processing instruction from SVG\n+    Given the reporting level is set to USAGE\n+    When checking EPUB 'mediaoverlays-active-class-svg-stylesheet-xml-pi-valid'\n+    Then no errors or warnings are reported\n+    And no usages are reported\n+\n   Scenario: Report when well-known class names are found in CSS but not declared in the package document \n     Given the reporting level is set to USAGE\n     When checking EPUB 'mediaoverlays-active-class-stylesheet-undeclared-valid'\n     Then usage CSS-029 is reported 2 times \n-    But no errors or warnings are reported\n-  \n+    But no other usages are reported\n+    And no errors or warnings are reported\n+\n   @spec @xref:sec-docs-assoc-style\n-  Scenario: Report when 'media:active-class' is defined but no CSS was found in the content document\n+  Scenario: Report when 'media:active-class' is defined but no CSS was found in the XHTML content document\n     When checking EPUB 'mediaoverlays-active-class-style-not-found-error'\n     Then error CSS-030 is reported\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-docs-assoc-style\n-  Scenario: Report when 'media:playback-active-class' is defined but no CSS was found in the content document\n+  Scenario: Report when 'media:playback-active-class' is defined but no CSS was found in the XHTML content document\n     When checking EPUB 'mediaoverlays-playback-active-class-style-not-found-error'\n     Then error CSS-030 is reported\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-docs-assoc-style\n+  Scenario: Report when 'media:active-class' is defined but no CSS was found in the SVG content document\n+    When checking EPUB 'mediaoverlays-active-class-svg-style-not-found-error'\n+    Then error CSS-030 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-docs-assoc-style\n   Scenario: Report a 'media:active-class' property with a refines attribute\n     When checking file 'mediaoverlays-active-class-refines-error.opf'\n     Then error RSC-005 is reported\n     And the message contains \"must not be used with the media:active-class property\"\n     And no other errors or warnings are reported\n-  \n+\n   @spec @xref:sec-docs-assoc-style\n   Scenario: Report a 'media:playback-active-class' property with a refines attribute\n     When checking file 'mediaoverlays-playback-active-class-refines-error.opf'\n@@ -260,7 +297,7 @@ Feature: EPUB 3 \u2014 Media Overlays\n     Then error RSC-005 is reported\n     And the message contains \"must define a single class name\"\n     And no other errors or warnings are reported\n-  \n+\n   #Scenario: Detect when media overlays class are declared in the publication but no CSS is found\n     \n   ### 9.3.5 Media overlays packaging\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T21:13:27.206540Z", "commit_hash": "bfb72396ffdfe76804b8d51d0d3c181abfcf8e92", "commit_message": "feat: disallow `epub:type` on `head` and metadata content\n\nThis PR implements the latest post-CR update on where `epub:type` is\nallowed in HTML content (i.e. everywhere but the `head` element and\nmetadata content).\n\nSee w3c/epub-specs#2493\n\nFix #1444, Fix #1445\n", "related_issues": "", "bug_patch": "diff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc\nindex 018b46d..87bcd75 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc\n@@ -3,6 +3,7 @@ namespace local = \"\"\n namespace x = \"http://www.w3.org/1999/xhtml\"\n namespace ev = \"http://www.w3.org/2001/xml-events\"\n namespace ssml = \"http://www.w3.org/2001/10/synthesis\"\n+namespace epub = \"http://www.idpf.org/2007/ops\"\n \n # #####################################################################\n # \n@@ -19,7 +20,7 @@ include \"mathml/mathml3-inc.rnc\" {\n \n     # extend to circumvent datatype collisions\n     NonMathMLAtt =\n-        attribute * - (local:* | m:* | xml:* | x:* | ev:* | ssml:*) {\n+        attribute * - (local:* | m:* | xml:* | x:* | ev:* | ssml:* | epub:*) {\n             datatype.string\n         }\n \n@@ -30,6 +31,8 @@ include \"mathml/mathml3-inc.rnc\" {\n     annotation-xml = epub.annotation-xml\n }\n # Common attribute extensions\n+# - epub:type\n+CommonAtt &= epub.type.attr?\n # - SSML attributes \n CommonAtt &= epub.ssml.ph.attr?\n # - xml:base\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc\nindex 3cce847..f2a328a 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc\n@@ -7,89 +7,141 @@\n \n ## combine `epub:type`\n \n-  # Allow `epub:type` on the `body` element (even though\n-  # it is not defined as palpable content)\n-  body.attrs &= epub.type.attr?\n-  \n-  # Allow `epub:type` on palpable content\n+  # Allow `epub:type` on all elements except:\n+  #  - the `head` element\n+  #  - metadata content (base, link, meta, noscript, script, style, template, title)\n   #\n   # Note:\n   # We can't use a common category since none is defined\n-  # for palpable content. So we add it for each element.\n-  #\n-  # Some elements are only considered palpable under some\n-  # conditions; we do not support that at the moment.\n-  #\n-  a.attrs &= epub.type.attr?\n-  abbr.attrs &= epub.type.attr?\n-  address.attrs &= epub.type.attr?\n-  article.attrs &= epub.type.attr?\n-  aside.attrs &= epub.type.attr?\n-  audio.attrs &= epub.type.attr?\n-  b.attrs &= epub.type.attr?\n-  bdi.attrs &= epub.type.attr?\n-  bdo.attrs &= epub.type.attr?\n-  blockquote.attrs &= epub.type.attr?\n-  button.attrs &= epub.type.attr?\n+  # for non-metadata content. So we add it for each element.\n+\n+  # from applications.rnc\n+  progress.attrs &= epub.type.attr?\n+  dialog.attrs &= epub.type.attr?\n+  menu.attrs &= epub.type.attr?\n+  mli.attrs &= epub.type.attr?\n   canvas.attrs &= epub.type.attr?\n-  cite.attrs &= epub.type.attr?\n-  code.attrs &= epub.type.attr?\n-  data.attrs &= epub.type.attr?\n   details.attrs &= epub.type.attr?\n-  dfn.attrs &= epub.type.attr?\n-  div.attrs &= epub.type.attr?\n+  summary.attrs &= epub.type.attr?\n+\n+  # from block.rnc\n+  p.attrs &= epub.type.attr?\n+  hr.attrs &= epub.type.attr?\n+  pre.attrs &= epub.type.attr?\n+  ul.attrs &= epub.type.attr?\n+  li.attrs &= epub.type.attr?\n+  ol.attrs &= epub.type.attr?\n+  oli.attrs &= epub.type.attr?\n   dl.attrs &= epub.type.attr?\n-  emembed.attrs &= epub.type.attr?\n-  fieldset.attrs &= epub.type.attr?\n+  dt.attrs &= epub.type.attr?\n+  dd.attrs &= epub.type.attr?\n+  div.attrs &= epub.type.attr?\n+  legend.attrs &= epub.type.attr?\n+\n+  # from data.rnc\n+  time.attrs &= epub.type.attr?\n+  time.datetime.attrs &= epub.type.attr?\n+  data.attrs &= epub.type.attr?\n+  meter.attrs &= epub.type.attr?\n+\n+  # from embed.rnc\n+  img.attrs &= epub.type.attr?\n+  picture.attrs &= epub.type.attr?\n+  embed.attrs &= epub.type.attr?\n+  object.attrs &= epub.type.attr?\n+  param.attrs &= epub.type.attr?\n+  iframe.attrs &= epub.type.attr?\n+  map.attrs &= epub.type.attr?\n+  area.attrs &= epub.type.attr?\n+\n+  # from media.rnc\n+  source.attrs &= epub.type.attr?\n+  video.attrs &= epub.type.attr?\n+  audio.attrs &= epub.type.attr?\n+  track.attrs &= epub.type.attr?\n   figure.attrs &= epub.type.attr?\n-  footer.attrs &= epub.type.attr?\n-  form.attrs &= epub.type.attr?\n+  figcaption.attrs &= epub.type.attr?\n+\n+  # from meta.rnc\n+  html.attrs &= epub.type.attr?\n+  body.attrs &= epub.type.attr?\n+\n+  # from phrase.rnc\n+  a.href.attrs &= epub.type.attr?\n+  a.nohref.attrs &= epub.type.attr?\n+  em.attrs &= epub.type.attr?\n+  strong.attrs &= epub.type.attr?\n+  small.attrs &= epub.type.attr?\n+  mark.attrs &= epub.type.attr?\n+  abbr.attrs &= epub.type.attr?\n+  dfn.attrs &= epub.type.attr?\n+  i.attrs &= epub.type.attr?\n+  b.attrs &= epub.type.attr?\n+  s.attrs &= epub.type.attr?\n+  u.attrs &= epub.type.attr?\n+  code.attrs &= epub.type.attr?\n+  var.attrs &= epub.type.attr?\n+  samp.attrs &= epub.type.attr?\n+  kbd.attrs &= epub.type.attr?\n+  sup.attrs &= epub.type.attr?\n+  sub.attrs &= epub.type.attr?\n+  q.attrs &= epub.type.attr?\n+  cite.attrs &= epub.type.attr?\n+  span.attrs &= epub.type.attr?\n+  bdo.attrs &= epub.type.attr?\n+  bdi.attrs &= epub.type.attr?\n+  br.attrs &= epub.type.attr?\n+  wbr.attrs &= epub.type.attr?\n+\n+  # from revision.rnc\n+  ins.attrs &= epub.type.attr?\n+  del.attrs &= epub.type.attr?\n+\n+  # from ruby.rnc\n+  ruby.attrs &= epub.type.attr?\n+  rt.attrs &= epub.type.attr?\n+  rp.attrs &= epub.type.attr?\n+\n+  # from sectional.rnc\n   h1.attrs &= epub.type.attr?\n   h2.attrs &= epub.type.attr?\n   h3.attrs &= epub.type.attr?\n   h4.attrs &= epub.type.attr?\n   h5.attrs &= epub.type.attr?\n   h6.attrs &= epub.type.attr?\n-  header.attrs &= epub.type.attr?\n   hgroup.attrs &= epub.type.attr?\n-  i.attrs &= epub.type.attr?\n-  iframe.attrs &= epub.type.attr?\n-  img.attrs &= epub.type.attr?\n-  input.attrs &= epub.type.attr?\n-  ins.attrs &= epub.type.attr?\n-  kbd.attrs &= epub.type.attr?\n-  label.attrs &= epub.type.attr?\n-  main.attrs &= epub.type.attr?\n-  map.attrs &= epub.type.attr?\n-  mark.attrs &= epub.type.attr?\n-  menu.attrs &= epub.type.attr?\n-  meter.attrs &= epub.type.attr?\n-  nav.attrs &= epub.type.attr?\n-  object.attrs &= epub.type.attr?\n-  ol.attrs &= epub.type.attr?\n-  output.attrs &= epub.type.attr?\n-  p.attrs &= epub.type.attr?\n-  pre.attrs &= epub.type.attr?\n-  progress.attrs &= epub.type.attr?\n-  q.attrs &= epub.type.attr?\n-  ruby.attrs &= epub.type.attr?\n-  s.attrs &= epub.type.attr?\n-  samp.attrs &= epub.type.attr?\n+  address.attrs &= epub.type.attr?\n+  blockquote.attrs &= epub.type.attr?\n+\n+  # from structural.rnc\n   section.attrs &= epub.type.attr?\n-  select.attrs &= epub.type.attr?\n-  small.attrs &= epub.type.attr?\n-  span.attrs &= epub.type.attr?\n-  strong.attrs &= epub.type.attr?\n-  sub.attrs &= epub.type.attr?\n-  sup.attrs &= epub.type.attr?\n+  nav.attrs &= epub.type.attr?\n+  article.attrs &= epub.type.attr?\n+  aside.attrs &= epub.type.attr?\n+  header.attrs &= epub.type.attr?\n+  footer.attrs &= epub.type.attr?\n+  main.attrs &= epub.type.attr?\n+\n+  # from tables.rnc\n   table.attrs &= epub.type.attr?\n-  text.attrs &= epub.type.attr?\n-  area.attrs &= epub.type.attr?\n-  time.attrs &= epub.type.attr?\n-  u.attrs &= epub.type.attr?\n-  ul.attrs &= epub.type.attr?\n-  var.attrs &= epub.type.attr?\n-  video.attrs &= epub.type.attr?\n+  caption.attrs &= epub.type.attr?\n+  colgroup.attrs &= epub.type.attr?\n+  thead.attrs &= epub.type.attr?\n+  tfoot.attrs &= epub.type.attr?\n+  tbody.attrs &= epub.type.attr?\n+  tr.attrs &= epub.type.attr?\n+  td.attrs &= epub.type.attr?\n+  th.attrs &= epub.type.attr?\n+\n+  # from web-forms.rnc and web-forms2.rnc\n+  common-form.attrs &= epub.type.attr?\n+  option.attrs &= epub.type.attr?\n+  optgroup.attrs &= epub.type.attr?\n+  form.attrs &= epub.type.attr?\n+  label.attrs &= epub.type.attr?\n+  output.attrs &= epub.type.attr?\n+  datalist.attrs &= epub.type.attr?\n+\n \n ## combine prefix attributes\n \ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-disallowed-error.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-disallowed-error.xhtml\nnew file mode 100644\nindex 0000000..48fdbba\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-disallowed-error.xhtml\n@@ -0,0 +1,17 @@\n+<!DOCTYPE html>\t \n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\"\n+\tepub:prefix=\"test: https://example.org/vocab/#\" xml:lang=\"en\" lang=\"en\">\n+\t<head epub:type=\"test:invalid\">\n+\t\t<meta epub:type=\"test:invalid\" charset=\"utf-8\" />\n+\t\t<title epub:type=\"test:invalid\">epub:type in head element</title>\n+\t\t<meta epub:type=\"test:invalid\" name=\"creator\" content=\"Herman Melville\"  />\n+\t\t<style epub:type=\"test:invalid\"></style>\n+\t\t<link epub:type=\"test:invalid\" type=\"text/css\" rel=\"stylesheet\" href=\"style.css\" />\n+\t</head>\n+\t<body>\n+\t\t<script epub:type=\"test:invalid\" src=\"script.js\"></script>\n+\t\t<noscript epub:type=\"test:invalid\">text</noscript>\n+\t\t<h1>Test</h1>\n+\t\t<div></div>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-misuse-usage.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-misuse-usage.xhtml\nnew file mode 100644\nindex 0000000..23e3336\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-misuse-usage.xhtml\n@@ -0,0 +1,23 @@\n+<!DOCTYPE html>\t \n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>epub:type misuse per SSV recommedations</title>\n+\t</head>\n+\t<!-- not using semantics as recommended is not an error -->\n+\t<body>\n+\t\t<h1>Test</h1>\n+\t\t<table epub:type=\"table\">\n+\t\t\t<tr epub:type=\"table-row\">\n+\t\t\t\t<td epub:type=\"table-cell\">cell</td>\n+\t\t\t</tr>\n+\t\t</table>\n+\t\t<ul epub:type=\"list\">\n+\t\t\t<li epub:type=\"list-item\">item</li>\n+\t\t</ul>\n+\t\t<figure epub:type=\"figure\"> Figure </figure>\n+\t\t<aside epub:type=\"aside\">\n+\t\t\t<h2>Aside</h2>\n+\t\t</aside>\n+\t</body>\n+</html>\n", "test_patch": "diff --git a/src/test/resources/epub-region-nav/region-nav-publication.feature b/src/test/resources/epub-region-nav/region-nav-publication.feature\nindex 374049b..9432cc9 100644\n--- a/src/test/resources/epub-region-nav/region-nav-publication.feature\n+++ b/src/test/resources/epub-region-nav/region-nav-publication.feature\n@@ -91,5 +91,4 @@ Feature: EPUB Region-Based Navigation \u25b8 Full Publication Checks\n \n   Scenario: Verify subregion navigation using comics semantics\n     When checking EPUB 'region-based-nav-comics-valid'\n-    Then error RSC-005 is reported 4 times (non-palpable content)\n     Then no errors or warnings are reported\ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex b88bfca..70026ee 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -645,14 +645,15 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n \n   #### 6.1.3.1 Structural semantics\n \n-  Scenario: Verify `epub:type` attribute with valid semantic\n+  @spec @xref:sec-xhtml-structural-semantics\n+  Scenario: Verify `epub:type` attribute on allowed content\n     When checking document 'epubtype-valid.xhtml'\n     Then no errors or warnings are reported\n \n   @spec @xref:sec-xhtml-structural-semantics\n-  Scenario: Report `epub:type` attribute on non-palpable content\n-    When checking document 'epubtype-on-non-palpable-content-error.xhtml'\n-    Then error RSC-005 is reported 2 times\n+  Scenario: Report `epub:type` attribute on 'head' or metadata content \n+    When checking document 'epubtype-disallowed-error.xhtml'\n+    Then error RSC-005 is reported 8 times\n     And no other errors or warnings are reported\n   \n   Scenario: Verify `epub:type` attribute with reserved vocabulary\n@@ -678,8 +679,7 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n \n   Scenario: Verify `epub:type` attribute that does not follow usage suggestions\n     Given the reporting level set to usage\n-    When checking document 'epubtype-disallowed-usage.xhtml'\n-    Then error RSC-005 is reported 3 times (non-palpable content)\n+    When checking document 'epubtype-misuse-usage.xhtml'\n     Then usage OPF-087 is reported 7 times\n     And no other errors or warnings are reported\n \ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-disallowed-usage.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-disallowed-usage.xhtml\ndeleted file mode 100644\nindex 23e3336..0000000\n--- a/src/test/resources/epub3/06-content-document/files/epubtype-disallowed-usage.xhtml\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-<!DOCTYPE html>\t \n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>epub:type misuse per SSV recommedations</title>\n-\t</head>\n-\t<!-- not using semantics as recommended is not an error -->\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t\t<table epub:type=\"table\">\n-\t\t\t<tr epub:type=\"table-row\">\n-\t\t\t\t<td epub:type=\"table-cell\">cell</td>\n-\t\t\t</tr>\n-\t\t</table>\n-\t\t<ul epub:type=\"list\">\n-\t\t\t<li epub:type=\"list-item\">item</li>\n-\t\t</ul>\n-\t\t<figure epub:type=\"figure\"> Figure </figure>\n-\t\t<aside epub:type=\"aside\">\n-\t\t\t<h2>Aside</h2>\n-\t\t</aside>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-on-non-palpable-content-error.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-on-non-palpable-content-error.xhtml\ndeleted file mode 100644\nindex d02a422..0000000\n--- a/src/test/resources/epub3/06-content-document/files/epubtype-on-non-palpable-content-error.xhtml\n+++ /dev/null\n@@ -1,13 +0,0 @@\n-<!DOCTYPE html>\t \n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\"\n-\tepub:prefix=\"test: https://example.org/vocab/#\" xml:lang=\"en\" lang=\"en\">\n-\t<head epub:type=\"test:invalid\">\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>epub:type in head element</title>\n-\t\t<meta name=\"creator\" content=\"Herman Melville\" epub:type=\"test:invalid\" />\n-\t</head>\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t\t<div epub:type=\"test:valid\"></div>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-valid.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-valid.xhtml\nindex 12f8215..3bcb6ab 100644\n--- a/src/test/resources/epub3/06-content-document/files/epubtype-valid.xhtml\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-valid.xhtml\n@@ -12,5 +12,7 @@\n \t\t\t<h2>endnotes</h2>\n \t\t\t<div epub:type=\"endnote\">endnote</div>\n \t\t</section>\n+\t\t<a href=\"link.xhtml\" epub:type=\"tip\">link</a>\n+\t\t<a epub:type=\"glossref\">anchor</a>\n \t</body>\n </html>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T21:19:24.338970Z", "commit_hash": "c8e9f452519f740020a0c2632a79ed4be7919953", "commit_message": "fix: report HTML discouraged constructs as \"usage\"\n\nThe HTML discouraged constructs section is non-normative. This PR now\nreports use of these constructs as a usage message instead of a warning.\n\nThe severity level of `HTM-055` is now `USAGE`.\n\nFix #1387.\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 0419bbe..ceb0198 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -138,7 +138,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.HTM_052, Severity.ERROR);\n     severities.put(MessageId.HTM_053, Severity.SUPPRESSED);\n     severities.put(MessageId.HTM_054, Severity.ERROR);\n-    severities.put(MessageId.HTM_055, Severity.WARNING);\n+    severities.put(MessageId.HTM_055, Severity.USAGE);\n     severities.put(MessageId.HTM_056, Severity.ERROR);\n     severities.put(MessageId.HTM_057, Severity.ERROR);\n     severities.put(MessageId.HTM_058, Severity.ERROR);\n", "test_patch": "diff --git a/src/test/resources/epub3/03-resources/resources.feature b/src/test/resources/epub3/03-resources/resources.feature\nindex 9908a11..2bb733b 100644\n--- a/src/test/resources/epub3/03-resources/resources.feature\n+++ b/src/test/resources/epub3/03-resources/resources.feature\n@@ -110,16 +110,14 @@\n     And no errors or warnings are reported\n \n   @spec @xref:sec-foreign-resources\n-  Scenario: Report a foreign resource in HTML `embed` with a manifest fallback\n+  Scenario: Allow a foreign resource in HTML `embed` with a manifest fallback\n     When checking EPUB 'foreign-xhtml-embed-fallback-valid'\n-    And warning HTM-055 is reported (using embed is discouraged)\n-    And no other errors or warnings are reported\n+    Then no errors or warnings are reported\n \n   @spec @xref:sec-foreign-resources\n   Scenario: Report a foreign resource in HTML `embed` with no fallback\n     When checking EPUB 'foreign-xhtml-embed-no-fallback-error'\n     Then error RSC-032 is reported\n-    And warning HTM-055 is reported (using embed is discouraged)\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-foreign-resources\n@@ -652,5 +650,4 @@\n   Scenario: Report an `embed` element with a `type` attribute not matching the publication resource type\n     When checking EPUB 'type-mismatch-in-embed-warning'\n     Then warning OPF-013 is reported\n-    And warning HTM-055 is reported (using embed is discouraged)\n     And no other errors or warnings are reported\ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex 2c3a353..b88bfca 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -197,12 +197,10 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n \n   Scenario: Verify that a base url can be set\n     When checking EPUB 'content-xhtml-base-url-valid'\n-    Then warning HTM-055 is reported (side effect of `base` being discouraged)\n     Then no errors or warnings are reported\n \n   Scenario: Report relative paths as remote resources when HTML `base` is set to an extenal URL (issue 155)\n     When checking EPUB 'content-xhtml-base-url-remote-relative-path-error'\n-    Then warning HTM-055 is reported (side effect of `base` being discouraged)\n     Then error RSC-006 is reported\n     And no other errors or warnings are reported\n \n@@ -978,20 +976,23 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n   #### 6.1.4.3 Discouraged Constructs\n \n   Scenario: Report `base` as a discouraged construct\n+    Given the reporting level is set to usage\n     When checking document 'discouraged-base-warning.xhtml'\n-    Then warning HTM-055 is reported\n+    Then usage HTM-055 is reported\n     And the message contains 'base'\n-    And no other errors or warnings are reported\n+    And no errors or warnings are reported\n \n   Scenario: Report `embed` as a discouraged construct\n+    Given the reporting level is set to usage\n     When checking document 'discouraged-embed-warning.xhtml'\n-    Then warning HTM-055 is reported\n+    Then usage HTM-055 is reported\n     And the message contains 'embed'\n     And no other errors or warnings are reported\n \n   Scenario: Report `rp` as a discouraged construct\n+    Given the reporting level is set to usage\n     When checking document 'discouraged-rp-warning.xhtml'\n-    Then warning HTM-055 is reported 2 times\n+    Then usage HTM-055 is reported 2 times\n     And the message contains 'rp'\n     And no other errors or warnings are reported\n \n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T21:42:10.126673Z", "commit_hash": "c3d767cdaecf517fc3e9b86b43f7a52ba3daff4e", "commit_message": "fix: OPF-018 was incorrectly reported with inline CSS\n\n`OPF-018` checks that the `remote-resources` property is not defined\nif no remote resource was found.\nPrior to this commit, it was incorrectly reported when an XHTML content\ndocument carrying the property also contained inline CSS: the CSS checker\nthought that the property was not required since no remote resource\nwas found in the CSS itself.\nThis commit fixes that bug by only checking `OPF-018` for standalone\nCSS documents.\n\nFix #1335\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/css/CSSChecker.java b/src/main/java/com/adobe/epubcheck/css/CSSChecker.java\nindex 5f64da6..fa71a7e 100644\n--- a/src/main/java/com/adobe/epubcheck/css/CSSChecker.java\n+++ b/src/main/java/com/adobe/epubcheck/css/CSSChecker.java\n@@ -45,7 +45,7 @@ public class CSSChecker extends PublicationResourceChecker\n   private int line; // where css string occurs in host\n   private final boolean isStyleAttribute;\n \n-  private enum Mode\n+  enum Mode\n   {\n     FILE,\n     STRING\n@@ -94,7 +94,7 @@ public class CSSChecker extends PublicationResourceChecker\n     try\n     {\n \n-      CSSHandler handler = new CSSHandler(context);\n+      CSSHandler handler = new CSSHandler(context, mode);\n       if (this.mode == Mode.STRING && this.line > -1)\n       {\n         handler.setStartingLineNumber(this.line);\ndiff --git a/src/main/java/com/adobe/epubcheck/css/CSSHandler.java b/src/main/java/com/adobe/epubcheck/css/CSSHandler.java\nindex 67397c1..0899ba9 100644\n--- a/src/main/java/com/adobe/epubcheck/css/CSSHandler.java\n+++ b/src/main/java/com/adobe/epubcheck/css/CSSHandler.java\n@@ -24,6 +24,7 @@ import org.w3c.epubcheck.core.references.Reference;\n \n import com.adobe.epubcheck.api.EPUBLocation;\n import com.adobe.epubcheck.api.Report;\n+import com.adobe.epubcheck.css.CSSChecker.Mode;\n import com.adobe.epubcheck.messages.MessageId;\n import com.adobe.epubcheck.opf.OPFChecker;\n import com.adobe.epubcheck.opf.OPFChecker30;\n@@ -43,6 +44,7 @@ public class CSSHandler implements CssContentHandler, CssErrorHandler\n   final ValidationContext context;\n   final Report report;\n   final EPUBVersion version;\n+  final Mode mode;\n   int startingLineNumber = 0; // append to line info from css parser\n   int startingColumnNumber = 0;\n   static final CharMatcher SPACE_AND_QUOTES = CharMatcher.anyOf(\" \\t\\n\\r\\f\\\"'\").precomputed();\n@@ -64,11 +66,12 @@ public class CSSHandler implements CssContentHandler, CssErrorHandler\n   // properties the must be declared on the related OPF item\n   final Set<ITEM_PROPERTIES> detectedProperties = EnumSet.noneOf(ITEM_PROPERTIES.class);\n \n-  public CSSHandler(ValidationContext context)\n+  public CSSHandler(ValidationContext context, Mode mode)\n   {\n     this.context = context;\n     this.report = context.report;\n     this.version = context.version;\n+    this.mode = mode;\n     this.urlChecker = new URLChecker(context);\n   }\n \n@@ -447,17 +450,21 @@ public class CSSHandler implements CssContentHandler, CssErrorHandler\n           EPUBLocation.of(context).at(startingLineNumber, startingColumnNumber),\n           PackageVocabs.ITEM_VOCAB.getName(property));\n     }\n-\n-    // Check that properties declared in the OPF item were found in the content\n-    Set<ITEM_PROPERTIES> uncheckedProperties = Sets\n-        .difference(declaredProperties, detectedProperties)\n-        .copyInto(EnumSet.noneOf(ITEM_PROPERTIES.class));\n-    if (uncheckedProperties.contains(ITEM_PROPERTIES.REMOTE_RESOURCES))\n-    {\n-      uncheckedProperties.remove(ITEM_PROPERTIES.REMOTE_RESOURCES);\n-      report.message(MessageId.OPF_018,\n-          EPUBLocation.of(context).at(startingLineNumber, startingColumnNumber));\n+    \n+    if (mode == Mode.FILE) {\n+      // Check that properties declared in the OPF item were found in the content\n+      // We only check this for standalone CSS documents (not CSS inlined in HTML)\n+      Set<ITEM_PROPERTIES> uncheckedProperties = Sets\n+          .difference(declaredProperties, detectedProperties)\n+          .copyInto(EnumSet.noneOf(ITEM_PROPERTIES.class));\n+      if (uncheckedProperties.contains(ITEM_PROPERTIES.REMOTE_RESOURCES))\n+      {\n+        uncheckedProperties.remove(ITEM_PROPERTIES.REMOTE_RESOURCES);\n+        report.message(MessageId.OPF_018,\n+            EPUBLocation.of(context).at(startingLineNumber, startingColumnNumber));\n+      }\n     }\n+\n   }\n \n   public void setStartingLineNumber(int offset)\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..054410c\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/content_001.xhtml\n@@ -0,0 +1,17 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\"\n+\tlang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t\t<style>\n+\t\t\t@font-face {\n+\t\t\t  font-family: \"Open Sans\";\n+\t\t\t  src: url(\"https://example.org/font\") format(\"woff\");\n+\t\t\t}</style>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..9515dab\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"font\" href=\"https://example.org/font\" media-type=\"font/woff\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/mimetype b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-font-in-inline-css-missing-property-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..ffd82f6\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,17 @@\n+<!DOCTYPE html>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\"\n+\tlang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t\t<style>\n+\t\t\t.red {\n+\t\t\t  color: red;\n+\t\t\t}</style>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t\t<video src=\"https://example.org/video.mp4\"></video>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..1f9502b\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/EPUB/package.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"video\"  href=\"https://example.org/video.mp4\" media-type=\"video/mp4\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/mimetype b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-resource-and-inline-css-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/05-package-document/package-document.feature b/src/test/resources/epub3/05-package-document/package-document.feature\nindex 14eedc8..cf9991e 100644\n--- a/src/test/resources/epub3/05-package-document/package-document.feature\n+++ b/src/test/resources/epub3/05-package-document/package-document.feature\n@@ -535,6 +535,12 @@ Feature: EPUB 3 \u2014 Package document\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-item-resource-properties\n+  Scenario: Report a missing `remote-resources` property when inline CSS has remote references\n+    When checking EPUB 'package-remote-font-in-inline-css-missing-property-error'\n+    Then error OPF-014 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-item-resource-properties\n   Scenario: Report an SVG using remote fonts without the `remote-resource` property set in the package document\n     When checking EPUB 'package-remote-font-in-svg-missing-property-error'\n     Then error OPF-014 is reported\n@@ -570,6 +576,12 @@ Feature: EPUB 3 \u2014 Package document\n     Then error OPF-014 is reported\n     And no other errors or warnings are reported\n \n+  @spec @xref:sec-item-resource-properties\n+  Scenario: Verify that inline CSS does not trigger an unrequired `remote-resources` property error\n+    When checking EPUB 'package-remote-resource-and-inline-css-valid'\n+    Then no errors or warnings are reported\n+\n+\n   #####  scripted\n \n   @spec @xref:sec-item-resource-properties\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T21:50:57.074328Z", "commit_hash": "59036262f3d8358334ba42457f0fad326f774b2d", "commit_message": "fix: improve checking of missing SVG link labels, now USAGE\n\nThis commit changes the severity of error `ACC-011` to USAGE (was WARNING).\nLabelling links is not strictly a spec requirement, and checking for\nmissing labels should be done with specialized accessibility inspection.\n\nThe check is still available, with an improved logic: the link is\nreported as having a missing accessible label only if:\n- it does not have an `xlink:title` attribute\n- AND it does not have an `aria-label` attribute\n- AND it does not have a `title` element child\n- AND it does not have a `text` element child\n\nNote that his logic is incomplete, as it does not check that the content\nof `title` or `text` children is not empty. But reporting links that\nhave none of the above can be somewhat useful as a simplified first-pass\naccessibility check.\n\nFix #1353\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 8a2fbcf..10b4540 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -48,7 +48,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.ACC_008, Severity.SUPPRESSED);\n     severities.put(MessageId.ACC_009, Severity.USAGE);\n     severities.put(MessageId.ACC_010, Severity.SUPPRESSED);\n-    severities.put(MessageId.ACC_011, Severity.WARNING);\n+    severities.put(MessageId.ACC_011, Severity.USAGE);\n     severities.put(MessageId.ACC_012, Severity.SUPPRESSED);\n     severities.put(MessageId.ACC_013, Severity.SUPPRESSED);\n     severities.put(MessageId.ACC_014, Severity.SUPPRESSED);\ndiff --git a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\nindex 7e1c468..0594ab9 100644\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSHandler30.java\n@@ -93,7 +93,7 @@ public class OPSHandler30 extends OPSHandler\n   protected boolean inRegionBasedNav = false;\n   protected boolean isOutermostSVGAlreadyProcessed = false;\n   protected boolean hasAltorAnnotation = false;\n-  protected boolean hasTitle = false;\n+  protected boolean hasLabel = false;\n   protected boolean hasViewport = false;\n \n   static protected final String[] scriptEventsStrings = { \"onafterprint\", \"onbeforeprint\",\n@@ -399,7 +399,11 @@ public class OPSHandler30 extends OPSHandler\n     }\n     else if (\"http://www.w3.org/2000/svg\".equals(e.getNamespace()) && name.equals(\"title\"))\n     {\n-      hasTitle = true;\n+      hasLabel = true;\n+    }\n+    else if (\"http://www.w3.org/2000/svg\".equals(e.getNamespace()) && name.equals(\"text\"))\n+    {\n+      hasLabel = true;\n     }\n \n     processInlineScripts();\n@@ -491,8 +495,9 @@ public class OPSHandler30 extends OPSHandler\n     }\n     if (inSvg || context.mimeType.equals(\"image/svg+xml\"))\n     {\n-      hasTitle = Strings\n-          .emptyToNull(e.getAttributeNS(EpubConstants.XLinkNamespaceUri, \"title\")) != null;\n+      String title = e.getAttributeNS(EpubConstants.XLinkNamespaceUri, \"title\");\n+      String ariaLabel = e.getAttribute(\"aria-label\");\n+      hasLabel = !Strings.isNullOrEmpty(title) || !Strings.isNullOrEmpty(ariaLabel);\n     }\n   }\n \n@@ -866,7 +871,7 @@ public class OPSHandler30 extends OPSHandler\n         report.message(MessageId.ACC_004, location().context(\"a\"));\n         anchorNeedsText = false;\n       }\n-      if ((inSvg || context.mimeType.equals(\"image/svg+xml\")) && !hasTitle)\n+      if ((inSvg || context.mimeType.equals(\"image/svg+xml\")) && !hasLabel)\n       {\n         report.message(MessageId.ACC_011, location().context(e.getName()));\n       }\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 71af750..cd32188 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -14,7 +14,7 @@ ACC_007=Content Documents do not use \"epub:type\" attributes for semantic inflect\n ACC_008=Navigation Document has no \"landmarks nav\" element.\n ACC_009=MathML should either have an \"alttext\" attribute or \"annotation-xml\" child element.\n ACC_010=Headings should not be used within blockquote and figure elements.\n-ACC_011=SVG hyperlinks should have a human-readable title (using the \"title\" child element or the \"xlink:title\" attribute).\n+ACC_011=SVG hyperlink has no accessible name\n ACC_012=Table elements should include a caption element.\n ACC_013=Content file contains at least one inline style declaration.\n ACC_013_SUG=Inline styles are not compatible with accessibility settings and display personalization. Use CSS Styles instead.\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-label-valid.svg b/src/test/resources/epub3/06-content-document/files/link-label-valid.svg\nnew file mode 100644\nindex 0000000..ac17350\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/link-label-valid.svg\n@@ -0,0 +1,23 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n+\txmlns:xlink=\"http://www.w3.org/1999/xlink\" xml:lang=\"en\">\n+\t<title>Links require a title</title>\n+\t<desc>Example rect01 - rectangle with sharp corners </desc>\n+\t<a xlink:href=\"doc.xhtml\" target=\"ch1\" xlink:title=\"label from title atttribute\">\n+\t\t<rect width=\"50\" height=\"50\"/>\n+\t</a>\n+\t<a xlink:href=\"doc.xhtml\" target=\"ch1\">\n+\t\t<title>label from title element</title>\n+\t\t<rect width=\"50\" height=\"50\"/>\n+\t</a>\n+\t<a xlink:href=\"doc.xhtml\" target=\"ch1\" aria-label=\"label from aria-label\">\n+\t\t<rect width=\"50\" height=\"50\"/>\n+\t</a>\n+\t<a xlink:href=\"doc.xhtml\" target=\"ch1\">\n+\t\t<text>label from text</text>\n+\t</a>\n+\t<a xlink:href=\"doc.xhtml\" target=\"ch1\">\n+\t\t<!-- no label, a usage is reported -->\n+\t\t<rect width=\"50\" height=\"50\"/>\n+\t</a>\n+</svg>\n", "test_patch": "diff --git a/src/test/java/org/w3c/epubcheck/test/AssertionSteps.java b/src/test/java/org/w3c/epubcheck/test/AssertionSteps.java\nindex 06e758e..42b9d79 100644\n--- a/src/test/java/org/w3c/epubcheck/test/AssertionSteps.java\n+++ b/src/test/java/org/w3c/epubcheck/test/AssertionSteps.java\n@@ -40,6 +40,12 @@ public class AssertionSteps\n     assertThat(\"Unexpected warning\", report.getAll(Severity.WARNING), is(emptyIterable()));\n   }\n \n+  @Then(\"no( other) usage(s) are/is reported\")\n+  public void assertNoUsage()\n+  {\n+    assertThat(\"Unexpected usage\", report.getAll(Severity.USAGE), is(emptyIterable()));\n+  }\n+\n   /*\n    * Common step definition for \"is reported\" and \"is reported {int} times\" see\n    * https://github.com/cucumber/cucumber-expressions/issues/166\ndiff --git a/src/test/resources/epub3/06-content-document/content-document-svg.feature b/src/test/resources/epub3/06-content-document/content-document-svg.feature\nindex 4ee6b69..8b0d8b5 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-svg.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-svg.feature\n@@ -84,9 +84,11 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 SVG\n     When checking document 'link-valid.svg'\n     Then no errors or warnings are reported\n \n-  Scenario: Report SVG link without a title\n-    When checking document 'link-no-title-error.svg'\n-    Then warning ACC-011 is reported\n+  Scenario: Report SVG link without a label as usage\n+    Given the reporting level is set to usage\n+    When checking document 'link-label-valid.svg'\n+    Then usage ACC-011 is reported\n+    And no other usages are reported\n     And no other errors or warnings are reported\n \n   Scenario: Verify that `image` elements can have an `xlink:href` URL pointing to a fragment \ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex 823542b..81ceefb 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -961,12 +961,6 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n     And the message contains 'element \"foo\" not allowed here'\n     And no other errors or warnings are reported\n \n-  #TODO review if this warning is relevant\n-  Scenario: Report an SVG link without a recommended title\n-    When checking document 'svg-links-no-title-warning.xhtml'\n-    Then warning ACC-011 is reported\n-    And no other errors or warnings are reported\n-\n   Scenario: Verify unprefixed HTML elements allowed inside prefixed `foreignObject`\n     When checking document 'svg-foreignObject-valid.xhtml'\n     Then no errors or warnings are reported\ndiff --git a/src/test/resources/epub3/06-content-document/files/link-no-title-error.svg b/src/test/resources/epub3/06-content-document/files/link-no-title-error.svg\ndeleted file mode 100644\nindex 31a1ce6..0000000\n--- a/src/test/resources/epub3/06-content-document/files/link-no-title-error.svg\n+++ /dev/null\n@@ -1,9 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n-\txmlns:xlink=\"http://www.w3.org/1999/xlink\" xml:lang=\"en\">\n-\t<title>Links require a title</title>\n-\t<desc>Example rect01 - rectangle with sharp corners </desc>\n-\t<a xlink:href=\"doc.xhtml\" target=\"ch1\">\n-\t\t<text>link</text>\n-\t</a>\n-</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-links-no-title-warning.xhtml b/src/test/resources/epub3/06-content-document/files/svg-links-no-title-warning.xhtml\ndeleted file mode 100644\nindex 904738d..0000000\n--- a/src/test/resources/epub3/06-content-document/files/svg-links-no-title-warning.xhtml\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>SVG link without title</title>\n-\t\t<link type=\"text/css\" rel=\"stylesheet\" href=\"lorem.css\" />\n-\t</head>\n-\t<body>\n-\t\t<h1>SVG test</h1>\n-\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"\n-\t\t\txmlns:x=\"http://www.w3.org/1999/xhtml\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n-\t\t\t<title>Rectangle</title>\n-\t\t\t<desc>Example rect01 - rectangle with sharp corners </desc>\n-\n-\t\t\t<a xlink:href=\"doc.xhtml\" target=\"ch1\">\n-\t\t\t\t<text>link</text>\n-\t\t\t</a>\n-\t\t</svg>\n-\t</body>\n-</html>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T22:06:33.410328Z", "commit_hash": "7eb5ff250ad72f21211f42d9c78ffe2cbfc998cc", "commit_message": "feat: warn about non-HTTPS remote resource references\n\nThis commit introduces a new check `RSC-031` (warning) that is reported\nwhen a reference to a remote resource (font, audio, video) is not using\nHTTPS.\n\nFix #1337\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex aaa61f9..8a2fbcf 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -347,6 +347,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.RSC_028, Severity.ERROR);\n     severities.put(MessageId.RSC_029, Severity.ERROR);\n     severities.put(MessageId.RSC_030, Severity.ERROR);\n+    severities.put(MessageId.RSC_031, Severity.WARNING);\n \n     // Scripting\n     severities.put(MessageId.SCP_001, Severity.SUPPRESSED); // checking scripts is out of scope\ndiff --git a/src/main/java/com/adobe/epubcheck/messages/MessageId.java b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\nindex c1f2a61..cb09399 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n@@ -341,6 +341,7 @@ public enum MessageId implements Comparable<MessageId>\n   RSC_028(\"RSC-028\"),\n   RSC_029(\"RSC-029\"),\n   RSC_030(\"RSC-030\"),\n+  RSC_031(\"RSC-031\"),\n \n   // Messages relating to scripting\n   SCP_001(\"SCP-001\"),\ndiff --git a/src/main/java/com/adobe/epubcheck/opf/XRefChecker.java b/src/main/java/com/adobe/epubcheck/opf/XRefChecker.java\nindex 731841f..b284c83 100755\n--- a/src/main/java/com/adobe/epubcheck/opf/XRefChecker.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/XRefChecker.java\n@@ -286,7 +286,7 @@ public class XRefChecker\n    * Returns set (possibly multiple) types of references to the given resource\n    * \n    * @param path\n-   *          the path to a publication resource\n+   *        the path to a publication resource\n    * @return an immutable {@link EnumSet} containing the types of references to\n    *           {@code path}.\n    */\n@@ -428,24 +428,38 @@ public class XRefChecker\n     URLFragment fragment = URLFragment.parse(reference.url, targetMimetype);\n \n     // Check remote resources\n-    if (container.isRemote(reference.url)\n-        // remote links and hyperlinks are not Publication Resources\n-        && !EnumSet.of(Type.LINK, Type.HYPERLINK).contains(reference.type)\n-        // spine items are checked in OPFChecker30\n-        && !(version == EPUBVersion.VERSION_3 && targetResource != null\n-            && targetResource.isInSpine())\n-        // audio, video, and fonts can be remote resources in EPUB 3\n-        && !(version == EPUBVersion.VERSION_3 && (targetResource != null\n-            // if the item is declared, check its mime type\n-            && (OPFChecker30.isAudioType(targetResource.getMimeType())\n-                || OPFChecker30.isVideoType(targetResource.getMimeType())\n-                || OPFChecker30.isFontType(targetResource.getMimeType()))\n-            // else, check if the reference is a type allowing remote resources\n-            || reference.type == Type.FONT || reference.type == Type.AUDIO\n-            || reference.type == Type.VIDEO)))\n+    if (container.isRemote(reference.url))\n     {\n-      report.message(MessageId.RSC_006, reference.location.context(reference.targetDoc.toString()));\n-      return;\n+      // Check if the remote reference is allowed\n+      if (// remote links and hyperlinks are not Publication Resources\n+      !EnumSet.of(Type.LINK, Type.HYPERLINK).contains(reference.type)\n+          // spine items are checked in OPFChecker30\n+          && !(version == EPUBVersion.VERSION_3 && targetResource != null\n+              && targetResource.isInSpine())\n+          // audio, video, and fonts can be remote resources in EPUB 3\n+          && !(version == EPUBVersion.VERSION_3 && (targetResource != null\n+              // if the item is declared, check its mime type\n+              && (OPFChecker30.isAudioType(targetResource.getMimeType())\n+                  || OPFChecker30.isVideoType(targetResource.getMimeType())\n+                  || OPFChecker30.isFontType(targetResource.getMimeType()))\n+              // else, check if the reference is a type allowing remote\n+              // resources\n+              || reference.type == Type.FONT || reference.type == Type.AUDIO\n+              || reference.type == Type.VIDEO)))\n+      {\n+        report.message(MessageId.RSC_006,\n+            reference.location.context(reference.targetDoc.toString()));\n+        return;\n+      }\n+      // Check if the remote resource is using HTTPS\n+      else if (version == EPUBVersion.VERSION_3\n+          && !EnumSet.of(Type.LINK, Type.HYPERLINK).contains(reference.type)\n+          && !\"https\".equals(reference.url.scheme())\n+          // file URLs are disallowed and reported elsewhere\n+          && !\"file\".equals(reference.url.scheme()))\n+      {\n+        report.message(MessageId.RSC_031, reference.location, reference.url);\n+      }\n     }\n \n     // Check undeclared resources\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 638f73a..71af750 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -356,6 +356,7 @@ RSC_027=XML document is encoded in UTF-16. It should be encoded in UTF-8 instead\n RSC_028=XML documents must be encoded in UTF-8, but %1%s was detected.\n RSC_029=Data URL is not allowed in this context.\n RSC_030=File URLs are not allowed in EPUB, but found \"%1$s\".\n+RSC_031=Remote resource references should use HTTPS, but found \"%1$s\".\n \n #Scripting\n SCP_001=Use of Javascript eval() function in EPUB scripts is a security risk.\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..2adfccf\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<audio src=\"http://example.org/audio.mp4\" /><!--not https-->\n+\t\t<video src=\"http://example.org/video.mp4\" /><!--not https-->\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/nav.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/package.opf\nnew file mode 100644\nindex 0000000..f9263ed\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/package.opf\n@@ -0,0 +1,20 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n+  <item id=\"css\"  href=\"style.css\" media-type=\"text/css\" properties=\"remote-resources\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  <item id=\"audio\" href=\"http://example.org/audio.mp4\" media-type=\"audio/mp4\" />\n+  <item id=\"font\"  href=\"http://example.org/font\" media-type=\"font/woff\"/>\n+  <item id=\"video\" href=\"http://example.org/video.mp4\" media-type=\"video/mp4\" />\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/style.css b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/style.css\nnew file mode 100644\nindex 0000000..70c5f49\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/EPUB/style.css\n@@ -0,0 +1,4 @@\n+@font-face {\n+  font-family: \"Open Sans\";\n+  src: url(\"http://example.org/font\") format(\"woff\");\n+}\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/META-INF/container.xml b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/META-INF/container.xml\nnew file mode 100644\nindex 0000000..3187821\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/mimetype b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-not-https-warning/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/content_001.xhtml\nindex ae3a9a5..423cb5f 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/content_001.xhtml\n@@ -7,8 +7,8 @@\n \t<body>\n \t\t<!-- remote audio sources, one in a foreign type -->\n \t\t<audio>\n-\t\t\t<source src=\"http://example.org/remote.foo\" />\n-\t\t\t<source src=\"http://example.org/remote.mp4\" />\n+\t\t\t<source src=\"https://example.org/remote.foo\" />\n+\t\t\t<source src=\"https://example.org/remote.mp4\" />\n \t\t</audio>\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/package.opf\nindex 4b20aba..0565831 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-foreign-valid/EPUB/package.opf\n@@ -9,8 +9,8 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"audio\" href=\"http://example.org/remote.foo\" media-type=\"audio/foo\"/>\n-  <item id=\"audio-fallback\" href=\"http://example.org/remote.mp4\" media-type=\"audio/mp4\" /></manifest>\n+  <item id=\"audio\" href=\"https://example.org/remote.foo\" media-type=\"audio/foo\"/>\n+  <item id=\"audio-fallback\" href=\"https://example.org/remote.mp4\" media-type=\"audio/mp4\" /></manifest>\n <spine>\n   <itemref idref=\"content_001\" />\n </spine>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/content_001.xhtml\nindex 468f27d..4dd8997 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/content_001.xhtml\n@@ -6,8 +6,8 @@\n \t</head>\n \t<body>\n \t\t<audio controls=\"controls\">\n-\t\t\t<source src=\"http://example.com/audio/src-1.mp4\" type=\"audio/mp4\"/>\n-\t\t\t<source src=\"http://example.com/audio/src-2.mp4\" type=\"audio/mp4\"/>\n+\t\t\t<source src=\"https://example.com/audio/src-1.mp4\" type=\"audio/mp4\"/>\n+\t\t\t<source src=\"https://example.com/audio/src-2.mp4\" type=\"audio/mp4\"/>\n \t\t</audio>\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/package.opf\nindex fca255a..c7d629d 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-audio-sources-valid/EPUB/package.opf\n@@ -9,8 +9,8 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"audio1\" href=\"http://example.com/audio/src-1.mp4\" media-type=\"audio/mp4\" />\n-  <item id=\"audio2\" href=\"http://example.com/audio/src-2.mp4\" media-type=\"audio/mp4\" />\n+  <item id=\"audio1\" href=\"https://example.com/audio/src-1.mp4\" media-type=\"audio/mp4\" />\n+  <item id=\"audio2\" href=\"https://example.com/audio/src-2.mp4\" media-type=\"audio/mp4\" />\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/content_001.xhtml\nindex 6499dbd..0e388c2 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/content_001.xhtml\n@@ -5,11 +5,9 @@\n \t\t<title>Minimal EPUB</title>\n \t</head>\n \t<body>\n-\t\t<!-- remote http URL -->\n-\t\t<audio src=\"http://example.org/remote.mp4\" />\n \t\t<!-- remote https URL -->\n \t\t<audio src=\"https://example.org/remote.mp4\" />\n \t\t<!-- remote URL with query -->\n-\t\t<audio src=\"http://example.org/remote.mp4?test\" />\n+\t\t<audio src=\"https://example.org/remote.mp4?test\" />\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/package.opf\nindex a3b3858..888dc39 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-audio-valid/EPUB/package.opf\n@@ -9,9 +9,8 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"audio-1\" href=\"http://example.org/remote.mp4\" media-type=\"audio/mp4\" />\n-  <item id=\"audio-2\" href=\"https://example.org/remote.mp4\" media-type=\"audio/mp4\" />\n-  <item id=\"audio-3\" href=\"http://example.org/remote.mp4?test\" media-type=\"audio/mp4\" />\n+  <item id=\"audio-1\" href=\"https://example.org/remote.mp4\" media-type=\"audio/mp4\" />\n+  <item id=\"audio-2\" href=\"https://example.org/remote.mp4?test\" media-type=\"audio/mp4\" />\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/content_001.xhtml\nindex df96b74..17cdfeb 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/content_001.xhtml\n@@ -5,11 +5,9 @@\n \t\t<title>Minimal EPUB</title>\n \t</head>\n \t<body>\n-\t\t<!-- remote http URL -->\n-\t\t<video src=\"http://example.org/remote.mp4\" />\n \t\t<!-- remote https URL -->\n \t\t<video src=\"https://example.org/remote.mp4\" />\n \t\t<!-- remote URL with query -->\n-\t\t<video src=\"http://example.org/remote.mp4?test\" />\n+\t\t<video src=\"https://example.org/remote.mp4?test\" />\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/package.opf\nindex a67adf2..f431107 100644\n--- a/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/03-resources/files/resources-remote-video-valid/EPUB/package.opf\n@@ -9,9 +9,8 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"video-1\" href=\"http://example.org/remote.mp4\" media-type=\"video/mp4\" />\n-  <item id=\"video-2\" href=\"https://example.org/remote.mp4\" media-type=\"video/mp4\" />\n-  <item id=\"video-3\" href=\"http://example.org/remote.mp4?test\" media-type=\"video/mp4\" />\n+  <item id=\"video-1\" href=\"https://example.org/remote.mp4\" media-type=\"video/mp4\" />\n+  <item id=\"video-2\" href=\"https://example.org/remote.mp4?test\" media-type=\"video/mp4\" />\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\ndiff --git a/src/test/resources/epub3/03-resources/resources.feature b/src/test/resources/epub3/03-resources/resources.feature\nindex 16a8080..febcfb5 100644\n--- a/src/test/resources/epub3/03-resources/resources.feature\n+++ b/src/test/resources/epub3/03-resources/resources.feature\n@@ -385,6 +385,12 @@\n     Then error RSC-006 is reported\n     And no other errors or warnings are reported\n \n+  @spec @xref:sec-resource-locations\n+  Scenario: Warn about a remote resource with a non `https` URL\n+    When checking EPUB 'resources-remote-not-https-warning'\n+    Then warning RSC-031 is reported 3 times\n+    And no other errors or warnings are reported\n+\n   ## 3.7 Data URLs\n \n   @spec @xref:sec-data-urls\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/content_001.xhtml\nindex 0f815c5..cefdcff 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/content_001.xhtml\n@@ -5,7 +5,7 @@\n \t\t<title>Minimal EPUB</title>\n \t</head>\n \t<body>\n-\t\t<video src=\"http://test.com/lorem.ogg\" width=\"640\" height=\"360\" controls=\"controls\">\n+\t\t<video src=\"https://example.org/lorem.ogg\" width=\"640\" height=\"360\" controls=\"controls\">\n \t\t\tYour reader doesn't support video!\n \t\t</video>\n \t</body>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/package.opf\nindex 805380e..90382fd 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/05-package-document/files/package-manifest-prop-remote-resource-undeclared-error/EPUB/package.opf\n@@ -9,7 +9,7 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"video\" href=\"http://test.com/lorem.ogg\" media-type=\"video/ogg\" />\n+  <item id=\"video\" href=\"https://example.org/lorem.ogg\" media-type=\"video/ogg\" />\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/chapter_001_overlay.smil b/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/chapter_001_overlay.smil\nindex 1cd90b9..3ede33d 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/chapter_001_overlay.smil\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/chapter_001_overlay.smil\n@@ -2,7 +2,7 @@\n \t<body>\n \t\t<par id=\"heading1\">\n \t\t\t<text src=\"content_001.xhtml#hd01\"/>\n-\t\t\t<audio src=\"http://example.com/audio/c001.mp4\" clipBegin=\"0:00:24.500\"/>\n+\t\t\t<audio src=\"https://example.com/audio/c001.mp4\" clipBegin=\"0:00:24.500\"/>\n \t\t</par>\n \t</body>\n </smil>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/package.opf\nindex b3ab927..5152524 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-in-overlays-missing-property-error/EPUB/package.opf\n@@ -12,7 +12,7 @@\n <manifest>\n \t<item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" media-overlay=\"chapter_001_overlay\"/>\n \t<item id=\"chapter_001_overlay\" href=\"chapter_001_overlay.smil\" media-type=\"application/smil+xml\"/>\n-\t<item id=\"chapter_001_audio\" href=\"http://example.com/audio/c001.mp4\" media-type=\"audio/mp4\"/>\n+\t<item id=\"chapter_001_audio\" href=\"https://example.com/audio/c001.mp4\" media-type=\"audio/mp4\"/>\n \t<item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n </manifest>\n <spine>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/content_001.xhtml\nindex 8971bbb..9076e74 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/content_001.xhtml\n@@ -6,6 +6,6 @@\n \t</head>\n \t<body>\n \t\t<!-- remote http URL -->\n-\t\t<audio src=\"http://example.org/remote.mp4\" />\n+\t\t<audio src=\"https://example.org/remote.mp4\" />\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/package.opf\nindex 507046b..130b19a 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-missing-property-error/EPUB/package.opf\n@@ -9,7 +9,7 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"audio\" href=\"http://example.org/remote.mp4\" media-type=\"audio/mp4\"/>\n+  <item id=\"audio\" href=\"https://example.org/remote.mp4\" media-type=\"audio/mp4\"/>\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/content_001.xhtml\nindex 468f27d..4dd8997 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/content_001.xhtml\n@@ -6,8 +6,8 @@\n \t</head>\n \t<body>\n \t\t<audio controls=\"controls\">\n-\t\t\t<source src=\"http://example.com/audio/src-1.mp4\" type=\"audio/mp4\"/>\n-\t\t\t<source src=\"http://example.com/audio/src-2.mp4\" type=\"audio/mp4\"/>\n+\t\t\t<source src=\"https://example.com/audio/src-1.mp4\" type=\"audio/mp4\"/>\n+\t\t\t<source src=\"https://example.com/audio/src-2.mp4\" type=\"audio/mp4\"/>\n \t\t</audio>\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/package.opf\nindex da6e0e1..4862980 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-sources-undeclared-error/EPUB/package.opf\n@@ -9,7 +9,7 @@\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-  <item id=\"audio1\" href=\"http://example.com/audio/src-1.mp4\" media-type=\"audio/mp4\" />\n+  <item id=\"audio1\" href=\"https://example.com/audio/src-1.mp4\" media-type=\"audio/mp4\" />\n   <!--<item id=\"audio2\" href=\"http://example.com/audio/src-2.mp4\" media-type=\"audio/mp4\" />-->\n </manifest>\n <spine>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-remote-audio-undeclared-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-remote-audio-undeclared-error/EPUB/content_001.xhtml\nindex 8971bbb..9076e74 100644\n--- a/src/test/resources/epub3/05-package-document/files/package-remote-audio-undeclared-error/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/05-package-document/files/package-remote-audio-undeclared-error/EPUB/content_001.xhtml\n@@ -6,6 +6,6 @@\n \t</head>\n \t<body>\n \t\t<!-- remote http URL -->\n-\t\t<audio src=\"http://example.org/remote.mp4\" />\n+\t\t<audio src=\"https://example.org/remote.mp4\" />\n \t</body>\n </html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/content_001.xhtml b/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/content_001.xhtml\nindex 6eea293..9e6af43 100644\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/content_001.xhtml\n@@ -5,7 +5,7 @@\n \t\t<title>Minimal EPUB</title>\n \t</head>\n \t<body>\n-\t\t<video src=\"http://test.com/lorem.ogg\" width=\"640\" height=\"360\" controls=\"controls\" poster=\"poster.png\">\n+\t\t<video src=\"https://example.org/lorem.ogg\" width=\"640\" height=\"360\" controls=\"controls\" poster=\"poster.png\">\n \t\t\t\n \t\t</video>\n \t</body>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/package.opf b/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/package.opf\nindex 784361d..ea5a493 100644\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/package.opf\n+++ b/src/test/resources/epub3/06-content-document/files/content-xhtml-video-poster-media-type-error/EPUB/package.opf\n@@ -10,7 +10,7 @@\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\" properties=\"remote-resources\"/>\n   <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n   <item id=\"poster\" href=\"poster.png\" media-type=\"text/abc\" />\n-  <item id=\"video\" href=\"http://test.com/lorem.ogg\" media-type=\"video/ogg\" />\n+  <item id=\"video\" href=\"https://example.org/lorem.ogg\" media-type=\"video/ogg\" />\n </manifest>\n <spine>\n   <itemref idref=\"content_001\" />\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T22:14:31.552642Z", "commit_hash": "f3e5f673ef47c4317a9b61d4d8ad05c059ec28c0", "commit_message": "feat: allow NCX documents to declare a doctype\n\nFix #1329\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/xml/handlers/DeclarationHandler.java b/src/main/java/com/adobe/epubcheck/xml/handlers/DeclarationHandler.java\nindex aab950a..732cca9 100644\n--- a/src/main/java/com/adobe/epubcheck/xml/handlers/DeclarationHandler.java\n+++ b/src/main/java/com/adobe/epubcheck/xml/handlers/DeclarationHandler.java\n@@ -134,6 +134,10 @@ public class DeclarationHandler extends LocationHandler\n           isAllowed = \"-//W3C//DTD MathML 3.0//EN\".equals(publicId)\n               && \"http://www.w3.org/Math/DTD/mathml3/mathml3.dtd\".equals(systemId);\n           break;\n+        case \"application/x-dtbncx+xml\":\n+          isAllowed = \"-//NISO//DTD ncx 2005-1//EN\".equals(publicId)\n+              && \"http://www.daisy.org/z3986/2005/ncx-2005-1.dtd\".equals(systemId);\n+          break;\n         default:\n           isAllowed = false;\n         }\ndiff --git a/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/nav.ncx b/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/nav.ncx\nnew file mode 100644\nindex 0000000..ea192b3\n--- /dev/null\n+++ b/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/nav.ncx\n@@ -0,0 +1,24 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!DOCTYPE math PUBLIC \"-//NISO//DTD ncx 2005-1//EN\" \"http://www.daisy.org/z3986/2005/ncx-2005-1.dtd\">\n+<ncx xmlns:ncx=\"http://www.daisy.org/z3986/2005/ncx/\"\n+  xmlns=\"http://www.daisy.org/z3986/2005/ncx/\"\n+  version=\"2005-1\"\n+  xml:lang=\"en\">\n+  <head>\n+    <meta name=\"dtb:uid\" content=\"NOID\"/>\n+    <meta name=\"dtb:depth\" content=\"1\"/>\n+    <meta name=\"dtb:totalPageCount\" content=\"0\"/>\n+    <meta name=\"dtb:maxPageNumber\" content=\"0\"/>\n+  </head>\n+  <docTitle>\n+    <text>NCX</text>\n+  </docTitle>\n+  <navMap>\n+    <navPoint id=\"ch1\" playOrder=\"1\">\n+      <navLabel>\n+        <text>Chapter 1</text>\n+      </navLabel>\n+      <content src=\"content_001.xhtml\"/>\n+    </navPoint>\n+  </navMap>\n+</ncx>\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/B-external-identifiers/external-identifiers.feature b/src/test/resources/epub3/B-external-identifiers/external-identifiers.feature\nindex 59fbf7a..55dc4fa 100644\n--- a/src/test/resources/epub3/B-external-identifiers/external-identifiers.feature\n+++ b/src/test/resources/epub3/B-external-identifiers/external-identifiers.feature\n@@ -10,7 +10,7 @@\n     Given EPUB test files located at '/epub3/B-external-identifiers/files/'\n     And EPUBCheck with default settings\n \n-\n+  @spec @xref:app-identifiers-allowed\n   Scenario: Verify DOCTYPE declarations with allowed external identifiers\n     When checking EPUB 'xml-external-identifier-allowed-valid'\n     Then no errors or warnings are reported\ndiff --git a/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/package.opf b/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/package.opf\nindex f891092..a71e6bc 100644\n--- a/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/package.opf\n+++ b/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-allowed-valid/EPUB/package.opf\n@@ -13,8 +13,9 @@\n   <item id=\"mathml-2\" href=\"mathml-mediatype-2.xml\" media-type=\"application/mathml-presentation+xml\" fallback=\"content_001\"/>\n   <item id=\"mathml-3\" href=\"mathml-mediatype-3.xml\" media-type=\"application/mathml-content+xml\" fallback=\"content_001\"/>\n   <item id=\"svg\" href=\"svg.svg\" media-type=\"image/svg+xml\"/>\n+  <item id=\"ncx\" href=\"nav.ncx\" media-type=\"application/x-dtbncx+xml\" />\n </manifest>\n-<spine>\n+<spine toc=\"ncx\">\n   <itemref idref=\"content_001\" />\n   <itemref idref=\"svg\"/>\n   <itemref idref=\"mathml-1\"/>\ndiff --git a/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-disallowed-error/EPUB/toc.ncx b/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-disallowed-error/EPUB/toc.ncx\nindex ce9cf9f..eb36eaa 100644\n--- a/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-disallowed-error/EPUB/toc.ncx\n+++ b/src/test/resources/epub3/B-external-identifiers/files/xml-external-identifier-disallowed-error/EPUB/toc.ncx\n@@ -1,5 +1,5 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<!DOCTYPE ncx PUBLIC \"-//NISO//DTD ncx 2005-1//EN\" \"http://www.daisy.org/z3986/2005/ncx-2005-1.dtd\">\n+<!DOCTYPE ncx PUBLIC \"-//NISO//DTD ncx 2005-1//EN\" \"http://example.org/dtd\">\n <ncx xmlns:ncx=\"http://www.daisy.org/z3986/2005/ncx/\"\n     xmlns=\"http://www.daisy.org/z3986/2005/ncx/\"\n     version=\"2005-1\"\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T22:22:53.802584Z", "commit_hash": "e64c7c5620dc39696324f8680c38c463a7e7f4b8", "commit_message": "feat: allow 1s tolerance for media overlays duration sum check\n\nFix #1328\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\nindex f249a11..a8b7fd9 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFChecker30.java\n@@ -439,7 +439,7 @@ public class OPFChecker30 extends OPFChecker\n           }\n         }\n         // report if the sum and total don't match\n-        if (!totalDuration.equals(sumDuration))\n+        if (!totalDuration.eqWithinTolerance(sumDuration, 1000))\n         {\n           report.message(MessageId.MED_016, EPUBLocation.of(context));\n         }\ndiff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-within-tolerance-valid.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-within-tolerance-valid.opf\nnew file mode 100644\nindex 0000000..bc7106c\n--- /dev/null\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-within-tolerance-valid.opf\n@@ -0,0 +1,22 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" unique-identifier=\"uid\"\n+    xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <metadata>\n+        <dc:title>Title</dc:title>\n+        <dc:language>en</dc:language>\n+        <dc:identifier id=\"uid\">NOID</dc:identifier>\n+        <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n+        <!-- Media Overlays Duration Properties -->\n+        <meta property=\"media:duration\">10min</meta>\n+        <meta refines=\"#mo001\" property=\"media:duration\">5min</meta>\n+        <meta refines=\"#mo002\" property=\"media:duration\">0:05:00.500</meta>\n+    </metadata>\n+    <manifest>\n+        <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\n+        <item id=\"mo001\" href=\"mediaoverlay_001.smil\" media-type=\"application/smil+xml\"/>\n+        <item id=\"mo002\" href=\"mediaoverlay_002.smil\" media-type=\"application/smil+xml\"/>\n+    </manifest>\n+    <spine>\n+        <itemref idref=\"t001\"/>\n+    </spine>\n+</package>\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-not-sum-warning.opf b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-not-sum-warning.opf\nindex 42b376c..85f9f0d 100644\n--- a/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-not-sum-warning.opf\n+++ b/src/test/resources/epub3/09-media-overlays/files/mediaoverlays-duration-total-not-sum-warning.opf\n@@ -9,7 +9,7 @@\n         <!-- Media Overlays Duration Properties -->\n         <meta property=\"media:duration\">10min</meta>\n         <meta refines=\"#mo001\" property=\"media:duration\">5min</meta>\n-        <meta refines=\"#mo002\" property=\"media:duration\">0:05:00.200</meta>\n+        <meta refines=\"#mo002\" property=\"media:duration\">0:05:01.100</meta>\n     </metadata>\n     <manifest>\n         <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\ndiff --git a/src/test/resources/epub3/09-media-overlays/media-overlays.feature b/src/test/resources/epub3/09-media-overlays/media-overlays.feature\nindex 0e9eb7a..4727303 100644\n--- a/src/test/resources/epub3/09-media-overlays/media-overlays.feature\n+++ b/src/test/resources/epub3/09-media-overlays/media-overlays.feature\n@@ -316,7 +316,13 @@ Feature: EPUB 3 \u2014 Media Overlays\n     And the message contains \"item media:duration meta element not set\"\n     And no other errors or warnings are reported\n \n+  @spec @xref:sec-mo-package-metadata\n   Scenario: the total duration should be the sum of all Media Overlay durations\n     When checking file 'mediaoverlays-duration-total-not-sum-warning.opf'\n     Then warning MED-016 is reported\n     And no other errors or warnings are reported\n+\n+  @spec @xref:sec-mo-package-metadata\n+  Scenario: the total duration has a 1s tolerance\n+    When checking file 'mediaoverlays-duration-total-within-tolerance-valid.opf'\n+    Then no errors or warnings are reported\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T22:40:17.683065Z", "commit_hash": "8eb849250bae7b595bbd0a2de95ef46ab39efb0c", "commit_message": "feat: no longer check collection `role`\n\nThis commit suppresses and removes the code of the following checks:\n- `OPF-068`: checked that a role token were one the defined roles in\n  the collection role registry\n  (see https://idpf.github.io/epub-registries/roles/)\n- `OPF-069`: checked that a custom role URL did not contain the string\n  \"idpf.org\".\n\nThese restrictions were removed in EPUB 3.3.\n\nThe attribute value is still tokenized, and any URL-looking string\n  (in the shape `scheme:something`) is checked to be a valid URL string.\n\nFix #1350.\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 613b8c5..aaa61f9 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -257,8 +257,8 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.OPF_065, Severity.ERROR);\n     severities.put(MessageId.OPF_066, Severity.ERROR);\n     severities.put(MessageId.OPF_067, Severity.ERROR);\n-    severities.put(MessageId.OPF_068, Severity.ERROR);\n-    severities.put(MessageId.OPF_069, Severity.ERROR);\n+    severities.put(MessageId.OPF_068, Severity.SUPPRESSED);\n+    severities.put(MessageId.OPF_069, Severity.SUPPRESSED);\n     severities.put(MessageId.OPF_070, Severity.WARNING);\n     severities.put(MessageId.OPF_071, Severity.ERROR);\n     severities.put(MessageId.OPF_072, Severity.USAGE);\ndiff --git a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\nindex a6055fc..d5592ff 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n@@ -407,36 +407,16 @@ public class OPFHandler30 extends OPFHandler\n       if (URLUtils.isAbsoluteURLString(role))\n       {\n         // Role is an absolute IRI\n-        // check that the host component doesn't contain 'idpf.org'\n         try\n         {\n-          URL url = URL.parse(role);\n-          if (url.authority() != null && url.authority().contains(\"idpf.org\"))\n-          {\n-            report.message(MessageId.OPF_069, location(), role);\n-          }\n-          else\n-          {\n-            rolesBuilder.add(role);\n-          }\n+          URL.parse(role);\n         } catch (GalimatiasParseException e)\n         {\n           report.message(MessageId.OPF_070, location(), role);\n+          break;\n         }\n       }\n-      else\n-      {\n-        // Role is a NMTOKEN\n-        // Check that it's in the reserved role list\n-        if (ResourceCollection.Roles.fromString(role).isPresent())\n-        {\n-          rolesBuilder.add(role);\n-        }\n-        else\n-        {\n-          report.message(MessageId.OPF_068, location(), role);\n-        }\n-      }\n+      rolesBuilder.add(role);\n     }\n     return rolesBuilder.build();\n   }\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 462b671..638f73a 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -247,9 +247,9 @@ OPF_064=OPF declares type \"%1$s\", validating using profile \"%2$s\".\n OPF_065=Invalid metadata declaration, probably due to a cycle in \"refines\" metadata.\n OPF_066=Missing \"dc:source\" or \"source-of\" pagination metadata. The pagination source must be identified using the \"dc:source\" and \"source-of\" properties when the content includes page break markers.\n OPF_067=The resource \"%1$s\" must not be listed both as  a \"link\" element in the package metadata and as a manifest item.\n-OPF_068=Unknown collection role \"%1$s\".\n-OPF_069=Custom collection role URI \"%1$s\" must not include the string \"idpf.org\" in its host component.\n-OPF_070=Custom collection role \"%1$s\" is an invalid URI.\n+OPF_068=\n+OPF_069=\n+OPF_070=Custom collection role \"%1$s\" is an invalid URL.\n OPF_071=Index collections must only contain resources pointing to XHTML Content Documents.\n OPF_072=Metadata element \"%1$s\" is empty.\n OPF_073=External identifiers must not appear in the document type declaration.\n", "test_patch": "diff --git a/src/test/resources/epub3/05-package-document/files/collection-role-url-valid.opf b/src/test/resources/epub3/05-package-document/files/collection-role-url-valid.opf\nindex ad7dad5..9d57e90 100644\n--- a/src/test/resources/epub3/05-package-document/files/collection-role-url-valid.opf\n+++ b/src/test/resources/epub3/05-package-document/files/collection-role-url-valid.opf\n@@ -16,4 +16,12 @@\n     <collection role=\"http://example.org/\">\n         <link href=\"http://example.org/resource\"/>\n     </collection>\n+    <collection role=\"http://idpf.org.example.org/\">\n+        <!-- using 'idpf.org' in the URL authority was forbidden in EPUB 3.2 -->\n+        <link href=\"http://example.org/resource\"/>\n+    </collection>\n+    <collection role=\"unknown-token\">\n+        <!-- using roles not in the role vocab was forbidden in EPUB 3.2 -->\n+        <link href=\"http://example.org/resource\"/>\n+    </collection>\n </package>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T22:48:38.285035Z", "commit_hash": "0fab5c86919699568f093b34bd65c0aec6c7b652", "commit_message": "feat: check `epub:type` restrictions in XHTML and SVG\n\nThis commit refactors the RelaxNG XHTML and SVG schemas to check that\nthe `epub:type` attribute is only allowed on:\n- palpable content in XHTML\n- structural, shape, and text elements in SVG\n\nIt also reorganizes and renames the schemas in a slightly more\nconsistent way.\n\nFixes #1348\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java b/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java\nindex 8487674..4d27c66 100755\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java\n@@ -56,11 +56,11 @@ public class OPSChecker extends PublicationResourceChecker\n       .putAll(Predicates.and(mimetype(\"application/xhtml+xml\"), version(EPUBVersion.VERSION_2)),\n           XMLValidators.XHTML_20_NVDL, XMLValidators.XHTML_20_SCH, XMLValidators.IDUNIQUE_20_SCH)\n       .putAll(Predicates.and(mimetype(\"application/xhtml+xml\"), version(EPUBVersion.VERSION_3)),\n-          XMLValidators.XHTML_30_NVDL, XMLValidators.SVG_INFORMATIVE_30_NVDL)\n+          XMLValidators.XHTML_30_NVDL, XMLValidators.SVG_30_INFORMATIVE_NVDL)\n       .putAll(Predicates.and(mimetype(\"image/svg+xml\"), version(EPUBVersion.VERSION_2)),\n           XMLValidators.SVG_20_NVDL, XMLValidators.IDUNIQUE_20_SCH)\n       .putAll(Predicates.and(mimetype(\"image/svg+xml\"), version(EPUBVersion.VERSION_3)),\n-          XMLValidators.SVG_30_NVDL, XMLValidators.SVG_INFORMATIVE_30_NVDL)\n+          XMLValidators.SVG_30_NVDL, XMLValidators.SVG_30_INFORMATIVE_NVDL)\n       .putAll(\n           and(or(profile(EPUBProfile.DICT), hasPubType(PublicationType.DICTIONARY)),\n               mimetype(\"application/xhtml+xml\"), version(EPUBVersion.VERSION_3)),\ndiff --git a/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java b/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java\nindex d2f6307..edd3ea1 100644\n--- a/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java\n+++ b/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java\n@@ -39,7 +39,7 @@ public enum XMLValidators\n   SVG_20_NVDL(\"schema/20/rng/ops20-svg.nvdl\"),\n   SVG_30_RNC(\"schema/30/epub-svg-30.rnc\"),\n   SVG_30_NVDL(\"schema/30/epub-svg-30.nvdl\"),\n-  SVG_INFORMATIVE_30_NVDL(\"schema/30/epub-svg-informative.nvdl\", false),\n+  SVG_30_INFORMATIVE_NVDL(\"schema/30/epub-svg-30-informative.nvdl\", false),\n   SVG_30_SCH(\"schema/30/epub-svg-30.sch\"),\n   XHTML_20_NVDL(\"schema/20/rng/ops20.nvdl\"),\n   XHTML_20_SCH(\"schema/20/sch/xhtml.sch\"),\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.rnc\nindex 13d6f82..23d4d48 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-nav-30.rnc\n@@ -2,6 +2,11 @@\n    default namespace = \"http://www.w3.org/1999/xhtml\"\n    namespace epub = \"http://www.idpf.org/2007/ops\"\n    \n+ \n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB Navigation Documents               #\n+# #####################################################################\n+   \n    include \"epub-xhtml-30.rnc\" {   \n         nav.attrs = nav.attrs.noepubtype\n    }\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30-informative.nvdl b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30-informative.nvdl\nnew file mode 100644\nindex 0000000..0e5edad\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30-informative.nvdl\n@@ -0,0 +1,12 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<rules xmlns=\"http://purl.oclc.org/dsdl/nvdl/ns/structure/1.0\">\n+\t<namespace ns=\"http://www.w3.org/2000/svg\">\n+\t\t<validate schema=\"epub-svg-30-informative.rnc\" schemaType=\"application/relax-ng-compact-syntax\"/>\n+\t</namespace>\n+\t<namespace ns=\"\" match=\"attributes\">\n+\t\t<attach/>\n+\t</namespace>\n+\t<anyNamespace match=\"elements attributes\">\n+\t\t<allow/>\n+\t</anyNamespace>\n+</rules>\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30-informative.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30-informative.rnc\nnew file mode 100644\nindex 0000000..4dfff72\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30-informative.rnc\n@@ -0,0 +1,17 @@\n+  namespace svg = \"http://www.w3.org/2000/svg\"\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB SVG and XHTML (+ MathML)           #\n+##         strict SVG grammar check (informative only)                #\n+# #####################################################################\n+\n+include \"./mod/epub-xhtml-inc.rnc\" {\n+  # This schema applies both to XHTML and SVG documents\n+  start = svg | html.elem\n+}\n+include \"./mod/epub-svg-strict-inc.rnc\"\n+include \"./mod/epub-mathml3-inc.rnc\"\n+include \"./mod/epub-shared-inc.rnc\"\n+\n+common.elem.phrasing |= svg\n+common.elem.phrasing |= math\n\\ No newline at end of file\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc\nindex d703cd6..f38bac0 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc\n@@ -1,17 +1,14 @@\n-namespace svg = \"http://www.w3.org/2000/svg\"\n \n-include \"./mod/epub-xhtml-inc.rnc\" {\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB SVG (+ XHTML, + MathML)            #\n+# #####################################################################\n+\n+include \"./mod/epub-xhtml-svg-mathml.rnc\" {\n   start = svg\n+  \n+  # Override the `id` attribute to require a valid XML ID\n+  svg.attr.id = attribute id { xsd:ID }?\n }\n-include \"./mod/epub-mathml3.rnc\"\n-include \"./mod/epub-svg-inc.rnc\"\n-\n-svg.title.content |= common.inner.anyhtml\n-\n-svg.foreignObject.content |= \n-  ( body.elem\n-  | common.inner.flow\n-  | math \n-  )\n \n-mtext.content |= common.elem.phrasing\n+# Allow `body` element as a child of `foreignObject` \n+svg.foreignObject.inner |= body.elem \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.nvdl b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.nvdl\ndeleted file mode 100644\nindex a42863d..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.nvdl\n+++ /dev/null\n@@ -1,12 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<rules xmlns=\"http://purl.oclc.org/dsdl/nvdl/ns/structure/1.0\">\n-\t<namespace ns=\"http://www.w3.org/2000/svg\">\n-\t\t<validate schema=\"epub-svg-informative.rnc\" schemaType=\"application/relax-ng-compact-syntax\"/>\n-\t</namespace>\n-\t<namespace ns=\"\" match=\"attributes\">\n-\t\t<attach/>\n-\t</namespace>\n-\t<anyNamespace match=\"elements attributes\">\n-\t\t<allow/>\n-\t</anyNamespace>\n-</rules>\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc\ndeleted file mode 100644\nindex 5df35a5..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc\n+++ /dev/null\n@@ -1,21 +0,0 @@\n-namespace svg = \"http://www.w3.org/2000/svg\"\n-\n-include \"./mod/epub-xhtml.rnc\" {\n-  # This schema applies both to XHTML and SVG documents\n-  start = svg | html.elem\n-}\n-include \"./mod/svg11/svg11-inc.rnc\" {\n-  # ID datatype is set here to the lower HTML requirements,\n-  # proper checking is done by the normative schema\n-  SVG.id.attrib = attribute id { datatype.html5.token }?\n-}\n-include \"./mod/svg11/inkscape.rnc\"\n-\n-## EPUB-specific additions:\n-\n-SVG.Core.attrib &= aria.global?\n-SVG.Core.extra.attrib &= epub.type.attr?\n-\n-## Do not check restricted elements, they are checked in normative schemas\n-SVG.foreignObject.content |= common.inner.anything\n-SVG.title.content |= common.inner.anything \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc\nindex 17c4545..2af2592 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc\n@@ -1,19 +1,6 @@\n-namespace svg = \"http://www.w3.org/2000/svg\"\n \n-include \"./mod/epub-xhtml-inc.rnc\"\n-include \"./mod/epub-mathml3.rnc\"\n-include \"./mod/epub-svg-inc.rnc\" {\n-  svg.attr.id = attribute id { datatype.html5.token }?\n-}\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB XHTML (+ SVG, + MathML)            #\n+# #####################################################################\n \n-common.elem.phrasing |= svg\n-common.elem.phrasing |= math\n-\n-math.attributes &= aria.global?\n-\n-svg.title.content |= common.inner.anyhtml\n-\n-svg.foreignObject.content |= \n-  ( common.inner.flow\n-  | math \n-  )\n+include \"./mod/epub-xhtml-svg-mathml.rnc\"\n\\ No newline at end of file\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc\nnew file mode 100644\nindex 0000000..018b46d\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3-inc.rnc\n@@ -0,0 +1,88 @@\n+default namespace m = \"http://www.w3.org/1998/Math/MathML\"\n+namespace local = \"\"\n+namespace x = \"http://www.w3.org/1999/xhtml\"\n+namespace ev = \"http://www.w3.org/2001/xml-events\"\n+namespace ssml = \"http://www.w3.org/2001/10/synthesis\"\n+\n+# #####################################################################\n+# \n+#  MathML validation based on the schemas from the Nu Html Checker,\n+#  with the following changes:\n+#    - Content MathML is only allowed in annotation-xml\n+#    - annotation-xml follows the restrictions defined in\n+#      EPUB Content Documents\n+#    - EPUB SSML attributes are allowed\n+#\n+# #####################################################################\n+\n+include \"mathml/mathml3-inc.rnc\" {\n+\n+    # extend to circumvent datatype collisions\n+    NonMathMLAtt =\n+        attribute * - (local:* | m:* | xml:* | x:* | ev:* | ssml:*) {\n+            datatype.string\n+        }\n+\n+    # as ops allows presentation mathml only at top level, kill the contribution to MathExpression\n+    MathExpression = semantics | PresentationExpression\n+    \n+    # override annotation-xml with EPUB restrictions\n+    annotation-xml = epub.annotation-xml\n+}\n+# Common attribute extensions\n+# - SSML attributes \n+CommonAtt &= epub.ssml.ph.attr?\n+# - xml:base\n+CommonAtt &= common.attrs.xmlbase?\n+# - ARIA\n+CommonAtt  &= aria.global?\n+\n+annotation-xml.model.xhtml |= common.inner.flow\n+annotation-xml.model.svg |= svg\n+\n+\n+# The following comes from validator.nu\u2019s xhtml5-svg-mathml.rnc driver:\n+# in our integration, <mtext> is the only MathML \"token element\" that can\n+# contain HTML element content; the <mi>, <mn>, <mo> and <ms> elements\n+# cannot; see http://www.w3.org/Bugs/Public/show_bug.cgi?id=9859#c8 for a\n+# rationale\n+mtext.content |= common.elem.phrasing\n+\n+# EPUB very specific annotation-xml restrictions:\n+epub.annotation-xml =\n+    ( annotation-xml.xhtml\n+    | annotation-xml.svg\n+    | epub.annotation-xml.mathml.content\n+    | epub.annotation-xml.mathml.presentation\n+    )\n+    epub.annotation-xml.attributes = CommonAtt, cd?, src?\n+    epub.annotation-xml.mathml.content =\n+        element annotation-xml {\n+            epub.annotation-xml.model.mathml.content, epub.annotation-xml.attributes,\n+            epub.att-encoding.mathml.content, epub.att-name.mathml.content\n+        }\n+        epub.annotation-xml.model.mathml.content = \n+          ContExp*\n+        epub.att-encoding.mathml.content =\n+          attribute encoding {\n+            string \"MathML-Content\" | string \"application/mathml-content+xml\"\n+          }\n+        epub.att-name.mathml.content =\n+          attribute name {\n+            string \"contentequiv\"\n+          }\n+    epub.annotation-xml.mathml.presentation =\n+        element annotation-xml {\n+            epub.annotation-xml.model.mathml.presentation, epub.annotation-xml.attributes,\n+            epub.att-encoding.mathml.presentation, epub.att-name.mathml.presentation?\n+        }\n+        epub.annotation-xml.model.mathml.presentation = \n+          MathExpression*\n+        epub.att-encoding.mathml.presentation =\n+          attribute encoding {\n+            string \"MathML\" | \"MathML-Presentation\" | string \"application/mathml-presentation+xml\"\n+          }\n+        epub.att-name.mathml.presentation =\n+          attribute name {\n+            xsd:NCName\n+          }\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3.rnc\ndeleted file mode 100644\nindex 1048992..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-mathml3.rnc\n+++ /dev/null\n@@ -1,87 +0,0 @@\n-default namespace m = \"http://www.w3.org/1998/Math/MathML\"\n-namespace local = \"\"\n-namespace x = \"http://www.w3.org/1999/xhtml\"\n-namespace ev = \"http://www.w3.org/2001/xml-events\"\n-namespace ssml = \"http://www.w3.org/2001/10/synthesis\"\n-\n-# #####################################################################\n-# \n-#  MathML validation based on the schemas from the Nu Html Checker,\n-#  with the following changes:\n-#    - Content MathML is only allowed in annotation-xml\n-#    - annotation-xml follows the restrictions defined in\n-#      EPUB Content Documents\n-#    - EPUB SSML attributes are allowed\n-#\n-# #####################################################################\n-\n-include \"mathml/mathml3-inc.rnc\" {\n-\n-    # extend to circumvent datatype collisions\n-    NonMathMLAtt =\n-        attribute * - (local:* | m:* | xml:* | x:* | ev:* | ssml:*) {\n-            datatype.string\n-        }\n-\n-    # as ops allows presentation mathml only at top level, kill the contribution to MathExpression\n-    MathExpression = semantics | PresentationExpression\n-    \n-    # override annotation-xml with EPUB restrictions\n-    annotation-xml = epub.annotation-xml\n-}\n-\n-# Common attribute extensions\n-# - SSML attributes \n-CommonAtt &= epub.ssml.ph.attr?\n-# - xml:base\n-CommonAtt &= common.attrs.xmlbase?\n-\n-annotation-xml.model.xhtml |= common.inner.flow\n-annotation-xml.model.svg |= svg\n-\n-# The following comes from validator.nu\u2019s xhtml5-svg-mathml.rnc driver:\n-# in our integration, <mtext> is the only MathML \"token element\" that can\n-# contain HTML element content; the <mi>, <mn>, <mo> and <ms> elements\n-# cannot; see http://www.w3.org/Bugs/Public/show_bug.cgi?id=9859#c8 for a\n-# rationale\n-mtext.content |= common.elem.phrasing\n-\n-# EPUB very specific annotation-xml restrictions:\n-epub.annotation-xml =\n-    ( annotation-xml.xhtml\n-    | annotation-xml.svg\n-    | epub.annotation-xml.mathml.content\n-    | epub.annotation-xml.mathml.presentation\n-    )\n-    epub.annotation-xml.attributes = CommonAtt, cd?, src?\n-    epub.annotation-xml.mathml.content =\n-        element annotation-xml {\n-            epub.annotation-xml.model.mathml.content, epub.annotation-xml.attributes,\n-            epub.att-encoding.mathml.content, epub.att-name.mathml.content\n-        }\n-        epub.annotation-xml.model.mathml.content = \n-          ContExp*\n-        epub.att-encoding.mathml.content =\n-          attribute encoding {\n-            string \"MathML-Content\" | string \"application/mathml-content+xml\"\n-          }\n-        epub.att-name.mathml.content =\n-          attribute name {\n-            string \"contentequiv\"\n-          }\n-    epub.annotation-xml.mathml.presentation =\n-        element annotation-xml {\n-            epub.annotation-xml.model.mathml.presentation, epub.annotation-xml.attributes,\n-            epub.att-encoding.mathml.presentation, epub.att-name.mathml.presentation?\n-        }\n-        epub.annotation-xml.model.mathml.presentation = \n-          MathExpression*\n-        epub.att-encoding.mathml.presentation =\n-          attribute encoding {\n-            string \"MathML\" | \"MathML-Presentation\" | string \"application/mathml-presentation+xml\"\n-          }\n-        epub.att-name.mathml.presentation =\n-          attribute name {\n-            xsd:NCName\n-          }\n-\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-prefix-attr.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-prefix-attr.rnc\nindex 6323485..5c8979f 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-prefix-attr.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-prefix-attr.rnc\n@@ -1,8 +1,18 @@\n \n+  namespace epub = \"http://www.idpf.org/2007/ops\"\n \n-   namespace epub = \"http://www.idpf.org/2007/ops\"\n-      \n-   html.attrs &=  epub.prefix.attr.ns?\n-      \n-   epub.prefix.attr = attribute prefix { datatype.prefixdecl }   \n-   epub.prefix.attr.ns = attribute epub:prefix { datatype.prefixdecl }\n\\ No newline at end of file\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB prefix attributes                  #\n+# #####################################################################\n+\n+## prefix attributes\n+\n+  epub.prefix.attr =\n+    attribute prefix {\n+      datatype.prefixdecl\n+    }   \n+\n+  epub.prefix.attr.ns =\n+    attribute epub:prefix {\n+      datatype.prefixdecl\n+    }\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-shared-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-shared-inc.rnc\nnew file mode 100644\nindex 0000000..e9f4da3\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-shared-inc.rnc\n@@ -0,0 +1,29 @@\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: shared definitions for inclusion        #\n+# #####################################################################\n+\n+## Includes\n+\n+  # EPUB elements\n+  include \"./epub-trigger.rnc\"\n+  include \"./epub-switch.rnc\"\n+\n+  # EPUB attributes\n+  include \"./epub-prefix-attr.rnc\"         \n+  include \"./epub-ssml-attrs.rnc\"         \n+  include \"./epub-type-attr.rnc\"    \n+\n+  # EPUB integration logic\n+  include \"./epub-xhtml-integration.rnc\"\n+\n+## Content model: HTML fragments\n+\n+  # Note: the default HMTL schema does not define such a category, so we\n+  # do our best to include what makes sense here\n+\n+  common.inner.anyhtml = \n+      html.elem\n+    | body.elem\n+    | common.inner.flow\n+    \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-ssml-attrs.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-ssml-attrs.rnc\nindex b9929bf..07cd550 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-ssml-attrs.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-ssml-attrs.rnc\n@@ -1,11 +1,20 @@\n \n-\n+  namespace epub = \"http://www.idpf.org/2007/ops\"\n   namespace ssml = \"http://www.w3.org/2001/10/synthesis\"\n-  \n-  \n-  common.attrs.other &= epub.ssml.ph.attr? & epub.ssml.alphabet.attr?\n-    \n-  #TODO determine injection in SVG\n-               \n-  epub.ssml.ph.attr = attribute ssml:ph { datatype.ssml.PhoneticExpression }\n-  epub.ssml.alphabet.attr = attribute ssml:alphabet { datatype.ssml.PhoneticAlphabet }\n\\ No newline at end of file\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB SSML attributes                    #\n+# #####################################################################\n+\n+\n+## SSML attributes\n+\n+  epub.ssml.ph.attr =\n+    attribute ssml:ph {\n+      datatype.ssml.PhoneticExpression\n+    }\n+\n+  epub.ssml.alphabet.attr =\n+    attribute ssml:alphabet {\n+      datatype.ssml.PhoneticAlphabet\n+    }\n\\ No newline at end of file\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-forgiving-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-forgiving-inc.rnc\nnew file mode 100644\nindex 0000000..074e4e6\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-forgiving-inc.rnc\n@@ -0,0 +1,151 @@\n+\n+  default namespace = \"http://www.w3.org/2000/svg\"\n+  namespace epub = \"http://www.idpf.org/2007/ops\"\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB SVG forgiving grammar check        #\n+# #####################################################################\n+\n+# The schema:\n+# - checks the `id` attribute datatype\n+# - restricts the content model of the `title` and `foreignObject`,\n+#   following the EPUB SVG restrictions\n+# - checks that `epub:type` is only used on allowed elements\n+#   (i.e. structural, shape, and text elements)\n+# Ohterwise, it does not report SVG validation errors.\n+\n+## Root Element: <svg>\n+\n+  svg =\n+    element svg { svg.inner & svg.attrs }\n+  svg.attrs =\n+    ( svg.epubtype.allowed.attrs )\n+  svg.inner =\n+    ( svg.any.inner )\n+\n+## Attributes\n+\n+  # ID attribute is defined specifically, for type checking\n+  svg.attr.id = \n+    attribute id {\n+      datatype.html5.token\n+    }\n+\n+  # Any other attribute\n+  svg.generic.attr =\n+    attribute *\n+      - ( id\n+        | epub:type\n+        ) { text }\n+\n+  # Attribute list of elements where `epub:type` is allowed\n+  svg.epubtype.allowed.attrs =\n+    ( epub.type.attr?\n+    & svg.attr.id?\n+    & svg.generic.attr*\n+    )\n+\n+  # Attribute list of elements where `epub:type` is forbidden\n+  svg.epubtype.forbidden.attrs =\n+    ( svg.attr.id?\n+    & svg.generic.attr*\n+    )\n+\n+## Restricted Elements\n+\n+  svg.restricted.elem =\n+    ( svg.foreignObject.elem\n+    | svg.title.elem\n+    )\n+\n+## Restricted Element: `foreignObject`\n+\n+  svg.foreignObject.elem =\n+    element foreignObject { svg.foreignObject.inner & svg.foreignObject.attrs }\n+  svg.foreignObject.attrs =\n+    svg.epubtype.forbidden.attrs\n+  svg.foreignObject.inner =\n+    common.inner.flow\n+\n+### Restricted Element: `title`\n+\n+  svg.title.elem =\n+    element title {  svg.title.inner & svg.title.attrs }\n+  svg.title.attrs =\n+    svg.epubtype.forbidden.attrs\n+  svg.title.inner =\n+    common.inner.anyhtml\n+\n+### Other elements where `epub:type` is allowed\n+\n+  # the elements where `epub:type` is allowed and that have no\n+  # specific content model defined anove.\n+  #\n+  # Note: an element in this list also needs to be added to the\n+  # exception clause in the `svg.anyother.elem` class\n+  svg.structural.elem =\n+    ( element defs { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element g { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element svg { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element symbol { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element use { svg.any.inner & svg.epubtype.allowed.attrs }\n+    )\n+  svg.shape.elem =\n+    ( element path { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element rect { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element circle { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element ellipse { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element line { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element polyline { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element polygon { svg.any.inner & svg.epubtype.allowed.attrs }\n+    )\n+  svg.text.elem =\n+    ( element text { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element altGlyph { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element textPath { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element tref { svg.any.inner & svg.epubtype.allowed.attrs }\n+    | element tspan { svg.any.inner & svg.epubtype.allowed.attrs }\n+    )\n+  svg.epubtype.allowed.elem =\n+    ( svg.structural.elem\n+    | svg.shape.elem\n+    | svg.text.elem\n+    )\n+\n+### Any other elements\n+\n+  # any element except:\n+  # - the elements with a restricted content model\n+  # - the elements allowing `epub:type`\n+  svg.anyother.elem = element * -\n+    ( foreignObject\n+    | title\n+    | defs\n+    | g\n+    | svg\n+    | symbol\n+    | use\n+    | path\n+    | rect\n+    | circle\n+    | ellipse\n+    | line\n+    | polyline\n+    | polygon\n+    | text\n+    | altGlyph\n+    | textPath\n+    | tref\n+    | tspan\n+    ) { svg.any.inner & svg.epubtype.forbidden.attrs } \n+\n+### Anything\n+\n+  svg.any.elem =\n+    ( svg.epubtype.allowed.elem\n+    | svg.restricted.elem\n+    | svg.anyother.elem\n+    )\n+  svg.any.inner =\n+    ( text & svg.any.elem* )\n+\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc\ndeleted file mode 100644\nindex 9acad78..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc\n+++ /dev/null\n@@ -1,39 +0,0 @@\n-default namespace = \"http://www.w3.org/2000/svg\"\n-\n-# #####################################################################\n-##  Anything-goes schema for svg                                      #\n-# #####################################################################\n-\n-## SVG root\n-svg = svg.elem\n-svg.elem =\n-  element svg { any.content & any.attr }\n-\n-## Special cases\n-specific.elems =\n-  ( svg.foreignObject\n-  | svg.title\n-  )\n-specific.attrs = svg.attr.id\n-\n-### SVG ID datatype\n-svg.attr.id = attribute id { xsd:ID }?\n-\n-### SVG foreignObject element restrictions\n-svg.foreignObject = \n-  element foreignObject { any.attr & svg.foreignObject.content }\n-svg.foreignObject.content = notAllowed\n-\n-### SVG title element restrictions\n-svg.title =\n-  element title { any.attr & svg.title.content }\n-svg.title.content = text \n-\n-## Anything\n-\n-## Any attribute from any namespace, other than the special cases\n-any.attr = attribute * -id { text }* & svg.attr.id\n-## Any element from any namespace, other than the special cases\n-any.elem = element * - (foreignObject|title) { any.content & any.attr }\n-## Any content from any namespace\n-any.content = text & any.elem* & specific.elems*\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-strict-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-strict-inc.rnc\nnew file mode 100644\nindex 0000000..b1a62e4\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-strict-inc.rnc\n@@ -0,0 +1,22 @@\n+namespace svg = \"http://www.w3.org/2000/svg\"\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB SVG complete grammar check         #\n+# #####################################################################\n+\n+include \"./svg11/svg11-inc.rnc\" {\n+  # ID datatype is set here to the lower HTML requirements,\n+  # proper checking is done by the normative schema\n+  SVG.id.attrib = attribute id { datatype.html5.token }?\n+}\n+include \"./svg11/inkscape.rnc\"\n+\n+## EPUB-specific additions:\n+\n+  SVG.Core.attrib &= aria.global?\n+  SVG.Core.extra.attrib &= epub.type.attr?\n+\n+## Do not check restricted elements, they are checked in normative schemas\n+\n+  SVG.foreignObject.content |= common.inner.anything\n+  SVG.title.content |= common.inner.anything \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-switch.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-switch.rnc\nindex 0fe919d..28786c2 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-switch.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-switch.rnc\n@@ -1,36 +1,57 @@\n \n-   namespace epub = \"http://www.idpf.org/2007/ops\"\n-   namespace m = \"http://www.w3.org/1998/Math/MathML\"\n-   namespace h = \"http://www.w3.org/1999/xhtml\"\n-         \n-   common.elem.flow |= epub.switch.flow\n-   common.elem.phrasing |= epub.switch.phrasing\n+  namespace epub = \"http://www.idpf.org/2007/ops\"\n+  namespace m = \"http://www.w3.org/1998/Math/MathML\"\n+  namespace h = \"http://www.w3.org/1999/xhtml\"\n \n-   epub.switch.flow = element epub:switch { epub.switch.attlist, epub.switch.case.flow+, epub.switch.default.flow }\n-   epub.switch.phrasing = element epub:switch { epub.switch.attlist, epub.switch.case.phrasing+, epub.switch.default.phrasing }\n-      \n-   epub.switch.case.flow = element epub:case { epub.case.attlist & epub.case.flow.content }\n-   epub.switch.case.phrasing = element epub:case { epub.case.attlist & epub.case.phrasing.content }\n-   epub.switch.default.flow = element epub:default { epub.default.attlist & epub.default.flow.content }\n-   epub.switch.default.phrasing = element epub:default { epub.default.attlist & epub.default.phrasing.content }\n-   \n-   epub.case.flow.content = epub.switch.any \n-   epub.case.phrasing.content = epub.switch.any\n-   epub.switch.any = (common.elem.flow | epub.switch.anyElement | text)*\n-   \n-   epub.default.flow.content = common.inner.flow\n-   epub.default.phrasing.content = common.inner.phrasing\n-   \n-   epub.switch.attlist &= common.attrs.id?\n-   epub.case.attlist &= common.attrs.id? & epub.case.rn.attr\n-   epub.default.attlist &= common.attrs.id?\n-   \n-   epub.case.rn.attr = attribute required-namespace { datatype.URI }\n- \n-   epub.switch.anyElement = element * - (m:* | h:*) {\n-      (attribute * { text }\n-      | text\n-      | epub.switch.anyElement\n-      | common.elem.flow\n-      )*\n-   }   \n\\ No newline at end of file\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB switch element                     #\n+# #####################################################################\n+\n+## `epub:switch` element\n+\n+  epub.switch.flow =\n+    element epub:switch { epub.switch.attrs, epub.switch.case.flow+, epub.switch.default.flow }\n+  epub.switch.phrasing =\n+    element epub:switch { epub.switch.attrs, epub.switch.case.phrasing+, epub.switch.default.phrasing }\n+     \n+  epub.switch.case.flow =\n+    element epub:case { epub.case.attrs & epub.case.flow.inner }\n+  epub.switch.case.phrasing =\n+    element epub:case { epub.case.attrs & epub.case.phrasing.inner }\n+  epub.switch.default.flow =\n+    element epub:default { epub.default.attrs & epub.default.flow.inner }\n+  epub.switch.default.phrasing =\n+    element epub:default { epub.default.attrs & epub.default.phrasing.inner }\n+  \n+  epub.case.flow.inner =\n+    epub.switch.any \n+  epub.case.phrasing.inner =\n+    epub.switch.any\n+  epub.switch.any = \n+    ( common.elem.flow\n+    | epub.switch.anyElement\n+    | text\n+    )*\n+  \n+  epub.default.flow.inner =\n+    common.inner.flow\n+  epub.default.phrasing.inner =\n+    common.inner.phrasing\n+  \n+  epub.switch.attrs &= common.attrs.id?\n+  epub.case.attrs &= common.attrs.id? & epub.case.attrs.rn\n+  epub.default.attrs &= common.attrs.id?\n+  \n+  epub.case.attrs.rn =\n+    attribute required-namespace {\n+      datatype.URI\n+    }\n+\n+  epub.switch.anyElement = element * - (m:* | h:*) {\n+    ( attribute * { text }\n+    | text\n+    | epub.switch.anyElement\n+    | common.elem.flow\n+    )*\n+  }   \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-trigger.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-trigger.rnc\nindex 78098bb..cd37383 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-trigger.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-trigger.rnc\n@@ -1,22 +1,54 @@\n \n-   namespace epub = \"http://www.idpf.org/2007/ops\"\n-   namespace ev = \"http://www.w3.org/2001/xml-events\"\n-   \n-   common.elem.metadata |= epub.trigger \n-   common.elem.flow |= epub.trigger\n+  namespace epub = \"http://www.idpf.org/2007/ops\"\n+  namespace ev = \"http://www.w3.org/2001/xml-events\"\n+\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB trigger element                    #\n+# #####################################################################\n \n+## `epub:trigger` element\n \n-   epub.trigger = element epub:trigger { epub.trigger.attlist & epub.trigger.content }\n-   epub.trigger.attlist = common.attrs.id? & epub.trigger.action.attr & epub.trigger.ref.attr \n-   \t& xml.events.event.attr & xml.events.observer.attr & xml.events.defaultAction.attr? \n-   \t& xml.events.phase.attr? & xml.events.propagate.attr?\n+  epub.trigger =\n+    element epub:trigger { epub.trigger.attrs & epub.trigger.inner }\n+  epub.trigger.attrs = \n+    ( common.attrs.id?\n+    & epub.trigger.attrs.action\n+    & epub.trigger.attrs.ref \n+   \t& xml.events.attrs.event\n+   \t& xml.events.attrs.observer\n+   \t& xml.events.attrs.defaultAction? \n+   \t& xml.events.attrs.phase?\n+   \t& xml.events.attrs.propagate?\n+   \t)\n    \n-   epub.trigger.action.attr = attribute action { 'show'|'hide'|'play'|'pause'|'resume'|'mute'|'unmute' }\n-   epub.trigger.ref.attr = attribute ref { datatype.IDREF }\n-   xml.events.event.attr = attribute ev:event { datatype.NMTOKEN }\n-   xml.events.observer.attr = attribute ev:observer { datatype.IDREF }\n-   xml.events.defaultAction.attr = attribute ev:defaultAction { 'cancel' | 'perform' }\n-   xml.events.phase.attr = attribute ev:phase { 'capture' | 'default' }\n-   xml.events.propagate.attr = attribute ev:propagate { 'stop' | 'continue' }\n+   epub.trigger.attrs.action =\n+     attribute action {\n+       'show' | 'hide' | 'play' | 'pause' | 'resume' | 'mute' | 'unmute' \n+     }\n+   epub.trigger.attrs.ref =\n+     attribute ref {\n+       datatype.IDREF \n+     }\n+   xml.events.attrs.event =\n+     attribute ev:event {\n+       datatype.NMTOKEN \n+     }\n+   xml.events.attrs.observer =\n+     attribute ev:observer {\n+       datatype.IDREF \n+     }\n+   xml.events.attrs.defaultAction =\n+     attribute ev:defaultAction {\n+       'cancel' | 'perform' \n+     }\n+   xml.events.attrs.phase =\n+     attribute ev:phase {\n+       'capture' | 'default' \n+     }\n+   xml.events.attrs.propagate =\n+     attribute ev:propagate {\n+       'stop' | 'continue' \n+     }\n    \n-   epub.trigger.content = empty\n\\ No newline at end of file\n+   epub.trigger.inner = empty\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-type-attr.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-type-attr.rnc\nindex b35845d..7902cad 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-type-attr.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-type-attr.rnc\n@@ -1,13 +1,14 @@\n \n+  namespace epub = \"http://www.idpf.org/2007/ops\"\n \n-   namespace epub = \"http://www.idpf.org/2007/ops\"\n-   \n-   ## We can't use common.attrs.other since we have\n-   ## to reset the definition of the class of attributes\n-   ## where epub:type is added in the nav doc schema, and\n-   ## common.attrs.other is augmented by other schemas.\n-   ## We therefore augment common.attrs (and also attribute\n-   ## lists that are not based on common.attrs) \n-   common.attrs.basic &= epub.type.attr?\n-\n-   epub.type.attr = attribute epub:type { datatype.properties }\n\\ No newline at end of file\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: `epub:type` attribute                   #\n+# #####################################################################\n+\n+\n+## `epub:type` attribute\n+\n+  epub.type.attr = \n+    attribute epub:type {\n+      datatype.properties\n+    }\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc\nindex f8dcae8..1926121 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc\n@@ -1,18 +1,105 @@\n+# Credit: integration adapted from the Nu Html Checker drivers\n \n+default namespace = \"http://www.w3.org/1999/xhtml\"\n+\n+# #####################################################################\n+##  RELAX NG Schema for XHTML 5                                       #\n+# #####################################################################\n+# \n+#  XHTML validation based on the schemas from the Nu Html Checker,\n+#  with the following changes:\n+#    - datatypes replaced to use the patterns in datatype.rnc\n+#    - title element not required (a missing title element will be\n+#      reported as a WARNING in Schematron\n+#    - allows meta http-equiv in encoding declaration state\n+#    - allows the border attribute on tables\n+#    - allow EPUB extensions (epub:type, epub:switch, epub:trigger,\n+#      ssml:* attributes, etc)\n+#\n # #####################################################################\n-##  RELAX NG Schema for EPUB HTML 5: For inclusion in master schema   #\n+## Schema Framework & Parameters\n+\n+include \"./html5/common.rnc\" {\n+\t# XHTML flavor #\n+\t\tXMLonly = empty\n+\t\tHTMLonly = notAllowed\n+\t# HTML 4 compat #\n+\t\tv5only = empty\n+}\n+\n # #####################################################################\n+## Language Definitions\n+\n+start = html.elem\n \n-## Include the main XHTML schema\n+## Static datatypes\n \n-include \"./epub-xhtml.rnc\"\n+# Note: these are too simplistic. The Nu HTML Checker performs\n+# a significant part of the checking in its Java-based datatype\n+# library.\n \n-## HTML fragments\n+include \"./datatypes.rnc\"\n \n-# Note: the default HMTL schema does not define such a category, so we\n-# do our best to include what makes sense here\n+## Modules from the Nu HTML Checker\n+   \n+include \"./html5/meta.rnc\" {\n+  # make the title element optional, since one could see the publication title\n+  # as defining a proper \"higher-level protocol\"\n+  # the lack of `title` will however raise a WARNING in a Schematron rule \n+\thead.inner =\n+\t\t(\ttitle.elem? \n+\t\t&\tbase.elem? # REVISIT need a non-schema checker or Schematron\n+\t\t&\tcommon.inner.metadata # Limit encoding decl position in Schematron\n+\t\t)\n+\t\t\n+\t# Allow http-equiv in encoding declaration state in XHTML too\n+\t# (W3C allows that, but not WHATWG)\n+\tmeta.http-equiv.content-type.elem =\n+\t\telement meta { meta.inner & meta.http-equiv.content-type.attrs }\n+\t\t\n+\t# Make http-equiv case-insensitive\n+\t# This is an ugly hack. Case-insensitiveness would better be solved\n+\t# at parsing time.\n+\tmeta.http-equiv.attrs.http-equiv.content-type =\n+\t\t\tattribute http-equiv {\n+\t\t\t\t xsd:string { pattern = \"[cC][oO][nN][tT][eE][nN][tT]-[tT][yY][pP][eE]\" }\n+\t\t\t}\n+\tmeta.http-equiv.attrs.http-equiv.refresh =\n+\t\t\tattribute http-equiv {\n+\t\t\t   xsd:string { pattern = \"[rR][eE][fF][rR][eE][sS][hH]\" }\n+\t\t\t}\n+\tmeta.http-equiv.attrs.http-equiv.default-style =\n+\t\t\tattribute http-equiv {\n+\t\t\t\t xsd:string { pattern = \"[dD][eE][fF][aA][uU][lL][tT]-[sS][tT][yY][lL][eE]\" }\n+\t\t\t}\n+\tmeta.http-equiv.attrs.http-equiv.content-security-policy =\n+\t\t\tattribute http-equiv {\n+\t\t\t\t xsd:string { pattern = \"[cC][oO][nN][tT][eE][nN][tT]-[sS][eE][cC][uU][rR][iI][tT][yY]-[pP][oO][lL][iI][cC][yY]\" }\n+\t\t\t}\n+\tmeta.http-equiv.attrs.http-equiv.x-ua-compatible =\n+\t\t\tattribute http-equiv {\n+\t\t\t\t xsd:string { pattern = \"[xX]-[uU][aA]-[cC][oO][mM][pP][aA][tT][iI][bB][lL][eE]\" }\n+\t\t\t}\n+}\n+include \"./html5/phrase.rnc\"\n+include \"./html5/block.rnc\"\n+include \"./html5/sectional.rnc\"\n+include \"./html5/structural.rnc\"\n+include \"./html5/revision.rnc\"\n+include \"./html5/embed.rnc\"\n+include \"./html5/ruby.rnc\"\n+include \"./html5/media.rnc\"\n+include \"./html5/core-scripting.rnc\"\n+include \"./html5/tables.rnc\"\n+include \"./html5/form-datatypes.rnc\"\n+include \"./html5/web-forms.rnc\"\n+include \"./html5/web-forms2.rnc\"\n+include \"./html5/applications.rnc\"\n+include \"./html5/data.rnc\"\n+include \"./html5/aria.rnc\"\n+include \"./html5/microdata.rnc\"\n+include \"./html5/web-components.rnc\"\n+include \"./html5/rdfa.rnc\"\n \n-  common.inner.anyhtml = \n-      html.elem\n-    | body.elem\n-    | common.inner.flow\n+# More tweaks for W3C-allowed features\n+table.attrs &= attribute border { \"\" | \"1\" }?\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc\nnew file mode 100644\nindex 0000000..3cce847\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-integration.rnc\n@@ -0,0 +1,110 @@\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: integration of EPUB specifics in HTML   #\n+# #####################################################################     \n+\n+\n+\n+## combine `epub:type`\n+\n+  # Allow `epub:type` on the `body` element (even though\n+  # it is not defined as palpable content)\n+  body.attrs &= epub.type.attr?\n+  \n+  # Allow `epub:type` on palpable content\n+  #\n+  # Note:\n+  # We can't use a common category since none is defined\n+  # for palpable content. So we add it for each element.\n+  #\n+  # Some elements are only considered palpable under some\n+  # conditions; we do not support that at the moment.\n+  #\n+  a.attrs &= epub.type.attr?\n+  abbr.attrs &= epub.type.attr?\n+  address.attrs &= epub.type.attr?\n+  article.attrs &= epub.type.attr?\n+  aside.attrs &= epub.type.attr?\n+  audio.attrs &= epub.type.attr?\n+  b.attrs &= epub.type.attr?\n+  bdi.attrs &= epub.type.attr?\n+  bdo.attrs &= epub.type.attr?\n+  blockquote.attrs &= epub.type.attr?\n+  button.attrs &= epub.type.attr?\n+  canvas.attrs &= epub.type.attr?\n+  cite.attrs &= epub.type.attr?\n+  code.attrs &= epub.type.attr?\n+  data.attrs &= epub.type.attr?\n+  details.attrs &= epub.type.attr?\n+  dfn.attrs &= epub.type.attr?\n+  div.attrs &= epub.type.attr?\n+  dl.attrs &= epub.type.attr?\n+  emembed.attrs &= epub.type.attr?\n+  fieldset.attrs &= epub.type.attr?\n+  figure.attrs &= epub.type.attr?\n+  footer.attrs &= epub.type.attr?\n+  form.attrs &= epub.type.attr?\n+  h1.attrs &= epub.type.attr?\n+  h2.attrs &= epub.type.attr?\n+  h3.attrs &= epub.type.attr?\n+  h4.attrs &= epub.type.attr?\n+  h5.attrs &= epub.type.attr?\n+  h6.attrs &= epub.type.attr?\n+  header.attrs &= epub.type.attr?\n+  hgroup.attrs &= epub.type.attr?\n+  i.attrs &= epub.type.attr?\n+  iframe.attrs &= epub.type.attr?\n+  img.attrs &= epub.type.attr?\n+  input.attrs &= epub.type.attr?\n+  ins.attrs &= epub.type.attr?\n+  kbd.attrs &= epub.type.attr?\n+  label.attrs &= epub.type.attr?\n+  main.attrs &= epub.type.attr?\n+  map.attrs &= epub.type.attr?\n+  mark.attrs &= epub.type.attr?\n+  menu.attrs &= epub.type.attr?\n+  meter.attrs &= epub.type.attr?\n+  nav.attrs &= epub.type.attr?\n+  object.attrs &= epub.type.attr?\n+  ol.attrs &= epub.type.attr?\n+  output.attrs &= epub.type.attr?\n+  p.attrs &= epub.type.attr?\n+  pre.attrs &= epub.type.attr?\n+  progress.attrs &= epub.type.attr?\n+  q.attrs &= epub.type.attr?\n+  ruby.attrs &= epub.type.attr?\n+  s.attrs &= epub.type.attr?\n+  samp.attrs &= epub.type.attr?\n+  section.attrs &= epub.type.attr?\n+  select.attrs &= epub.type.attr?\n+  small.attrs &= epub.type.attr?\n+  span.attrs &= epub.type.attr?\n+  strong.attrs &= epub.type.attr?\n+  sub.attrs &= epub.type.attr?\n+  sup.attrs &= epub.type.attr?\n+  table.attrs &= epub.type.attr?\n+  text.attrs &= epub.type.attr?\n+  area.attrs &= epub.type.attr?\n+  time.attrs &= epub.type.attr?\n+  u.attrs &= epub.type.attr?\n+  ul.attrs &= epub.type.attr?\n+  var.attrs &= epub.type.attr?\n+  video.attrs &= epub.type.attr?\n+\n+## combine prefix attributes\n+\n+  html.attrs &= epub.prefix.attr.ns?\n+\n+## combine SSML attributes\n+\n+  common.attrs.other &= epub.ssml.ph.attr? & epub.ssml.alphabet.attr?\n+\n+## combine `epub:switch` element\n+\n+  common.elem.flow |= epub.switch.flow\n+  common.elem.phrasing |= epub.switch.phrasing\n+\n+## combine `epub:trigger` element\n+\n+  common.elem.metadata |= epub.trigger \n+  common.elem.flow |= epub.trigger\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-mathml3.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-mathml3.rnc\ndeleted file mode 100644\nindex b988f39..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-mathml3.rnc\n+++ /dev/null\n@@ -1,10 +0,0 @@\n-namespace math = \"http://www.w3.org/1998/Math/MathML\"\n-\n-include \"epub-mathml3.rnc\"\n-\n-common.elem.phrasing |= math\n-\n-math.attributes &=\n-\t(\tcommon.attrs.aria.role.math\n-\t|\tcommon.attrs.aria.implicit.math\n-\t)?\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-svg-mathml.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-svg-mathml.rnc\nnew file mode 100644\nindex 0000000..a207ff3\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-svg-mathml.rnc\n@@ -0,0 +1,12 @@\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB: EPUB XHTML (+ SVG, + MathML)            #\n+# #####################################################################\n+\n+include \"./epub-xhtml-inc.rnc\"\n+include \"./epub-svg-forgiving-inc.rnc\"\n+include \"./epub-mathml3-inc.rnc\"\n+include \"./epub-shared-inc.rnc\"\n+\n+common.elem.phrasing |= svg\n+common.elem.phrasing |= math\n\\ No newline at end of file\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-svg11.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-svg11.rnc\ndeleted file mode 100644\nindex c694669..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-svg11.rnc\n+++ /dev/null\n@@ -1,40 +0,0 @@\n-# Credit: integration adapted from the Nu Html Checker drivers\n-\n-namespace svg = \"http://www.w3.org/2000/svg\"\n-\n-include \"svg11/svg11-inc.rnc\" {\n-  SVG.id.attrib = attribute id { datatype.html5.token }?\n-}\n-include \"svg11/inkscape.rnc\"\n-\n-common.elem.phrasing |= svg\n-\n-SVG.Core.attrib &= aria.global?\n-SVG.Core.extra.attrib &= epub.type.attr?\n-\n-SVG.foreignObject.content |= common.inner.flow\n-    \n-SVG.desc.content |= common.inner.flow\n-SVG.title.content |= common.inner.flow\n-SVG.metadata.content |= common.inner.flow\n-\n-SVG.vector-effect.attrib =\n-\tattribute vector-effect {\n-\t\tstring \"none\" | string \"non-scaling-stroke\"\n-\t}\n-\n-attlist.circle &= SVG.vector-effect.attrib?\n-attlist.ellipse &= SVG.vector-effect.attrib?\n-attlist.foreignObject &= SVG.vector-effect.attrib?\n-attlist.image &= SVG.vector-effect.attrib?\n-attlist.line &= SVG.vector-effect.attrib?\n-attlist.path &= SVG.vector-effect.attrib?\n-attlist.polygon &= SVG.vector-effect.attrib?\n-attlist.polyline &= SVG.vector-effect.attrib?\n-attlist.rect &= SVG.vector-effect.attrib?\n-attlist.text &= SVG.vector-effect.attrib?\n-attlist.tspan &= SVG.vector-effect.attrib?\n-attlist.use &= SVG.vector-effect.attrib?\n-\n-# augment MathML annotation-xml content model\n-# annotation-xml.model.svg |= svg\n\\ No newline at end of file\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml.rnc\ndeleted file mode 100644\nindex f1bc9dd..0000000\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml.rnc\n+++ /dev/null\n@@ -1,115 +0,0 @@\n-# Credit: integration adapted from the Nu Html Checker drivers\n-\n-default namespace = \"http://www.w3.org/1999/xhtml\"\n-# #####################################################################\n-##  RELAX NG Schema for XHTML 5                                       #\n-# #####################################################################\n-# \n-#  XHTML validation based on the schemas from the Nu Html Checker,\n-#  with the following changes:\n-#    - datatypes replaced to use the patterns in datatype.rnc\n-#    - title element not required (a missing title element will be\n-#      reported as a WARNING in Schematron\n-#    - allows meta http-equiv in encoding declaration state\n-#    - allows the border attribute on tables\n-#    - allow EPUB extensions (epub:type, epub:switch, epub:trigger,\n-#      ssml:* attributes, etc)\n-#\n-# #####################################################################\n-## Schema Framework & Parameters\n-\n-include \"./html5/common.rnc\" {\n-\t# XHTML flavor #\n-\t\tXMLonly = empty\n-\t\tHTMLonly = notAllowed\n-\t# HTML 4 compat #\n-\t\tv5only = empty\n-}\n-\n-# #####################################################################\n-## Language Definitions\n-\n-start = html.elem\n-\n-## Static datatypes\n-\n-# Note: these are too simplistic. The Nu HTML Checker performs\n-# a significant part of the checking in its Java-based datatype\n-# library.\n-\n-include \"./datatypes.rnc\"\n-\n-## Modules from the Nu HTML Checker\n-   \n-include \"./html5/meta.rnc\" {\n-  # make the title element optional, since one could see the publication title\n-  # as defining a proper \"higher-level protocol\"\n-  # the lack of `title` will however raise a WARNING in a Schematron rule \n-\thead.inner =\n-\t\t(\ttitle.elem? \n-\t\t&\tbase.elem? # REVISIT need a non-schema checker or Schematron\n-\t\t&\tcommon.inner.metadata # Limit encoding decl position in Schematron\n-\t\t)\n-\t\t\n-\t# Allow http-equiv in encoding declaration state in XHTML too\n-\t# (W3C allows that, but not WHATWG)\n-\tmeta.http-equiv.content-type.elem =\n-\t\telement meta { meta.inner & meta.http-equiv.content-type.attrs }\n-\t\t\n-\t# Make http-equiv case-insensitive\n-\t# This is an ugly hack. Case-insensitiveness would better be solved\n-\t# at parsing time.\n-\tmeta.http-equiv.attrs.http-equiv.content-type =\n-\t\t\tattribute http-equiv {\n-\t\t\t\t xsd:string { pattern = \"[cC][oO][nN][tT][eE][nN][tT]-[tT][yY][pP][eE]\" }\n-\t\t\t}\n-\tmeta.http-equiv.attrs.http-equiv.refresh =\n-\t\t\tattribute http-equiv {\n-\t\t\t   xsd:string { pattern = \"[rR][eE][fF][rR][eE][sS][hH]\" }\n-\t\t\t}\n-\tmeta.http-equiv.attrs.http-equiv.default-style =\n-\t\t\tattribute http-equiv {\n-\t\t\t\t xsd:string { pattern = \"[dD][eE][fF][aA][uU][lL][tT]-[sS][tT][yY][lL][eE]\" }\n-\t\t\t}\n-\tmeta.http-equiv.attrs.http-equiv.content-security-policy =\n-\t\t\tattribute http-equiv {\n-\t\t\t\t xsd:string { pattern = \"[cC][oO][nN][tT][eE][nN][tT]-[sS][eE][cC][uU][rR][iI][tT][yY]-[pP][oO][lL][iI][cC][yY]\" }\n-\t\t\t}\n-\tmeta.http-equiv.attrs.http-equiv.x-ua-compatible =\n-\t\t\tattribute http-equiv {\n-\t\t\t\t xsd:string { pattern = \"[xX]-[uU][aA]-[cC][oO][mM][pP][aA][tT][iI][bB][lL][eE]\" }\n-\t\t\t}\n-}\n-include \"./html5/phrase.rnc\"\n-include \"./html5/block.rnc\"\n-include \"./html5/sectional.rnc\"\n-include \"./html5/structural.rnc\"\n-include \"./html5/revision.rnc\"\n-include \"./html5/embed.rnc\"\n-include \"./html5/ruby.rnc\"\n-include \"./html5/media.rnc\"\n-include \"./html5/core-scripting.rnc\"\n-include \"./html5/tables.rnc\"\n-include \"./html5/form-datatypes.rnc\"\n-include \"./html5/web-forms.rnc\"\n-include \"./html5/web-forms2.rnc\"\n-include \"./html5/applications.rnc\"\n-include \"./html5/data.rnc\"\n-include \"./html5/aria.rnc\"\n-include \"./html5/microdata.rnc\"\n-include \"./html5/web-components.rnc\"\n-include \"./html5/rdfa.rnc\"\n-\n-# More tweaks for W3C-allowed features\n-table.attrs &= attribute border { \"\" | \"1\" }?\n-\n-## EPUB additions\n-\n-# Elements\n-include \"./epub-trigger.rnc\"\n-include \"./epub-switch.rnc\"\n-\n-# Attributes\n-include \"./epub-type-attr.rnc\"         \n-include \"./epub-prefix-attr.rnc\"      \n-include \"./epub-ssml-attrs.rnc\"\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-on-non-palpable-content-error.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-on-non-palpable-content-error.xhtml\nnew file mode 100644\nindex 0000000..d02a422\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-on-non-palpable-content-error.xhtml\n@@ -0,0 +1,13 @@\n+<!DOCTYPE html>\t \n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\"\n+\tepub:prefix=\"test: https://example.org/vocab/#\" xml:lang=\"en\" lang=\"en\">\n+\t<head epub:type=\"test:invalid\">\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>epub:type in head element</title>\n+\t\t<meta name=\"creator\" content=\"Herman Melville\" epub:type=\"test:invalid\" />\n+\t</head>\n+\t<body>\n+\t\t<h1>Test</h1>\n+\t\t<div epub:type=\"test:valid\"></div>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-valid.svg b/src/test/resources/epub3/06-content-document/files/epubtype-valid.svg\nnew file mode 100644\nindex 0000000..84d4764\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-valid.svg\n@@ -0,0 +1,37 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n+\txmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"\n+\tepub:type=\"chapter\" version=\"1.1\">\n+\t<title>test</title>\n+\t<desc>Rectangle</desc>\n+\t<!-- Structural elements -->\n+\t<defs epub:type=\"notice\">\n+\t\t<rect id=\"my-rect\" width=\"60\" height=\"10\"/>\n+\t\t<text id=\"my-text\">hello</text>\n+\t\t<path id=\"my-path\" d=\"M 100 100 L 300 100 L 200 300 z\"/>\n+\t</defs>\n+\t<g epub:type=\"notice\">\n+\t\t<rect x=\"10\" y=\"20\" width=\"75\" height=\"30\"/>\n+\t</g>\n+\t<symbol epub:type=\"notice\">\n+\t\t<rect width=\"60\" height=\"10\"/>\n+\t</symbol>\n+\t<use epub:type=\"notice\" x=\"20\" y=\"10\" xlink:href=\"#my-rect\"/>\n+\t<!-- Shape elements -->\n+\t<rect epub:type=\"notice\" x=\"10\" y=\"20\" width=\"75\" height=\"30\"/>\n+\t<path epub:type=\"notice\" d=\"M 100 100 L 300 100 L 200 300 z\"/>\n+\t<circle epub:type=\"notice\" cx=\"600\" cy=\"200\" r=\"100\"/>\n+\t<ellipse epub:type=\"notice\" rx=\"250\" ry=\"100\"/>\n+\t<line epub:type=\"notice\" x1=\"100\" y1=\"300\" x2=\"300\" y2=\"100\"/>\n+\t<polyline epub:type=\"notice\" points=\"50,375,150\"/>\n+\t<polygon epub:type=\"notice\" points=\"850,75  958,137.5 958,262.5\"/>\n+\t<!-- Text elements -->\n+\t<text epub:type=\"notice\" x=\"250\" y=\"150\">hello</text>\n+\t<text x=\"250\" y=\"150\">\n+\t\t<tspan epub:type=\"notice\">hello</tspan></text>\n+\t<text x=\"250\" y=\"150\">\n+\t\t<tref epub:type=\"notice\" xlink:href=\"#my-text\"/></text>\n+\t<text>\n+\t\t<textPath epub:type=\"notice\" xlink:href=\"#my-path\">Text along path1</textPath>\n+\t</text>\n+</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-invalid-usage.svg b/src/test/resources/epub3/06-content-document/files/svg-invalid-usage.svg\nnew file mode 100644\nindex 0000000..be397eb\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/svg-invalid-usage.svg\n@@ -0,0 +1,9 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n+\txmlns:xlink=\"http://www.w3.org/1999/xlink\" xml:lang=\"en\">\n+\t<title>test</title>\n+\t<desc>description</desc>\n+\t<title>link</title>\n+\t<rect width=\"50\" height=\"50\"/>\n+\t<foo>invalid but reported as USAGE</foo>\n+</svg>\n", "test_patch": "diff --git a/src/test/resources/epub-region-nav/region-nav-publication.feature b/src/test/resources/epub-region-nav/region-nav-publication.feature\nindex 9432cc9..374049b 100644\n--- a/src/test/resources/epub-region-nav/region-nav-publication.feature\n+++ b/src/test/resources/epub-region-nav/region-nav-publication.feature\n@@ -91,4 +91,5 @@ Feature: EPUB Region-Based Navigation \u25b8 Full Publication Checks\n \n   Scenario: Verify subregion navigation using comics semantics\n     When checking EPUB 'region-based-nav-comics-valid'\n+    Then error RSC-005 is reported 4 times (non-palpable content)\n     Then no errors or warnings are reported\ndiff --git a/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml b/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml\nindex ca20cf6..43a520e 100644\n--- a/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml\n@@ -1,6 +1,6 @@\n <!DOCTYPE html>\n <html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head epub:type=\"document\">\n+\t<head>\n \t\t<meta charset=\"utf-8\"/>\n \t\t<title>Minimal EPUB</title>\n \t</head>\ndiff --git a/src/test/resources/epub3/06-content-document/content-document-svg.feature b/src/test/resources/epub3/06-content-document/content-document-svg.feature\nindex e0933e7..4ee6b69 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-svg.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-svg.feature\n@@ -30,6 +30,27 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 SVG\n     When checking EPUB 'content-svg-file-extension-unusual-valid'\n     Then no errors or warnings are reported\n \n+  @spec @xref:sec-svg-req\n+  Scenario: Verify that SVG validation erors are reported as USAGE\n+    Given the reporting level set to usage\n+    When checking document 'svg-invalid-usage.svg'\n+    Then usage RSC-025 is reported\n+    And the message contains 'element \"foo\" not allowed here'\n+    And no other errors or warnings are reported\n+\n+\t@spec @xref:sec-svg-req\n+  Scenario: Allow `epub:type` on structural, shape, and text elements\n+    Given the reporting level is set to USAGE\n+    When checking document 'epubtype-valid.svg'\n+    Then no other errors or warnings are reported\n+\n+\t@spec @xref:sec-svg-req\n+  Scenario: Report an `epub:type` attribute used on an element where it is not allowed\n+    When checking document 'epubtype-not-allowed-error.svg'\n+    Then error RSC-005 is reported 3 times\n+    And the message contains '\"epub:type\" not allowed'\n+    And no other errors or warnings are reported\n+\n   \n   ### 6.2.2 SVG requirements\n \ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex bf04be5..c7c2bdc 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -685,11 +685,13 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n   Scenario: Verify `epub:type` attribute with valid semantic\n     When checking document 'epubtype-valid.xhtml'\n     Then no errors or warnings are reported\n-  \n-  Scenario: Verify `epub:type` attribute in document header\n-    When checking document 'epubtype-in-head-valid.xhtml'\n-    Then no errors or warnings are reported\n \n+  @spec @xref:sec-xhtml-structural-semantics\n+  Scenario: Report `epub:type` attribute on non-palpable content\n+    When checking document 'epubtype-on-non-palpable-content-error.xhtml'\n+    Then error RSC-005 is reported 2 times\n+    And no other errors or warnings are reported\n+  \n   Scenario: Verify `epub:type` attribute with reserved vocabulary\n     When checking document 'epubtype-reserved-vocab-valid.xhtml'\n     Then no errors or warnings are reported\n@@ -714,6 +716,7 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n   Scenario: Verify `epub:type` attribute that does not follow usage suggestions\n     Given the reporting level set to usage\n     When checking document 'epubtype-disallowed-usage.xhtml'\n+    Then error RSC-005 is reported 3 times (non-palpable content)\n     Then usage OPF-087 is reported 7 times\n     And no other errors or warnings are reported\n \ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-in-head-valid.xhtml b/src/test/resources/epub3/06-content-document/files/epubtype-in-head-valid.xhtml\ndeleted file mode 100644\nindex 419528e..0000000\n--- a/src/test/resources/epub3/06-content-document/files/epubtype-in-head-valid.xhtml\n+++ /dev/null\n@@ -1,12 +0,0 @@\n-<!DOCTYPE html>\t \n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\"\n-\tepub:prefix=\"my: https://example.org/vocab/#\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>epub:type in head element</title>\n-\t\t<meta name=\"creator\" content=\"Herman Melville\" epub:type=\"my:creator\" />\n-\t</head>\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg b/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg\nindex cbd2310..26dcf3e 100644\n--- a/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg\n@@ -1,8 +1,12 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n-\txmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"1.1\">\n-\t<title class=\"foo\" epub:type=\"body\">Test</title>\n+\txmlns:epub=\"http://www.idpf.org/2007/ops\"\n+\tepub:type=\"chapter\"\n+\tversion=\"1.1\">\n+\t<title epub:type=\"title\">invalid</title>\n+\t<desc epub:type=\"tip\">epub:type is not allowed on `title` or `desc`</desc>\n \t<desc>Rectangle</desc>\n \t<defs> </defs>\n \t<rect x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+\t<foo epub:type=\"tip\"/>\n </svg>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T22:55:41.594968Z", "commit_hash": "8631b7d632f5c85b4064c1b6d77368a7aebdd629", "commit_message": "feat: restrict SVG title element to HTML elements\n\nThis commit updates the content model of the SVG title element to allow\nany text or HTML elements, but reject any non-HTML element.\n\n- use NVDL to reject non-HTML namespaces\n- the master XHTML schema is now the NVDL schema\n- add an element class to include all HTML elements\n\nFix #1342\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java b/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java\nindex 3f3bc88..8487674 100755\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSChecker.java\n@@ -56,7 +56,7 @@ public class OPSChecker extends PublicationResourceChecker\n       .putAll(Predicates.and(mimetype(\"application/xhtml+xml\"), version(EPUBVersion.VERSION_2)),\n           XMLValidators.XHTML_20_NVDL, XMLValidators.XHTML_20_SCH, XMLValidators.IDUNIQUE_20_SCH)\n       .putAll(Predicates.and(mimetype(\"application/xhtml+xml\"), version(EPUBVersion.VERSION_3)),\n-          XMLValidators.XHTML_30_RNC, XMLValidators.XHTML_30_SCH, XMLValidators.SVG_INFORMATIVE_30_NVDL)\n+          XMLValidators.XHTML_30_NVDL, XMLValidators.SVG_INFORMATIVE_30_NVDL)\n       .putAll(Predicates.and(mimetype(\"image/svg+xml\"), version(EPUBVersion.VERSION_2)),\n           XMLValidators.SVG_20_NVDL, XMLValidators.IDUNIQUE_20_SCH)\n       .putAll(Predicates.and(mimetype(\"image/svg+xml\"), version(EPUBVersion.VERSION_3)),\ndiff --git a/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java b/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java\nindex eb5ffe3..d2f6307 100644\n--- a/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java\n+++ b/src/main/java/com/adobe/epubcheck/xml/XMLValidators.java\n@@ -45,6 +45,7 @@ public enum XMLValidators\n   XHTML_20_SCH(\"schema/20/sch/xhtml.sch\"),\n   XHTML_30_SCH(\"schema/30/epub-xhtml-30.sch\"),\n   XHTML_30_RNC(\"schema/30/epub-xhtml-30.rnc\"),\n+  XHTML_30_NVDL(\"schema/30/epub-xhtml-30.nvdl\"),\n   XHTML_EDUPUB_STRUCTURE_SCH(\"schema/30/edupub/edu-structure.sch\"),\n   XHTML_EDUPUB_SEMANTICS_SCH(\"schema/30/edupub/edu-semantics.sch\"),\n   XHTML_DATANAV_SCH(\"schema/30/datanav/datanav-xhtml.sch\"),\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.nvdl b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.nvdl\nindex 0bcd7ca..8f974c8 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.nvdl\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.nvdl\n@@ -5,6 +5,7 @@\n \t\t\t<validate schema=\"epub-svg-30.rnc\" schemaType=\"application/relax-ng-compact-syntax\"\n \t\t\t\tuseMode=\"allowForeignNS\">\n \t\t\t\t<context path=\"foreignObject\" useMode=\"attachAnyNS\"/>\n+\t\t\t\t<context path=\"title\" useMode=\"allowOnlyHTML\"/>\n \t\t\t</validate>\n \t\t\t<validate schema=\"epub-svg-30.sch\" useMode=\"attachAnyNS\"/>\n \t\t</namespace>\n@@ -34,4 +35,27 @@\n \t\t\t<attach/>\n \t\t</anyNamespace>\n \t</mode>\n+\t<mode name=\"allowOnlyHTML\">\n+\t\t<namespace ns=\"http://www.w3.org/1999/xhtml\">\n+\t\t\t<attach/>\n+\t\t</namespace>\n+\t\t<namespace ns=\"http://www.idpf.org/2007/ops\" match=\"attributes\">\n+\t\t\t<attach/>\n+\t\t</namespace>\n+\t\t<namespace ns=\"http://www.w3.org/1999/xlink\" match=\"attributes\">\n+\t\t\t<attach/>\n+\t\t</namespace>\n+\t\t<namespace ns=\"http://www.w3.org/XML/1998/namespace\" match=\"attributes\">\n+\t\t\t<attach/>\n+\t\t</namespace>\n+\t\t<namespace ns=\"\" match=\"attributes\">\n+\t\t\t<attach/>\n+\t\t</namespace>\n+\t\t<anyNamespace match=\"attributes\">\n+\t\t\t<allow/>\n+\t\t</anyNamespace>\n+\t\t<anyNamespace>\n+\t\t\t<reject/>\n+\t\t</anyNamespace>\n+\t</mode>\n </rules>\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc\nindex 887e9b7..d703cd6 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-30.rnc\n@@ -1,12 +1,12 @@\n namespace svg = \"http://www.w3.org/2000/svg\"\n \n-include \"./mod/epub-xhtml.rnc\" {\n+include \"./mod/epub-xhtml-inc.rnc\" {\n   start = svg\n }\n include \"./mod/epub-mathml3.rnc\"\n include \"./mod/epub-svg-inc.rnc\"\n \n-svg.title.content |= common.elem.phrasing\n+svg.title.content |= common.inner.anyhtml\n \n svg.foreignObject.content |= \n   ( body.elem\n@@ -14,4 +14,4 @@ svg.foreignObject.content |=\n   | math \n   )\n \n-mtext.content |= common.elem.phrasing\n\\ No newline at end of file\n+mtext.content |= common.elem.phrasing\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc\nindex 06db5f9..5df35a5 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-svg-informative.rnc\n@@ -17,14 +17,5 @@ SVG.Core.attrib &= aria.global?\n SVG.Core.extra.attrib &= epub.type.attr?\n \n ## Do not check restricted elements, they are checked in normative schemas\n-SVG.foreignObject.content |= any.content\n-SVG.title.content |= any.content\n-\n-## Anything\n-\n-## Any attribute from any namespace, other than the special cases\n-any.attr = attribute * { text }*\n-## Any element from any namespace, other than the special cases\n-any.elem = element * { any.content & any.attr }\n-## Any content from any namespace\n-any.content = text & any.elem*\n\\ No newline at end of file\n+SVG.foreignObject.content |= common.inner.anything\n+SVG.title.content |= common.inner.anything \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.nvdl b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.nvdl\nindex 82a04c1..4f3623a 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.nvdl\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.nvdl\n@@ -1,15 +1,46 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<rules xmlns=\"http://purl.oclc.org/dsdl/nvdl/ns/structure/1.0\" startMode=\"html\">\n+<rules xmlns=\"http://purl.oclc.org/dsdl/nvdl/ns/structure/1.0\"\n+  xmlns:svg=\"http://www.w3.org/2000/svg\" startMode=\"html\">\n   <mode name=\"html\">\n     <namespace ns=\"http://www.w3.org/1999/xhtml\">\n       <validate schema=\"epub-xhtml-30.rnc\" schemaType=\"application/relax-ng-compact-syntax\"\n-        useMode=\"attach\"/>\n+        useMode=\"attach\">\n+        <context path=\"title\" useMode=\"allowOnlyHTML\"/>\n+      </validate>\n       <validate schema=\"epub-xhtml-30.sch\" useMode=\"attach\"/>\n     </namespace>\n   </mode>\n   <mode name=\"attach\">\n+    <namespace ns=\"http://www.w3.org/2000/svg\">\n+      <attach>\n+        <context path=\"title\" useMode=\"allowOnlyHTML\"/>\n+      </attach>\n+    </namespace>\n     <anyNamespace>\n       <attach/>\n     </anyNamespace>\n   </mode>\n+  <mode name=\"allowOnlyHTML\">\n+    <namespace ns=\"http://www.w3.org/1999/xhtml\">\n+      <attach/>\n+    </namespace>\n+    <namespace ns=\"http://www.idpf.org/2007/ops\" match=\"attributes\">\n+      <attach/>\n+    </namespace>\n+    <namespace ns=\"http://www.w3.org/1999/xlink\" match=\"attributes\">\n+      <attach/>\n+    </namespace>\n+    <namespace ns=\"http://www.w3.org/XML/1998/namespace\" match=\"attributes\">\n+      <attach/>\n+    </namespace>\n+    <namespace ns=\"\" match=\"attributes\">\n+      <attach/>\n+    </namespace>\n+    <anyNamespace match=\"attributes\">\n+      <allow/>\n+    </anyNamespace>\n+    <anyNamespace>\n+      <reject/>\n+    </anyNamespace>\n+  </mode>\n </rules>\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc\nindex 408574f..17c4545 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.rnc\n@@ -1,6 +1,6 @@\n namespace svg = \"http://www.w3.org/2000/svg\"\n \n-include \"./mod/epub-xhtml.rnc\"\n+include \"./mod/epub-xhtml-inc.rnc\"\n include \"./mod/epub-mathml3.rnc\"\n include \"./mod/epub-svg-inc.rnc\" {\n   svg.attr.id = attribute id { datatype.html5.token }?\n@@ -11,7 +11,7 @@ common.elem.phrasing |= math\n \n math.attributes &= aria.global?\n \n-svg.title.content |= common.elem.phrasing\n+svg.title.content |= common.inner.anyhtml\n \n svg.foreignObject.content |= \n   ( common.inner.flow\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.sch b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.sch\nindex 5cae167..4b967b8 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.sch\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/epub-xhtml-30.sch\n@@ -152,11 +152,6 @@\n         <param name=\"descendant\" value=\"h:label\"/>\n     </pattern>\n \n-    <pattern id=\"descendant-svgtitle-svg\" is-a=\"disallowed-descendants\">\n-        <param name=\"ancestor\" value=\"svg:title\"/>\n-        <param name=\"descendant\" value=\"svg:*\"/>\n-    </pattern>\n-\n     <pattern id=\"bdo-dir\" is-a=\"required-attr\">\n         <param name=\"elem\" value=\"h:bdo\"/>\n         <param name=\"attr\" value=\"dir\"/>\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc\nindex eac8629..9acad78 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-svg-inc.rnc\n@@ -27,7 +27,7 @@ svg.foreignObject.content = notAllowed\n ### SVG title element restrictions\n svg.title =\n   element title { any.attr & svg.title.content }\n-svg.title.content = text\n+svg.title.content = text \n \n ## Anything\n \ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc\nnew file mode 100644\nindex 0000000..f8dcae8\n--- /dev/null\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/mod/epub-xhtml-inc.rnc\n@@ -0,0 +1,18 @@\n+\n+# #####################################################################\n+##  RELAX NG Schema for EPUB HTML 5: For inclusion in master schema   #\n+# #####################################################################\n+\n+## Include the main XHTML schema\n+\n+include \"./epub-xhtml.rnc\"\n+\n+## HTML fragments\n+\n+# Note: the default HMTL schema does not define such a category, so we\n+# do our best to include what makes sense here\n+\n+  common.inner.anyhtml = \n+      html.elem\n+    | body.elem\n+    | common.inner.flow\ndiff --git a/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg b/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg\nnew file mode 100644\nindex 0000000..cbd2310\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/epubtype-not-allowed-error.svg\n@@ -0,0 +1,8 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n+\txmlns:epub=\"http://www.idpf.org/2007/ops\" version=\"1.1\">\n+\t<title class=\"foo\" epub:type=\"body\">Test</title>\n+\t<desc>Rectangle</desc>\n+\t<defs> </defs>\n+\t<rect x=\"10\" y=\"20\" width=\"75\" height=\"30\" style=\"stroke: #333366; fill: #6666cc\"/>\n+</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-content-invalid-html-error.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-content-invalid-html-error.xhtml\nnew file mode 100644\nindex 0000000..7fdd9b9\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/svg-title-content-invalid-html-error.xhtml\n@@ -0,0 +1,15 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Test</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Test</h1>\n+\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n+\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n+\t\t\t<title><span href=\"#error\" xmlns=\"http://www.w3.org/1999/xhtml\">title</span></title>\n+\t\t\t<desc>Example</desc>\n+\t\t</svg>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-content-not-html-error.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-content-not-html-error.xhtml\nnew file mode 100644\nindex 0000000..6b063e8\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/svg-title-content-not-html-error.xhtml\n@@ -0,0 +1,26 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Test</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Test</h1>\n+\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n+\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n+\t\t\t<title>Test</title>\n+\t\t\t<desc>Non-HTML content</desc>\n+\t\t\t<g>\n+\t\t\t\t<title><not:html xmlns:not=\"https://example.org\">not HTML</not:html></title>\n+\t\t\t</g>\n+\t\t\t<g>\n+\t\t\t\t<title><body xmlns=\"http://www.w3.org/1999/xhtml\">\n+\t\t\t\t\t\t<svg xmlns=\"http://www.w3.org/2000/svg\">\n+\t\t\t\t\t\t\t<title>Inner SVG</title>\n+\t\t\t\t\t\t\t<desc>Disallowed</desc>\n+\t\t\t\t\t\t</svg>\n+\t\t\t\t\t</body></title>\n+\t\t\t</g>\n+\t\t</svg>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-content-valid.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-content-valid.xhtml\nnew file mode 100644\nindex 0000000..f03257c\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/svg-title-content-valid.xhtml\n@@ -0,0 +1,35 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Test</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Test</h1>\n+\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n+\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n+\t\t\t<title>title</title>\n+\t\t\t<desc>Example</desc>\n+\t\t\t<g>\n+\t\t\t\t<title>Plain text</title>\n+\t\t\t</g>\n+\t\t\t<g>\n+\t\t\t\t<title><span xmlns=\"http://www.w3.org/1999/xhtml\">html phrasing content</span></title>\n+\t\t\t</g>\n+\t\t\t<g>\n+\t\t\t\t<title><h1 xmlns=\"http://www.w3.org/1999/xhtml\">html flow content</h1></title>\n+\t\t\t</g>\n+\t\t\t<g>\n+\t\t\t\t<title><body xmlns=\"http://www.w3.org/1999/xhtml\">html non-categorized elements</body></title>\n+\t\t\t</g>\n+\t\t\t<g>\n+\t\t\t\t<title>some <span xmlns=\"http://www.w3.org/1999/xhtml\">mixed</span> content</title>\n+\t\t\t</g>\n+\t\t\t<g>\n+\t\t\t\t<title><html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"en\">\n+\t\t\t\t\t<head><title>full html document</title></head><body>\u2026</body></html>\n+\t\t\t\t</title>\n+\t\t\t</g>\n+\t\t</svg>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-content-invalid-html-error.svg b/src/test/resources/epub3/06-content-document/files/title-content-invalid-html-error.svg\nnew file mode 100644\nindex 0000000..da59926\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/title-content-invalid-html-error.svg\n@@ -0,0 +1,8 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title><span href=\"#invalid\" xmlns=\"http://www.w3.org/1999/xhtml\">SVG Test</span></title>\n+\t<desc>Rectangle</desc>\n+\t<g>\n+\t\t<title>test <body xmlns=\"http://www.w3.org/1999/xhtml\">SVG Test</body></title>\n+\t</g>\n+</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-content-not-html-error.svg b/src/test/resources/epub3/06-content-document/files/title-content-not-html-error.svg\nnew file mode 100644\nindex 0000000..557da65\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/title-content-not-html-error.svg\n@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n+\t<title>SVG Test</title>\n+\t<desc>Rectangle</desc>\n+\t<g>\n+\t\t<title><not:html xmlns:not=\"https://example.org\">not HTML</not:html></title>\n+\t</g>\n+\t<g>\n+\t\t<title><body xmlns=\"http://www.w3.org/1999/xhtml\">\n+\t\t\t\t<svg xmlns=\"http://www.w3.org/2000/svg\">\n+\t\t\t\t\t<title>Inner SVG</title>\n+\t\t\t\t\t<desc>Disallowed</desc>\n+\t\t\t\t</svg>\n+\t\t\t</body></title>\n+\t</g>\n+</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-content-valid.svg b/src/test/resources/epub3/06-content-document/files/title-content-valid.svg\nnew file mode 100644\nindex 0000000..6adbda3\n--- /dev/null\n+++ b/src/test/resources/epub3/06-content-document/files/title-content-valid.svg\n@@ -0,0 +1,26 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\"\n+\txmlns:h=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\">\n+\t<title>SVG Test</title>\n+\t<desc>Rectangle</desc>\n+\t<g>\n+\t\t<title>Plain text</title>\n+\t</g>\n+\t<g>\n+\t\t<title><h:span>html phrasing content</h:span></title>\n+\t</g>\n+\t<g>\n+\t\t<title><h:h1>html flow content</h:h1></title>\n+\t</g>\n+\t<g>\n+\t\t<title><h:body>html non-categorized elements</h:body></title>\n+\t</g>\n+\t<g>\n+\t\t<title>some <h:span>mixed</h:span> content</title>\n+\t</g>\n+\t<g>\n+\t\t<title><html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"en\">\n+\t\t\t<head><title>full html document</title></head><body>\u2026</body></html>\n+\t\t</title>\n+\t</g>\n+</svg>\n", "test_patch": "diff --git a/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml b/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml\nindex ea29a16..ca20cf6 100644\n--- a/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml\n+++ b/src/test/resources/epub3/00-minimal/files/minimal/EPUB/content_001.xhtml\n@@ -1,6 +1,6 @@\n <!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n+<html xmlns:epub=\"http://www.idpf.org/2007/ops\" xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head epub:type=\"document\">\n \t\t<meta charset=\"utf-8\"/>\n \t\t<title>Minimal EPUB</title>\n \t</head>\ndiff --git a/src/test/resources/epub3/06-content-document/content-document-svg.feature b/src/test/resources/epub3/06-content-document/content-document-svg.feature\nindex 6b7ad86..e0933e7 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-svg.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-svg.feature\n@@ -101,6 +101,8 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 SVG\n \n   ###  6.2.3 Restrictions on SVG\n \n+\t#### `foreignObject` element\n+\t\n   @spec @xref:sec-svg-restrictions\n   Scenario: Verify that `foreignObject` conforming to the rules is allowed\n     When checking document 'foreignObject-valid.svg'\n@@ -132,32 +134,35 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 SVG\n     And the message contains 'element \"body\" not allowed here'\n     And no other errors or warnings are reported\n     \n+  @spec @xref:sec-svg-restrictions\n   Scenario: Report HTML validation errors within `foreignObject` content\n     When checking document 'foreignObject-html-invalid-error.svg'\n     Then error RSC-005 is reported\n     And the message contains 'attribute \"href\" not allowed here'\n     And no other errors or warnings are reported\n \n-  @spec @xref:sec-svg-restrictions\n-  Scenario: Verify `title` can contain text\n-    When checking document 'title-text-valid.svg'\n-    Then no errors or warnings are reported\n+\t#### `title` element\n \n   @spec @xref:sec-svg-restrictions\n-  Scenario: Verify `title` can contain HTML phrasing content\n-    When checking document 'title-phrasing-content-valid.svg'\n+  Scenario: Verify `title` valid content model\n+    When checking document 'title-content-valid.svg'\n     Then no errors or warnings are reported\n \n   @spec @xref:sec-svg-restrictions\n-  Scenario: Report `title` with non-phrasing content\n-    When checking document 'title-not-phrasing-content-error.svg'\n+  Scenario: Report `title` with non-HTML elements\n+    When checking document 'title-content-not-html-error.svg'\n+    Then error RSC-005 is reported\n+    And the message contains 'elements from namespace \"https://example.org\" are not allowed'\n     Then error RSC-005 is reported\n-    And the message contains 'element \"h1\" not allowed here'\n+    And the message contains 'elements from namespace \"http://www.w3.org/2000/svg\" are not allowed'\n     And no other errors or warnings are reported\n     \n+  @spec @xref:sec-svg-restrictions\n   Scenario: Report HTML validation errors within `title` content\n-    When checking document 'title-html-invalid-error.svg'\n+    When checking document 'title-content-invalid-html-error.svg'\n     Then error RSC-005 is reported\n     And the message contains 'attribute \"href\" not allowed here'\n+    Then error RSC-005 is reported\n+    And the message contains 'element \"body\" not allowed here'\n     And no other errors or warnings are reported\n \ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex 0fa079f..bf04be5 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -985,22 +985,20 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n     And the message contains 'element \"title\" not allowed here'\n     And no other errors or warnings are reported\n \n-  Scenario: Verify `title` can contain text\n-    When checking document 'svg-title-text-valid.xhtml'\n+  Scenario: Verify `title` valid content model\n+    When checking document 'svg-title-content-valid.xhtml'\n     Then no errors or warnings are reported\n \n-  Scenario: Verify `title` can contain HTML phrasing content\n-    When checking document 'svg-title-phrasing-content-valid.xhtml'\n-    Then no errors or warnings are reported\n-\n-  Scenario: Report `title` with non-phrasing content\n-    When checking document 'svg-title-not-phrasing-content-error.xhtml'\n+  Scenario: Report `title` with non-HTML elements\n+    When checking document 'svg-title-content-not-html-error.xhtml'\n+    Then error RSC-005 is reported\n+    And the message contains 'elements from namespace \"https://example.org\" are not allowed'\n     Then error RSC-005 is reported\n-    And the message contains 'element \"h1\" not allowed here'\n+    And the message contains 'elements from namespace \"http://www.w3.org/2000/svg\" are not allowed'\n     And no other errors or warnings are reported\n     \n   Scenario: Report HTML validation errors within `title` content\n-    When checking document 'svg-title-html-invalid-error.xhtml'\n+    When checking document 'svg-title-content-invalid-html-error.xhtml'\n     Then error RSC-005 is reported\n     And the message contains 'attribute \"href\" not allowed here'\n     And no other errors or warnings are reported\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-html-invalid-error.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-html-invalid-error.xhtml\ndeleted file mode 100644\nindex 7fdd9b9..0000000\n--- a/src/test/resources/epub3/06-content-document/files/svg-title-html-invalid-error.xhtml\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>Test</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n-\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n-\t\t\t<title><span href=\"#error\" xmlns=\"http://www.w3.org/1999/xhtml\">title</span></title>\n-\t\t\t<desc>Example</desc>\n-\t\t</svg>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-not-phrasing-content-error.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-not-phrasing-content-error.xhtml\ndeleted file mode 100644\nindex 5b4fd6e..0000000\n--- a/src/test/resources/epub3/06-content-document/files/svg-title-not-phrasing-content-error.xhtml\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>Test</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n-\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n-\t\t\t<title><h1 xmlns=\"http://www.w3.org/1999/xhtml\">title</h1></title>\n-\t\t\t<desc>Example</desc>\n-\t\t</svg>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-phrasing-content-valid.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-phrasing-content-valid.xhtml\ndeleted file mode 100644\nindex 02fc227..0000000\n--- a/src/test/resources/epub3/06-content-document/files/svg-title-phrasing-content-valid.xhtml\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>Test</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n-\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n-\t\t\t<title><span xmlns=\"http://www.w3.org/1999/xhtml\">title</span></title>\n-\t\t\t<desc>Example</desc>\n-\t\t</svg>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/svg-title-text-valid.xhtml b/src/test/resources/epub3/06-content-document/files/svg-title-text-valid.xhtml\ndeleted file mode 100644\nindex 85c11cd..0000000\n--- a/src/test/resources/epub3/06-content-document/files/svg-title-text-valid.xhtml\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>Test</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Test</h1>\n-\t\t<svg width=\"12cm\" height=\"4cm\" viewBox=\"0 0 1200 400\" version=\"1.1\"\n-\t\t\txmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n-\t\t\t<title>title</title>\n-\t\t\t<desc>Example</desc>\n-\t\t</svg>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-html-invalid-error.svg b/src/test/resources/epub3/06-content-document/files/title-html-invalid-error.svg\ndeleted file mode 100644\nindex ff287bb..0000000\n--- a/src/test/resources/epub3/06-content-document/files/title-html-invalid-error.svg\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n-\t<title><span href=\"#invalid\" xmlns=\"http://www.w3.org/1999/xhtml\">SVG Test</span></title>\n-\t<desc>Rectangle</desc>\n-</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-not-phrasing-content-error.svg b/src/test/resources/epub3/06-content-document/files/title-not-phrasing-content-error.svg\ndeleted file mode 100644\nindex 5e57720..0000000\n--- a/src/test/resources/epub3/06-content-document/files/title-not-phrasing-content-error.svg\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n-\t<title><h1 xmlns=\"http://www.w3.org/1999/xhtml\">SVG Test</h1></title>\n-\t<desc>Rectangle</desc>\n-</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-phrasing-content-valid.svg b/src/test/resources/epub3/06-content-document/files/title-phrasing-content-valid.svg\ndeleted file mode 100644\nindex af7f1a5..0000000\n--- a/src/test/resources/epub3/06-content-document/files/title-phrasing-content-valid.svg\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n-\t<title><span xmlns=\"http://www.w3.org/1999/xhtml\">SVG Test</span></title>\n-\t<desc>Rectangle</desc>\n-</svg>\ndiff --git a/src/test/resources/epub3/06-content-document/files/title-text-valid.svg b/src/test/resources/epub3/06-content-document/files/title-text-valid.svg\ndeleted file mode 100644\nindex 9e68f0f..0000000\n--- a/src/test/resources/epub3/06-content-document/files/title-text-valid.svg\n+++ /dev/null\n@@ -1,5 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<svg viewBox=\"0 0 1200 400\" xmlns=\"http://www.w3.org/2000/svg\" xml:lang=\"en\">\n-\t<title>SVG Test</title>\n-\t<desc>Rectangle</desc>\n-</svg>\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T23:02:54.167527Z", "commit_hash": "308625849c74be678610083bec62af58aaac6905", "commit_message": "feat: update checking of the package rendering vocabulary\n\n- deprecated properties are now reported as `OPF-086`, like for other\n  deprecated properties, instead of `RSC-017`.\n  This means the check relies on the `Property#isDeprecated` facility,\n  instead of custom Schematron code.\n- deprecated property value is checked in custom Java code the\n  `OPFHandler30#processMeta()` method.\n- verify that custom properties cannot be defined using the reserved\n  \"rendition\" prefix. A new feature file is added for this single test,\n  to match the spec section ordering.\n\nFix #1327\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\nindex c214f05..a6055fc 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n@@ -58,6 +58,7 @@ import org.w3c.epubcheck.url.URLUtils;\n \n import com.adobe.epubcheck.api.EPUBLocation;\n import com.adobe.epubcheck.api.QuietReport;\n+import com.adobe.epubcheck.messages.LocalizedMessages;\n import com.adobe.epubcheck.messages.MessageId;\n import com.adobe.epubcheck.opf.ResourceCollection.Roles;\n import com.adobe.epubcheck.opf.XRefChecker.Type;\n@@ -592,8 +593,9 @@ public class OPFHandler30 extends OPFHandler\n \n     if (prop.isPresent() && !metadataBuilders.isEmpty())\n     {\n+      String value = Strings.nullToEmpty((String) e.getPrivateData()).trim();\n       metadataBuilders.peekFirst().meta(e.getAttribute(\"id\"), prop.get(),\n-          (String) e.getPrivateData(), e.getAttribute(\"refines\"));\n+          value, e.getAttribute(\"refines\"));\n \n       // Primary metadata checks\n       if (metadataBuilders.size() == 1)\n@@ -608,6 +610,14 @@ public class OPFHandler30 extends OPFHandler\n           context.featureReport.report(FeatureEnum.MEDIA_OVERLAYS_PLAYBACK_ACTIVE_CLASS, location(),\n               e.getPrivateData().toString());\n           break;\n+        case \"rendition:spread\":\n+          if (value.equals(\"portrait\"))\n+          {\n+            report.message(MessageId.OPF_086, location(), \"rendition:spread portrait\",\n+                LocalizedMessages.getInstance(context.locale)\n+                    .getSuggestion(MessageId.OPF_086, null));\n+          }\n+          break;\n         default:\n           break;\n         }\ndiff --git a/src/main/java/com/adobe/epubcheck/vocab/RenditionVocabs.java b/src/main/java/com/adobe/epubcheck/vocab/RenditionVocabs.java\nindex 88d790e..1525e08 100644\n--- a/src/main/java/com/adobe/epubcheck/vocab/RenditionVocabs.java\n+++ b/src/main/java/com/adobe/epubcheck/vocab/RenditionVocabs.java\n@@ -1,43 +1,96 @@\n package com.adobe.epubcheck.vocab;\n \n+import com.adobe.epubcheck.opf.ValidationContext;\n+import com.google.common.base.Preconditions;\n+\n public final class RenditionVocabs\n {\n   public static final String PREFIX = \"rendition\";\n   public static final String URI = \"http://www.idpf.org/vocab/rendition/#\";\n \n   public static final EnumVocab<META_PROPERTIES> META_VOCAB = new EnumVocab<META_PROPERTIES>(\n-      META_PROPERTIES.class, URI);\n+      META_PROPERTIES.class, URI, PREFIX);\n \n-  public enum META_PROPERTIES\n+  public enum META_PROPERTIES implements PropertyStatus\n   {\n-    FLOW,\n     LAYOUT,\n     ORIENTATION,\n     SPREAD,\n-    VIEWPORT\n+    VIEWPORT(DEPRECATED),\n+    FLOW;\n+\n+    private final PropertyStatus status;\n+\n+    private META_PROPERTIES()\n+    {\n+      this(ALLOWED);\n+    }\n+\n+    private META_PROPERTIES(PropertyStatus status)\n+    {\n+      this.status = Preconditions.checkNotNull(status);\n+    }\n+\n+    @Override\n+    public boolean isAllowed(ValidationContext context)\n+    {\n+      return status.isAllowed(context);\n+    }\n+\n+    @Override\n+    public boolean isDeprecated()\n+    {\n+      return status.isDeprecated();\n+    }\n   }\n \n   public static final EnumVocab<ITEMREF_PROPERTIES> ITEMREF_VOCAB = new EnumVocab<ITEMREF_PROPERTIES>(\n       ITEMREF_PROPERTIES.class, URI);\n \n-  public enum ITEMREF_PROPERTIES\n+  public enum ITEMREF_PROPERTIES implements PropertyStatus\n   {\n-    ALIGN_X_CENTER,\n-    FLOW_AUTO,\n-    FLOW_PAGINATED,\n-    FLOW_SCROLLED_CONTINUOUS,\n-    FLOW_SCROLLED_DOC,\n     LAYOUT_PRE_PAGINATED,\n     LAYOUT_REFLOWABLE,\n     ORIENTATION_AUTO,\n     ORIENTATION_LANDSCAPE,\n     ORIENTATION_PORTRAIT,\n-    PAGE_SPREAD_CENTER,\n     SPREAD_AUTO,\n     SPREAD_BOTH,\n     SPREAD_LANDSCAPE,\n     SPREAD_NONE,\n-    SPREAD_PORTRAIT\n+    SPREAD_PORTRAIT(DEPRECATED),\n+    PAGE_SPREAD_CENTER,\n+    PAGE_SPREAD_LEFT,\n+    PAGE_SPREAD_RIGHT,\n+    FLOW_PAGINATED,\n+    FLOW_SCROLLED_CONTINUOUS,\n+    FLOW_SCROLLED_DOC,\n+    FLOW_AUTO,\n+    ALIGN_X_CENTER;\n+\n+    private final PropertyStatus status;\n+\n+    private ITEMREF_PROPERTIES()\n+    {\n+      this(ALLOWED);\n+    }\n+\n+    private ITEMREF_PROPERTIES(PropertyStatus status)\n+    {\n+      this.status = Preconditions.checkNotNull(status);\n+    }\n+\n+    @Override\n+    public boolean isAllowed(ValidationContext context)\n+    {\n+      return status.isAllowed(context);\n+    }\n+\n+    @Override\n+    public boolean isDeprecated()\n+    {\n+      return status.isDeprecated();\n+    }\n   }\n \n   private RenditionVocabs()\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch b/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch\nindex c444c5a..44f7dad 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch\n@@ -455,24 +455,8 @@\n \t\t</rule>\n \t</pattern>\n \t\n-\t<pattern id=\"opf.meta.viewport.deprecated\">\n-\t\t<rule context=\"opf:metadata/opf:meta[normalize-space(@property)='rendition:viewport']\">\n-\t\t\t<report test=\".\">WARNING: Use of the rendition:viewport property is deprecated</report>\n-\t\t</rule>\n-\t</pattern>\n-\t\n-\t<pattern id=\"opf.meta.spread.portrait.deprecated\">\n-\t\t<rule context=\"opf:metadata/opf:meta[normalize-space(@property)='rendition:spread']\">\n-\t\t\t<report test=\". = 'portrait'\">WARNING: Use of the rendition:spread value \"portrait\" is deprecated in favour of the value \"both\"</report>\n-\t\t</rule>\n-\t</pattern>\n-\t\n-\t<pattern id=\"opf.itemref.spread.portrait.deprecated\">\n-\t\t<rule context=\"opf:spine/opf:itemref[@properties]\">\n-\t\t\t<report test=\"tokenize(@properties,'\\s+')='rendition:spread-portrait'\">WARNING: Use of the \"rendition:spread-portrait\" spine override is deprecated in favour of \"rendition:spread-both\"</report>\n-\t\t</rule>\n-\t</pattern>\n-\t\n+\n+  <!--FIXME deprecation should be in vocab-->\n \t<pattern id=\"opf.meta.meta-auth.deprecated\">\n \t\t<rule context=\"opf:metadata/opf:meta[normalize-space(@property)='meta-auth']\">\n \t\t\t<report test=\".\">WARNING: Use of the meta-auth property is deprecated</report>\ndiff --git a/src/test/resources/epub3/D-vocabularies/files/rendition-property-unknown-error.opf b/src/test/resources/epub3/D-vocabularies/files/rendition-property-unknown-error.opf\nnew file mode 100644\nindex 0000000..45c0110\n--- /dev/null\n+++ b/src/test/resources/epub3/D-vocabularies/files/rendition-property-unknown-error.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" unique-identifier=\"uid\"\n+  xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <metadata>\n+    <dc:identifier id=\"uid\">NOID</dc:identifier>\n+    <dc:title>Title</dc:title>\n+    <dc:language>en</dc:language>\n+    <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n+    <meta property=\"rendition:unknown\">error</meta>\n+  </metadata>\n+  <manifest>\n+    <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"t001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/D-vocabularies/package-rendering-vocab.feature b/src/test/resources/epub3/D-vocabularies/package-rendering-vocab.feature\nnew file mode 100644\nindex 0000000..7ccd1a6\n--- /dev/null\n+++ b/src/test/resources/epub3/D-vocabularies/package-rendering-vocab.feature\n@@ -0,0 +1,24 @@\n+Feature: EPUB 3 \u2014 Vocabularies \u2014 Package rendering vocabulary\n+\n+\n+  Checks conformance to the \"Package rendering vocabulary\" section of the EPUB 3.3 specification:\n+    https://www.w3.org/TR/epub-33/#app-rendering-vocab\n+\n+\n+  Background: \n+    Given EPUB test files located at '/epub3/D-vocabularies/files/'\n+    And EPUBCheck with default settings\n+    \n+  # Note: \n+  # The properties themselves are tested in the \"layout.feature\" file,\n+  # since all the properties are defined in that section and not in the\n+  # vocabulary appendix.\n+\n+  # D.5.1 Package rendering vocabulary\n+\n+  @spec @xref:sec-rendering-custom-properties\n+  Scenario: Report a custom rendition property using the 'rendition' prefix\n+    When checking file 'rendition-property-unknown-error.opf'\n+    Then error OPF-027 is reported\n+    And no other errors or warnings are reported\n+  \n", "test_patch": "diff --git a/src/test/resources/epub3/08-layout/layout.feature b/src/test/resources/epub3/08-layout/layout.feature\nindex 0beedd6..b51d2c9 100644\n--- a/src/test/resources/epub3/08-layout/layout.feature\n+++ b/src/test/resources/epub3/08-layout/layout.feature\n@@ -140,6 +140,12 @@ Feature: EPUB 3 \u2014 Layout Rendering Control\n     And the message contains \"refines\"\n     And no other errors or warnings are reported\n \n+  @spec @xref:spread\n+  Scenario: the 'rendition:spread' 'portrait' value is deprecated as a global value\n+    When checking file 'rendition-spread-portrait-global-deprecated-warning.opf'\n+    Then warning OPF-086 is reported\n+    And no other errors or warnings are reported\n+\n   #### 8.2.2.3.1 Synthetic spread overrides\n   \n   @spec @xref:spread-overrides\n@@ -154,18 +160,6 @@ Feature: EPUB 3 \u2014 Layout Rendering Control\n     And the message contains \"are mutually exclusive\"\n     And no other errors or warnings are reported\n \n-  Scenario: the 'rendition:spread' 'portrait' value is deprecated as a global value\n-    When checking file 'rendition-spread-portrait-global-deprecated-warning.opf'\n-    Then warning RSC-017 is reported\n-    And the message contains \"is deprecated\"\n-    And no other errors or warnings are reported\n-\n-  Scenario: the 'rendition:spread' 'spread-portrait' value is deprecated as a spine override\n-    When checking file 'rendition-spread-portrait-itemref-deprecated-warning.opf'\n-    Then warning RSC-017 is reported\n-    And the message contains \"is deprecated\"\n-    And no other errors or warnings are reported\n-\n \n   #### 8.2.2.4 Spread placement\n   \n@@ -181,25 +175,31 @@ Feature: EPUB 3 \u2014 Layout Rendering Control\n     And the message contains \"are mutually exclusive\"\n     And no other errors or warnings are reported\n \n+  @spec @xref:spread\n+  Scenario: the 'rendition:spread-portrait' value is deprecated as a spine override\n+    When checking file 'rendition-spread-portrait-itemref-deprecated-warning.opf'\n+    Then warning OPF-086 is reported\n+    And no other errors or warnings are reported\n+\n \n   #### 8.2.2.5 Viewport dimensions (deprecated)\n \n+\t@spec @xref:viewport\n   Scenario: the 'rendition:viewport' property is deprecated\n     When checking file 'rendition-viewport-deprecated-warning.opf'\n-    Then warning RSC-017 is reported\n-    And the message contains \"is deprecated\"\n+    Then warning OPF-086 is reported\n     And no other errors or warnings are reported\n \n   Scenario: the 'rendition:viewport' property syntax errors are reported\n     When checking file 'rendition-viewport-syntax-error.opf'\n-    Then warning RSC-017 is reported (since 'viewport' is deprecated)\n+    Then warning OPF-086 is reported (since 'viewport' is deprecated)\n     And error RSC-005 is reported\n     And the message contains 'The value of the \"rendition:viewport\" property must be of the form'\n     And no other errors or warnings are reported\n \n   Scenario: the 'rendition:viewport' property cannot be declared more than once\n     When checking file 'rendition-viewport-duplicate-error.opf'\n-    Then warning RSC-017 is reported 2 times (since 'viewport' is deprecated)\n+    Then warning OPF-086 is reported 2 times (since 'viewport' is deprecated)\n     And error RSC-005 is reported\n     And the message contains 'The \"rendition:viewport\" property must not occur more than one time as a global value'\n     And no other errors or warnings are reported\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T23:08:43.657423Z", "commit_hash": "3199b8146b9b5c51d2bd5d46ec7d0b3cb1012dda", "commit_message": "feat: new requirements of package link 'media-type' attribute\n\nThis commit implements the new requirements of the `media-type` attribute\nof the package document `link` element.\n\n- new `OPF-093` error is reported when the `media-type` attribute is\n  missing on linked resources located inside the EPUB container\n- new `OPF-094` error is reported when the `media-type` attribute is\n  missing on a link where the `rel` keyword  requires it (this was\n  previously checked with Schematron)\n- new `OPF-095` error is reported when the media type of a \"voicing\"\n  linked resource is not an audio type (this was previously checked with\n  Schematron)\n\nThese new checks are implemented in Java, and the old schematron logic\nis removed.\n\nFixes #1307\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 0383b3e..613b8c5 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -283,6 +283,9 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.OPF_090, Severity.USAGE);\n     severities.put(MessageId.OPF_091, Severity.ERROR);\n     severities.put(MessageId.OPF_092, Severity.ERROR);\n+    severities.put(MessageId.OPF_093, Severity.ERROR);\n+    severities.put(MessageId.OPF_094, Severity.ERROR);\n+    severities.put(MessageId.OPF_095, Severity.ERROR);\n \n     // PKG\n     severities.put(MessageId.PKG_001, Severity.WARNING);\ndiff --git a/src/main/java/com/adobe/epubcheck/messages/MessageId.java b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\nindex 480cf65..c1f2a61 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n@@ -277,6 +277,9 @@ public enum MessageId implements Comparable<MessageId>\n   OPF_090(\"OPF-090\"),\n   OPF_091(\"OPF-091\"),\n   OPF_092(\"OPF-092\"),\n+  OPF_093(\"OPF-093\"),\n+  OPF_094(\"OPF-094\"),\n+  OPF_095(\"OPF-095\"),\n \n   // Messages relating to the entire package\n   PKG_001(\"PKG-001\"),\ndiff --git a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\nindex 86f004c..c214f05 100644\n--- a/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n+++ b/src/main/java/com/adobe/epubcheck/opf/OPFHandler30.java\n@@ -336,7 +336,7 @@ public class OPFHandler30 extends OPFHandler\n    * Document. Must be called after the parsing.\n    * \n    * @return the metadata for the Rendition represented by the current Package\n-   *         Document\n+   *           Document\n    */\n   public MetadataSet getMetadata()\n   {\n@@ -350,7 +350,7 @@ public class OPFHandler30 extends OPFHandler\n    * called after the parsing.\n    * \n    * @return the linked resources for the Rendition represented by the current\n-   *         Package Document\n+   *           Package Document\n    */\n   public LinkedResources getLinkedResources()\n   {\n@@ -363,7 +363,7 @@ public class OPFHandler30 extends OPFHandler\n    * the parsing.\n    * \n    * @return the linked resources for the Rendition represented by the current\n-   *         Package Document\n+   *           Package Document\n    */\n   public ResourceCollections getCollections()\n   {\n@@ -446,28 +446,67 @@ public class OPFHandler30 extends OPFHandler\n \n     String href = e.getAttribute(\"href\");\n     if (href != null)\n-    { // check by schema\n+    { // href presence is checked by schema\n \n+      // check the 'href' URL\n       URL url = checkURL(href);\n-      if (context.isRemote(url)) {\n+      if (context.isRemote(url))\n+      {\n         report.info(path, FeatureEnum.REFERENCE, href);\n       }\n-\n       if (context.xrefChecker.isPresent())\n       {\n         context.xrefChecker.get().registerReference(url, Type.LINK, location());\n       }\n \n+      // check the 'rel' attribute\n+      String rel = e.getAttribute(\"rel\");\n+      Set<Property> relSet = processLinkRel(rel);\n+      Set<LINKREL_PROPERTIES> relEnum = Property.filter(relSet, LINKREL_PROPERTIES.class);\n+\n+      // check the 'media-type' attribute\n+      String mediatype = e.getAttribute(\"media-type\");\n+      if (mediatype == null)\n+      {\n+        // media-type is required for in-container URLs\n+        // NOTE: as legacy EPUB 3.2 collections made heavy use\n+        // of local links with no media type, we only check this\n+        // for metadata links, which may be a violation of EPUB.\n+        if (!context.isRemote(url) && !metadataBuilders.isEmpty())\n+        {\n+          if (linkedResourcesBuilders.size() == 1)\n+            report.message(MessageId.OPF_093, location());\n+        }\n+        // media-type is required by some keywords\n+        else if (relEnum.stream().anyMatch(\n+            keyword -> keyword == LINKREL_PROPERTIES.RECORD\n+                || keyword == LINKREL_PROPERTIES.VOICING))\n+        {\n+          report.message(MessageId.OPF_094, location(), rel);\n+        }\n+      }\n+      else\n+      {\n+        // 'voicing' links require an audio media type\n+        if (relEnum.contains(LINKREL_PROPERTIES.VOICING) && !OPFChecker30.isAudioType(mediatype))\n+        {\n+          report.message(MessageId.OPF_095, location(), mediatype);\n+        }\n+      }\n+\n+      // check the 'properties' attribute\n+      processLinkProperties(e.getAttribute(\"properties\"));\n+\n+      // build the data model\n       if (!linkedResourcesBuilders.isEmpty())\n       {\n-        processLinkProperties(e.getAttribute(\"properties\"));\n         LinkedResource resource = new LinkedResource.Builder(url).id(e.getAttribute(\"id\"))\n-            .rel(processLinkRel(e.getAttribute(\"rel\"))).mimetype(e.getAttribute(\"media-type\"))\n-            .refines(e.getAttribute(\"refines\")).build();\n+            .rel(relSet).mimetype(mediatype).refines(e.getAttribute(\"refines\")).build();\n         linkedResourcesBuilders.peekFirst().add(resource);\n       }\n     }\n \n+    // check hreflang attribute\n     String hreflang = e.getAttribute(\"hreflang\");\n     if (hreflang != null && !hreflang.isEmpty())\n     {\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 5024c91..462b671 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -289,6 +289,9 @@ OPF_089=The \"alternate\" link rel keyword cannot be paired with other keywords.\n OPF_090=It is encouraged to use MIME media type \"%1$s\" instead of \"%2$s\".\n OPF_091=The item href URL must not have a fragment identifier.\n OPF_092=Language tag \"%1$s\" is not well-formed: %2$s\n+OPF_093=The \"media-type\" attribute is required for linked resources located in the EPUB container\n+OPF_094=The \"media-type\" attribute is required for \"%1$s\" links.\n+OPF_095=The \"media-type\" attribute of \"voicing\" links must be an audio MIME type, but found \"%1$s\". \n \n #Package\n PKG_001=Validating the EPUB against version %1$s but detected version %2$s.\ndiff --git a/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch b/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch\nindex 033049c..c444c5a 100644\n--- a/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch\n+++ b/src/main/resources/com/adobe/epubcheck/schema/30/package-30.sch\n@@ -34,8 +34,7 @@\n     \n     <pattern id=\"opf.link.record\">\n         <rule context=\"opf:link[tokenize(@rel,'\\s+')='record']\">\n-            <assert test=\"exists(@media-type)\">The type of \"record\" references must be identifiable\n-                from the link element\u2019s \"media-type\" attribute.</assert>\n+            <!--<assert test=\"exists(@media-type)\">**checked in java**</assert>-->\n             <assert test=\"empty(@refines)\">\"record\" links only applies to the Publication (must not\n                 have a \"refines\" attribute).</assert>\n         </rule>\n@@ -43,7 +42,7 @@\n     \n     <pattern id=\"opf.link.voicing\">\n         <rule context=\"opf:link[tokenize(@rel,'\\s+')='voicing']\">\n-            <assert test=\"starts-with(normalize-space(@media-type),'audio/')\">\"voicing\" links must have a \"media-type\" attribute identifying an audio MIME type.</assert>\n+            <!--<assert test=\"starts-with(normalize-space(@media-type),'audio/')\">**checked in java**</assert>-->\n             <assert test=\"exists(@refines)\">\"voicing\" links must have a \"refines\" attribute.</assert>\n         </rule>\n     </pattern>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/book.xml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/book.xml\nnew file mode 100644\nindex 0000000..945c328\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/book.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<feed xmlns=\"http://www.w3.org/2005/Atom\"\n+\txmlns:dc=\"http://purl.org/dc/terms/\"\n+\txmlns:opds=\"http://opds-spec.org/2010/catalog\">\n+\t\n+</feed>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..96ea27c\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..b80ce24\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\"\n+  prefix=\"test: http://example.org\">\n+  <metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+    <dc:language>en</dc:language>\n+    <dc:identifier id=\"q\">NOID</dc:identifier>\n+    <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+    <link rel=\"test:link\" href=\"book.xml\"/>\n+  </metadata>\n+  <manifest>\n+    <item id=\"content_001\" href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    <item id=\"nav\" href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"content_001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..2ca12ef\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/mimetype b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-local-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..96ea27c\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/content_001.xhtml\n@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\" />\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/package.opf\nnew file mode 100644\nindex 0000000..83c9c36\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\"\n+  prefix=\"test: http://example.org\">\n+  <metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+    <dc:language>en</dc:language>\n+    <dc:identifier id=\"q\">NOID</dc:identifier>\n+    <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+    <link rel=\"test:link\" href=\"https://example.org/\"/>\n+  </metadata>\n+  <manifest>\n+    <item id=\"content_001\" href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    <item id=\"nav\" href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"content_001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/META-INF/container.xml\nnew file mode 100644\nindex 0000000..2ca12ef\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/mimetype b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/05-package-document/files/package-link-media-type-missing-remote-valid/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\n", "test_patch": "diff --git a/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf b/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf\nindex b6b3732..ff5cb8f 100644\n--- a/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf\n@@ -5,7 +5,7 @@\n   <dc:language>en</dc:language>\n   <dc:identifier id=\"q\">NOID</dc:identifier>\n   <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n-  <link href=\"file:example\" rel=\"acquire\"/>\n+  <link href=\"file:example\" rel=\"acquire\" media-type=\"text/html\"/>\n </metadata>\n <manifest>\n   <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\ndiff --git a/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf b/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf\nindex 908b021..0430ba6 100644\n--- a/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf\n+++ b/src/test/resources/epub3/05-package-document/files/link-to-publication-resource-error.opf\n@@ -8,7 +8,7 @@\n         <dc:identifier id=\"uid\">NOID</dc:identifier>\n         <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n         <!--Linked resources MUST NOT be listed in the manifest.-->\n-        <link rel=\"example:property\" href=\"contents.xhtml#ch1\"/>\n+        <link rel=\"example:property\" href=\"contents.xhtml#ch1\" media-type=\"application/xhtml+xml\"/>\n     </metadata>\n     <manifest>\n         <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/book.opds b/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/book.opds\ndeleted file mode 100644\nindex 945c328..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/book.opds\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<feed xmlns=\"http://www.w3.org/2005/Atom\"\n-\txmlns:dc=\"http://purl.org/dc/terms/\"\n-\txmlns:opds=\"http://opds-spec.org/2010/catalog\">\n-\t\n-</feed>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/content_001.xhtml b/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/content_001.xhtml\ndeleted file mode 100644\nindex 96ea27c..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/content_001.xhtml\n+++ /dev/null\n@@ -1,11 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\" />\n-\t\t<title>Minimal EPUB</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Loomings</h1>\n-\t\t<p>Call me Ishmael.</p>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/nav.xhtml b/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/nav.xhtml\ndeleted file mode 100644\nindex 240745e..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/nav.xhtml\n+++ /dev/null\n@@ -1,14 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal Nav</title>\n-\t</head>\n-\t<body>\n-\t\t<nav epub:type=\"toc\">\n-\t\t\t<ol>\n-\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n-\t\t\t</ol>\n-\t\t</nav>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/package.opf b/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/package.opf\ndeleted file mode 100644\nindex b55821e..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/EPUB/package.opf\n+++ /dev/null\n@@ -1,17 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n-<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n-  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n-  <dc:language>en</dc:language>\n-  <dc:identifier id=\"q\">NOID</dc:identifier>\n-  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n-  <link rel=\"acquire\" href=\"book.opds\" />\n-</metadata>\n-<manifest>\n-  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n-  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-</manifest>\n-<spine>\n-  <itemref idref=\"content_001\" />\n-</spine>\n-</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/META-INF/container.xml b/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/META-INF/container.xml\ndeleted file mode 100644\nindex 2ca12ef..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/META-INF/container.xml\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n-\t<rootfiles>\n-\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n-\t</rootfiles>\n-</container>\ndiff --git a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/mimetype b/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/mimetype\ndeleted file mode 100644\nindex 57ef03f..0000000\n--- a/src/test/resources/epub3/05-package-document/files/package-link-missing-media-type-error/mimetype\n+++ /dev/null\n@@ -1,1 +0,0 @@\n-application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/05-package-document/package-document.feature b/src/test/resources/epub3/05-package-document/package-document.feature\nindex 09e3566..84917f9 100644\n--- a/src/test/resources/epub3/05-package-document/package-document.feature\n+++ b/src/test/resources/epub3/05-package-document/package-document.feature\n@@ -334,12 +334,15 @@ Feature: EPUB 3 \u2014 Package document\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-link-elem\n-  Scenario: A link to a local resource must declare a media type  \n-    When checking file 'package-link-missing-media-type-error'\n-    # Then error RSC-005 is reported\n-    # And the message contains 'missing required attribute \"media-type\"'\n-    # And no other errors or warnings are reported\n-    Then no other errors or warnings are reported\n+  Scenario: Report a missing 'media-type' attribute on links to container resources  \n+    When checking file 'package-link-media-type-missing-local-error'\n+    Then error OPF-093 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-link-elem\n+  Scenario: Allow a missing 'media-type' attribute on links to remote resources  \n+    When checking file 'package-link-media-type-missing-remote-valid'\n+    Then no errors or warnings are reported\n \n   @spec @xref:sec-link-elem\n   Scenario: the link 'rel' attribute can have multiple properties\ndiff --git a/src/test/resources/epub3/D-vocabularies/files/link-rel-record-mediatype-missing-error.opf b/src/test/resources/epub3/D-vocabularies/files/link-rel-record-mediatype-missing-error.opf\nindex 049eb67..93949b6 100644\n--- a/src/test/resources/epub3/D-vocabularies/files/link-rel-record-mediatype-missing-error.opf\n+++ b/src/test/resources/epub3/D-vocabularies/files/link-rel-record-mediatype-missing-error.opf\n@@ -6,7 +6,7 @@\n         <dc:language>en</dc:language>\n         <dc:identifier id=\"uid\">NOID</dc:identifier>\n         <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n-        <link rel=\"record\" href=\"record.atom\"/>\n+        <link rel=\"record\" href=\"https://example.org/record.atom\"/>\n     </metadata>\n     <manifest>\n         <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\ndiff --git a/src/test/resources/epub3/D-vocabularies/files/link-rel-voicing-mediatype-missing-error.opf b/src/test/resources/epub3/D-vocabularies/files/link-rel-voicing-mediatype-missing-error.opf\nindex d654c26..c421d8a 100644\n--- a/src/test/resources/epub3/D-vocabularies/files/link-rel-voicing-mediatype-missing-error.opf\n+++ b/src/test/resources/epub3/D-vocabularies/files/link-rel-voicing-mediatype-missing-error.opf\n@@ -6,7 +6,7 @@\n         <dc:language>en</dc:language>\n         <dc:identifier id=\"uid\">NOID</dc:identifier>\n         <meta property=\"dcterms:modified\">2019-01-01T12:00:00Z</meta>\n-        <link rel=\"voicing\" refines=\"#title\" href=\"title.mp3\"/>\n+        <link rel=\"voicing\" refines=\"#title\" href=\"http://example.org/title.mp3\"/>\n     </metadata>\n     <manifest>\n         <item id=\"t001\" href=\"contents.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>\ndiff --git a/src/test/resources/epub3/D-vocabularies/metadata-link.feature b/src/test/resources/epub3/D-vocabularies/metadata-link.feature\nindex 4eae22a..5ebd025 100644\n--- a/src/test/resources/epub3/D-vocabularies/metadata-link.feature\n+++ b/src/test/resources/epub3/D-vocabularies/metadata-link.feature\n@@ -33,7 +33,7 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Metadata link vocabulary\n     When checking file 'link-rel-alternate-with-other-keyword-error.opf'\n     Then error OPF-089 is reported\n     And no other errors or warnings are reported\n-\n+  \n \n   #### D.4.1.3, D.4.1.4, D.4.1.5, D.4.1.9 *-record\n   \n@@ -44,6 +44,8 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Metadata link vocabulary\n       | OPF-086 | \"mods-record\" is deprecated      |\n       | OPF-086 | \"onix-record\" is deprecated      |\n       | OPF-086 | \"xmp-record\" is deprecated       |\n+    And error OPF-093 is reported 4 times\n+      # note: 'media-type' is now required, even on deprecated properties\n     And no other errors or warnings are reported\n \n     \n@@ -62,10 +64,9 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Metadata link vocabulary\n     Then no errors or warnings are reported\n   \n   @spec @xref:sec-record\n-  Scenario: a 'record' link must have a 'media-type' attribute \n+  Scenario: a 'record' link must have a 'media-type' attribute even when remote \n     When checking file 'link-rel-record-mediatype-missing-error.opf'\n-    Then error RSC-005 is reported\n-    And the message contains \"media-type\"\n+    Then error OPF-094 is reported\n     And no other errors or warnings are reported\n \n   Scenario: a 'record' link type can be further identified with a 'properties' attribute\n@@ -95,17 +96,15 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Metadata link vocabulary\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-voicing\n-  Scenario: a 'voicing' link must have a 'media-type' attribute\n+  Scenario: a 'voicing' link must have a 'media-type' attribute even when remote\n     When checking file 'link-rel-voicing-mediatype-missing-error.opf'\n-    Then error RSC-005 is reported\n-    And the message contains 'must have a \"media-type\" attribute'\n+    Then error OPF-094 is reported\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-voicing\n   Scenario: a 'voicing' link resource must have an audio media type\n     When checking file 'link-rel-voicing-mediatype-not-audio-error.opf'\n-    Then error RSC-005 is reported\n-    And the message contains 'must have a \"media-type\" attribute identifying an audio MIME type'\n+    Then error OPF-095 is reported\n     And no other errors or warnings are reported\n \n \n@@ -115,4 +114,6 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Metadata link vocabulary\n     When checking file 'link-rel-xml-signature-deprecated-warning.opf'\n     Then warning OPF-086 is reported\n     And the message contains '\"xml-signature\" is deprecated'\n+    And error OPF-093 is reported\n+      # note: 'media-type' is now required, even on deprecated properties\n     And no other errors or warnings are reported\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T23:17:03.761129Z", "commit_hash": "035effaf9be340528b0c53f56c99748d3bba2eca", "commit_message": "fix: declaring prefixes for default vocabs is an error\n\nThis commit reverts `OPF-007b` to being an error.\n\nFixes #1306\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 5b11ad3..0383b3e 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -199,7 +199,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.OPF_006, Severity.ERROR);\n     severities.put(MessageId.OPF_007, Severity.WARNING);\n     severities.put(MessageId.OPF_007a, Severity.ERROR);\n-    severities.put(MessageId.OPF_007b, Severity.WARNING);\n+    severities.put(MessageId.OPF_007b, Severity.ERROR);\n     severities.put(MessageId.OPF_008, Severity.ERROR);\n     severities.put(MessageId.OPF_009, Severity.ERROR);\n     severities.put(MessageId.OPF_010, Severity.ERROR);\n", "test_patch": "diff --git a/src/test/java/com/adobe/epubcheck/vocab/VocabTest.java b/src/test/java/com/adobe/epubcheck/vocab/VocabTest.java\nindex a8d1ef1..e6821a1 100644\n--- a/src/test/java/com/adobe/epubcheck/vocab/VocabTest.java\n+++ b/src/test/java/com/adobe/epubcheck/vocab/VocabTest.java\n@@ -375,7 +375,7 @@ public class VocabTest\n   @Test\n   public void testDefaultDeclaredPrefix()\n   {\n-    expectedWarnings.add(MessageId.OPF_007b);\n+    expectedErrors.add(MessageId.OPF_007b);\n     Map<String, Vocab> actual = testVocabs(\n         \"default: http://example.org/default# hello: http://example.org/hello#\");\n     assertThat(actual.entrySet().size(), is(PREDEF_VOCABS.keySet().size() + 1));\ndiff --git a/src/test/resources/epub3/D-vocabularies/vocabulary-association.feature b/src/test/resources/epub3/D-vocabularies/vocabulary-association.feature\nindex 0cab8d7..20deee1 100644\n--- a/src/test/resources/epub3/D-vocabularies/vocabulary-association.feature\n+++ b/src/test/resources/epub3/D-vocabularies/vocabulary-association.feature\n@@ -27,10 +27,8 @@ Feature: EPUB 3 \u2014 Vocabularies \u2014 Vocabulary association\n \n   @spec @xref:sec-prefix-attr\n   Scenario: default vocabularies must not be assigned a prefix\n-  \tNote: This should be an error, but is currently reported as a warning\n-  \tSee issue 522: https://github.com/w3c/epubcheck/issues/522\n     When checking file 'property-prefix-declaration-default-vocabs-error.opf'\n-    Then warning OPF-007b is reported 4 times (once for each default vocabulary)\n+    Then error OPF-007b is reported 4 times (once for each default vocabulary)\n     And no other errors or warnings are reported\n \n   @spec @xref:sec-prefix-attr\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T23:29:15.482322Z", "commit_hash": "5635807bc0f9839387df4717e3a096dab596a91b", "commit_message": "fix: support CSS logical combination pseudo-classes\n\nThis commit update the CSS grammar parser to support funcitonal pseudo-\nclasses taking selector listrs as argument.\n\nIn effect, this impacts the parsing of the following pseudo-classes:\n- `:is()` (taking a forgiving selector list)\n- `:not()` (taking a selector list)\n- `:where()` (taking a forgiving selector list)\n- `:has()` (taking a forgiving relative selector list)\n\nFixes #1289, Fixes #1354\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/org/idpf/epubcheck/util/css/CssGrammar.java b/src/main/java/org/idpf/epubcheck/util/css/CssGrammar.java\nindex 76ad868..75f4622 100644\n--- a/src/main/java/org/idpf/epubcheck/util/css/CssGrammar.java\n+++ b/src/main/java/org/idpf/epubcheck/util/css/CssGrammar.java\n@@ -823,6 +823,7 @@ public class CssGrammar\n       while (next.type != CssToken.Type.S\n           && !MATCH_COMMA.apply(next)\n           && !MATCH_OPENBRACE.apply(next)\n+          && !MATCH_CLOSEPAREN.apply(next)\n           && !MATCH_COMBINATOR_CHAR.apply(next))\n       {\n         seqItem = createSimpleSelector(iter.next(FILTER_NONE), iter, err);\n@@ -838,9 +839,89 @@ public class CssGrammar\n     }\n \n     /**\n-     * Create one item in a simple selector sequence. If creation fails,\n-     * errors are issued, and null is returned. On return, the iterator\n-     * will return the next token after the constructs last token.\n+     * With start inparam being the first significant token in a selector, build\n+     * the selector group (aka comma separated selectors), expected return when\n+     * iter.last is '{'. On error, issue to errorlistener, and return (caller\n+     * will forward).\n+     *\n+     * @return A syntactically valid CssSelector list, or null if fail.\n+     * @throws CssException\n+     */\n+\n+    public List<CssSelector> createSelectorList(CssToken start, CssTokenIterator iter,\n+        CssErrorHandler err)\n+      throws CssException\n+    {\n+      return createSelectorList(start, iter, err, false, false, MATCH_OPENBRACE);\n+    }\n+    \n+    private List<CssSelector> createSelectorList(CssToken start, CssTokenIterator iter,\n+        CssErrorHandler err, boolean forgiving, boolean relative, Predicate<CssToken> endMatcher)\n+      throws CssException\n+    {\n+\n+      List<CssSelector> selectors = Lists.newArrayList();\n+      boolean end = false;\n+      while (true)\n+      { // comma loop\n+        CssSelector selector = new CssSelector(start.location);\n+        int selectorIndex = iter.index();\n+        while (true)\n+        { // combinator loop\n+          if (!relative || iter.index() > selectorIndex)\n+          {\n+            CssSimpleSelectorSequence seq = createSimpleSelectorSequence(start, iter,\n+                (forgiving) ? ForgivingErrorHandler.INSTANCE : err);\n+            if (seq == null)\n+            {\n+              // errors already issued\n+              return null;\n+            }\n+            selector.components.add(seq);\n+            start = iter.next();\n+          }\n+          int idx = iter.index();\n+          if (endMatcher.apply(start))\n+          {\n+            end = true;\n+            break;\n+          }\n+          if (MATCH_COMMA.apply(start))\n+          {\n+            break;\n+          }\n+\n+          CssSelectorCombinator comb = createCombinator(start, iter, err);\n+          if (comb != null)\n+          {\n+            selector.components.add(comb);\n+            start = iter.next();\n+          }\n+          else if (iter.list.get(idx - 1).type == CssToken.Type.S)\n+          {\n+            selector.components.add(new CssSelectorCombinator(' ', start.location));\n+          }\n+          else\n+          {\n+            err.error(new CssGrammarException(GRAMMAR_UNEXPECTED_TOKEN, iter.last.location,\n+                messages.getLocale(), iter.last.chars));\n+            return null;\n+          }\n+        } // combinator loop\n+        selectors.add(selector);\n+        if (end)\n+        {\n+          break;\n+        }\n+        start = iter.next();\n+      } // comma loop\n+      return selectors;\n+    }\n+\n+    /**\n+     * Create one item in a simple selector sequence. If creation fails, errors\n+     * are issued, and null is returned. On return, the iterator will return the\n+     * next token after the constructs last token.\n      */\n     CssConstruct createSimpleSelector(final CssToken start, final CssTokenIterator iter,\n         final CssErrorHandler err) throws\n@@ -971,13 +1052,21 @@ public class CssGrammar\n         //pseudo: type_selector | universal | HASH | class | attrib | pseudo\n \n         CssConstruct func;\n-        if (Ascii.toLowerCase(next.getChars()).startsWith(\"not\"))\n-        {\n-          func = createNegationPseudo(tk, iter, err);\n-        }\n-        else\n+        switch (Ascii.toLowerCase(next.getChars()))\n         {\n+        case \"not(\":\n+          func = createFunctionalSelectorListPseudo(tk, iter, err, false, false);\n+          break;\n+        case \"is(\":\n+        case \"where(\":\n+          func = createFunctionalSelectorListPseudo(tk, iter, err, true, false);\n+          break;\n+        case \"has(\":\n+          func = createFunctionalSelectorListPseudo(tk, iter, err, true, true);\n+          break;\n+        default:\n           func = createFunctionalPseudo(tk, iter, MATCH_OPENBRACE, err);\n+          break;\n         }\n \n         if (func == null)\n@@ -1021,9 +1110,9 @@ public class CssGrammar\n       return function;\n     }\n \n-    CssConstruct createNegationPseudo(final CssToken start,\n-        final CssTokenIterator iter, final CssErrorHandler err) throws\n-        CssException\n+    CssConstruct createFunctionalSelectorListPseudo(final CssToken start,\n+        final CssTokenIterator iter, final CssErrorHandler err, boolean forgiving, boolean relative)\n+      throws CssException\n     {\n \n       String name = start.getChars().substring(0, start.getChars().length() - 1);\n@@ -1031,15 +1120,18 @@ public class CssGrammar\n       CssFunction negation = new CssFunction(name, start.location);\n \n       CssToken tk = iter.next();\n-      CssConstruct cc = createSimpleSelector(tk, iter, err);\n-      if (cc == null || !ContextRestrictions.PSEUDO_NEGATION.apply(cc))\n+      List<CssSelector> selectors = createSelectorList(tk, iter, err, forgiving, relative,\n+          MATCH_CLOSEPAREN);\n+      if (selectors == null)\n       {\n         return null;\n       }\n       else\n       {\n-        negation.components.add(cc);\n-        iter.next();\n+        for (CssSelector selector : selectors)\n+        {\n+          negation.components.add(selector);\n+        }\n       }\n       return negation;\n     }\ndiff --git a/src/main/java/org/idpf/epubcheck/util/css/CssParser.java b/src/main/java/org/idpf/epubcheck/util/css/CssParser.java\nindex e766a5f..1dc9bb7 100644\n--- a/src/main/java/org/idpf/epubcheck/util/css/CssParser.java\n+++ b/src/main/java/org/idpf/epubcheck/util/css/CssParser.java\n@@ -40,16 +40,13 @@ import org.idpf.epubcheck.util.css.CssGrammar.CssConstruct;\n import org.idpf.epubcheck.util.css.CssGrammar.CssConstructFactory;\n import org.idpf.epubcheck.util.css.CssGrammar.CssDeclaration;\n import org.idpf.epubcheck.util.css.CssGrammar.CssSelector;\n-import org.idpf.epubcheck.util.css.CssGrammar.CssSelectorCombinator;\n import org.idpf.epubcheck.util.css.CssGrammar.CssSelectorConstructFactory;\n-import org.idpf.epubcheck.util.css.CssGrammar.CssSimpleSelectorSequence;\n import org.idpf.epubcheck.util.css.CssToken.CssTokenConsumer;\n import org.idpf.epubcheck.util.css.CssTokenList.CssTokenIterator;\n import org.idpf.epubcheck.util.css.CssTokenList.PrematureEOFException;\n \n import com.adobe.epubcheck.util.Messages;\n import com.google.common.base.Predicate;\n-import com.google.common.collect.Lists;\n \n /**\n  * A CSS parser.\n@@ -227,7 +224,7 @@ public final class CssParser\n     char errChar = '{';\n     try\n     {\n-      List<CssSelector> selectors = handleSelectors(start, iter, err);\n+      List<CssSelector> selectors = cssSelectorFactory.createSelectorList(start, iter, err);\n       errChar = '}';\n       if (selectors == null)\n       {\n@@ -235,6 +232,12 @@ public final class CssParser\n         iter.next(MATCH_CLOSEBRACE);\n         return;\n       }\n+      if (MATCH_CLOSEPAREN.apply(iter.last)) {\n+        err.error(new CssGrammarException(GRAMMAR_UNEXPECTED_TOKEN, iter.last.location,\n+            messages.getLocale(), iter.last.chars));\n+        iter.next(MATCH_CLOSEBRACE);\n+        return;\n+      }\n       if (debug)\n       {\n         checkState(iter.last.getChar() == '{');\n@@ -454,78 +457,6 @@ public final class CssParser\n   }\n \n   /**\n-   * With start inparam being the first significant token in a selector, build\n-   * the selector group (aka comma separated selectors), expected return when\n-   * iter.last is '{'. On error, issue to errorlistener, and return\n-   * (caller will forward).\n-   *\n-   * @return A syntactically valid CssSelector list, or null if fail.\n-   * @throws CssException\n-   */\n-  private List<CssSelector> handleSelectors(CssToken start, CssTokenIterator iter,\n-      CssErrorHandler err) throws\n-      CssException\n-  {\n-\n-    List<CssSelector> selectors = Lists.newArrayList();\n-    boolean end = false;\n-    while (true)\n-    { // comma loop\n-      CssSelector selector = new CssSelector(start.location);\n-      while (true)\n-      { //combinator loop\n-        CssSimpleSelectorSequence seq = cssSelectorFactory.createSimpleSelectorSequence(start, iter,\n-            err);\n-        if (seq == null)\n-        {\n-          //errors already issued\n-          return null;\n-        }\n-        selector.components.add(seq);\n-        int idx = iter.index();\n-        start = iter.next();\n-        if (MATCH_OPENBRACE.apply(start))\n-        {\n-          end = true;\n-          break;\n-        }\n-        if (MATCH_COMMA.apply(start))\n-        {\n-          break;\n-        }\n-\n-        CssSelectorCombinator comb = cssSelectorFactory.createCombinator(start, iter, err);\n-        if (comb != null)\n-        {\n-          selector.components.add(comb);\n-          start = iter.next();\n-        }\n-        else if (iter.list.get(idx + 1).type == CssToken.Type.S)\n-        {\n-          selector.components.add(new CssSelectorCombinator(' ', start.location));\n-        }\n-        else\n-        {\n-          err.error(new CssGrammarException(GRAMMAR_UNEXPECTED_TOKEN, iter.last.location,\n-              messages.getLocale(), iter.last.chars));\n-          return null;\n-        }\n-      } //combinator loop\n-      selectors.add(selector);\n-      if (end)\n-      {\n-        break;\n-      }\n-      if (debug)\n-      {\n-        checkState(MATCH_COMMA.apply(start));\n-      }\n-      start = iter.next();\n-    } // comma loop\n-    return selectors;\n-  }\n-\n-  /**\n    * With start token required to be an ATKEYWORD, collect at-rule parameters if\n    * any, and if the at-rule has a block, invoke those handlers.\n    */\n@@ -759,23 +690,6 @@ public final class CssParser\n             ;\n       }\n     };\n-\n-    /**\n-     * A context restriction for elements inside a negation pseudo.\n-     */\n-    static final Predicate<CssConstruct> PSEUDO_NEGATION = new Predicate<CssConstruct>()\n-    {\n-      public boolean apply(final CssConstruct cc)\n-      {\n-        checkNotNull(cc);\n-        return cc.type == CssConstruct.Type.TYPE_SELECTOR\n-            || cc.type == CssConstruct.Type.HASHNAME\n-            || cc.type == CssConstruct.Type.CLASSNAME\n-            || (cc.type == CssConstruct.Type.ATTRIBUTE_SELECTOR)\n-            || (cc.type == CssConstruct.Type.PSEUDO)\n-            ;\n-      }\n-    };\n   }\n \n }\ndiff --git a/src/main/java/org/idpf/epubcheck/util/css/ForgivingErrorHandler.java b/src/main/java/org/idpf/epubcheck/util/css/ForgivingErrorHandler.java\nnew file mode 100644\nindex 0000000..5e8d6c1\n--- /dev/null\n+++ b/src/main/java/org/idpf/epubcheck/util/css/ForgivingErrorHandler.java\n@@ -0,0 +1,17 @@\n+package org.idpf.epubcheck.util.css;\n+\n+import org.idpf.epubcheck.util.css.CssExceptions.CssException;\n+\n+public final class ForgivingErrorHandler implements CssErrorHandler\n+{\n+\n+  public static final ForgivingErrorHandler INSTANCE = new ForgivingErrorHandler();\n+\n+  @Override\n+  public void error(CssException e)\n+    throws CssException\n+  {\n+    // do nothing\n+  }\n+\n+}\n", "test_patch": "diff --git a/src/test/resources/epub3/00-minimal/minimal.feature b/src/test/resources/epub3/00-minimal/minimal.feature\nindex 4a37141..efb5209 100644\n--- a/src/test/resources/epub3/00-minimal/minimal.feature\n+++ b/src/test/resources/epub3/00-minimal/minimal.feature\n@@ -8,7 +8,6 @@\n     Given EPUB test files located at '/epub3/00-minimal/files/'\n     And EPUBCheck with default settings\n \n-\n   Scenario: Verify a minimal expanded EPUB\n     When checking EPUB 'minimal'\n     Then no errors or warnings are reported\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-css-selectors-valid/EPUB/style.css b/src/test/resources/epub3/06-content-document/files/content-css-selectors-valid/EPUB/style.css\nindex 63fbe07..4cc15e7 100644\n--- a/src/test/resources/epub3/06-content-document/files/content-css-selectors-valid/EPUB/style.css\n+++ b/src/test/resources/epub3/06-content-document/files/content-css-selectors-valid/EPUB/style.css\n@@ -29,3 +29,23 @@ p > span:nth-child(even) {\n div[epub|type = \"chapter\"] {\n   padding: 2em;\n }\n+\n+:active {\n+  font-size: 1em;\n+}\n+\n+:is(h1,h2,h3) {\n+  font-size: 1em;\n+}\n+\n+:not(nav[epub|type=\"landmarks\"]) {\n+  font-size: 1em;\n+}\n+\n+:not(nav.class) {\n+  font-size: 1em;\n+}\n+\n+:has(>img) {\n+  font-size: 1em;\n+}\n\\ No newline at end of file\n"}
{"repository": "w3c/epubcheck", "clone_url": "https://github.com/w3c/epubcheck.git", "timestamp": "2023-05-30T23:38:29.335262Z", "commit_hash": "0f6b50922ba046c89e448f93778f8bc8758efb45", "commit_message": "feat: report 'file' URLs as errors\n\nReport `file:` URLs as a new error RSC-030\n\nFixes #1270\n", "related_issues": "", "bug_patch": "diff --git a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\nindex 77621f6..5b11ad3 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/DefaultSeverities.java\n@@ -136,7 +136,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.HTM_050, Severity.SUPPRESSED);\n     severities.put(MessageId.HTM_051, Severity.WARNING);\n     severities.put(MessageId.HTM_052, Severity.ERROR);\n-    severities.put(MessageId.HTM_053, Severity.INFO);\n+    severities.put(MessageId.HTM_053, Severity.SUPPRESSED);\n     severities.put(MessageId.HTM_054, Severity.ERROR);\n     severities.put(MessageId.HTM_055, Severity.WARNING);\n     severities.put(MessageId.HTM_056, Severity.ERROR);\n@@ -343,6 +343,7 @@ class DefaultSeverities implements Severities\n     severities.put(MessageId.RSC_027, Severity.WARNING);\n     severities.put(MessageId.RSC_028, Severity.ERROR);\n     severities.put(MessageId.RSC_029, Severity.ERROR);\n+    severities.put(MessageId.RSC_030, Severity.ERROR);\n \n     // Scripting\n     severities.put(MessageId.SCP_001, Severity.SUPPRESSED); // checking scripts is out of scope\ndiff --git a/src/main/java/com/adobe/epubcheck/messages/MessageId.java b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\nindex 63e6692..480cf65 100644\n--- a/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n+++ b/src/main/java/com/adobe/epubcheck/messages/MessageId.java\n@@ -337,6 +337,7 @@ public enum MessageId implements Comparable<MessageId>\n   RSC_027(\"RSC-027\"),\n   RSC_028(\"RSC-028\"),\n   RSC_029(\"RSC-029\"),\n+  RSC_030(\"RSC-030\"),\n \n   // Messages relating to scripting\n   SCP_001(\"SCP-001\"),\ndiff --git a/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java b/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java\nindex f2590e9..4644178 100755\n--- a/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java\n+++ b/src/main/java/com/adobe/epubcheck/ops/OPSHandler.java\n@@ -142,11 +142,6 @@ public class OPSHandler extends XMLHandler\n     // If the URL was not properly parsed, return early\n     if (url == null) return;\n \n-    if (\"file\".equals(url.scheme()))\n-    {\n-      // FIXME next disallow file URLs\n-      report.message(MessageId.HTM_053, location(), url);\n-    }\n     if (context.isRemote(url))\n     {\n       report.info(path, FeatureEnum.REFERENCE, href);\ndiff --git a/src/main/java/org/w3c/epubcheck/url/URLChecker.java b/src/main/java/org/w3c/epubcheck/url/URLChecker.java\nindex fb98e98..3a4b189 100644\n--- a/src/main/java/org/w3c/epubcheck/url/URLChecker.java\n+++ b/src/main/java/org/w3c/epubcheck/url/URLChecker.java\n@@ -72,6 +72,12 @@ public class URLChecker\n     if (string == null) return null;\n     try\n     {\n+      // Report file URLs\n+      if (string.startsWith(\"file:\"))\n+      {\n+        report.message(MessageId.RSC_030, location, string);\n+      }\n+\n       // Collapse formatting whitespace in data URLs\n       if (string.startsWith(\"data:\"))\n       {\ndiff --git a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\nindex 7a4250e..5024c91 100644\n--- a/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n+++ b/src/main/resources/com/adobe/epubcheck/messages/MessageBundle.properties\n@@ -121,7 +121,6 @@ HTM_049_SUG=Add xmlns=\"http://www.w3.org/1999/xhtml\" to the html element.\n HTM_050=Found epub:type=\"pagebreak\" attribute in content document.\n HTM_051=Found Microdata semantic enrichments but no RDFa. EDUPUB recommends using RDFa Lite.\n HTM_052=The property \"region-based\" is only allowed on nav elements in Data Navigation Documents.\n-HTM_053=Found an external file link (file://) in file: \"%1$s\".\n HTM_054=Custom attribute namespace (\"%1$s\") must not include the string \"%2$s\" in its domain.\n HTM_055=The \"%1$s\" element should not be used (discouraged construct)\n HTM_056=Viewport metadata has no \"%1$s\" dimension (both \"width\" and \"height\" properties are required)\n@@ -353,6 +352,7 @@ RSC_026=URL \"%1$s\" leaks outside the container (it is not a valid-relative-ocf-U\n RSC_027=XML document is encoded in UTF-16. It should be encoded in UTF-8 instead.\n RSC_028=XML documents must be encoded in UTF-8, but %1%s was detected.\n RSC_029=Data URL is not allowed in this context.\n+RSC_030=File URLs are not allowed in EPUB, but found \"%1$s\".\n \n #Scripting\n SCP_001=Use of Javascript eval() function in EPUB scripts is a security risk.\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/content_001.xhtml b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/content_001.xhtml\nnew file mode 100644\nindex 0000000..bf2bf7f\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/content_001.xhtml\n@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t\t<link type=\"text/css\" rel=\"stylesheet\" href=\"style.css\" />\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/nav.xhtml b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/nav.xhtml\nnew file mode 100644\nindex 0000000..240745e\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/nav.xhtml\n@@ -0,0 +1,14 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal Nav</title>\n+\t</head>\n+\t<body>\n+\t\t<nav epub:type=\"toc\">\n+\t\t\t<ol>\n+\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n+\t\t\t</ol>\n+\t\t</nav>\n+\t</body>\n+</html>\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/package.opf b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/package.opf\nnew file mode 100644\nindex 0000000..74d5077\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/package.opf\n@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+  <metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+    <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+    <dc:language>en</dc:language>\n+    <dc:identifier id=\"q\">NOID</dc:identifier>\n+    <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  </metadata>\n+  <manifest>\n+    <item id=\"content_001\" href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+    <item id=\"nav\" href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+    <item id=\"css\" href=\"style.css\" media-type=\"text/css\" properties=\"remote-resources\"/>\n+    <item id=\"font\" href=\"file:///font.woff\" media-type=\"font/woff\"/>\n+  </manifest>\n+  <spine>\n+    <itemref idref=\"content_001\"/>\n+  </spine>\n+</package>\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/style.css b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/style.css\nnew file mode 100644\nindex 0000000..e691f38\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/EPUB/style.css\n@@ -0,0 +1,4 @@\n+@font-face {\n+  font-family: \"myfont\";\n+  src: url('file:/font.woff');\n+}\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-css-error/META-INF/container.xml b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/META-INF/container.xml\nnew file mode 100644\nindex 0000000..2ca12ef\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/META-INF/container.xml\n@@ -0,0 +1,6 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\">\n+\t<rootfiles>\n+\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n+\t</rootfiles>\n+</container>\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-css-error/mimetype b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/mimetype\nnew file mode 100644\nindex 0000000..57ef03f\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-css-error/mimetype\n@@ -0,0 +1,1 @@\n+application/epub+zip\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf b/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf\nnew file mode 100644\nindex 0000000..b6b3732\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-package-document-error.opf\n@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n+<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n+  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n+  <dc:language>en</dc:language>\n+  <dc:identifier id=\"q\">NOID</dc:identifier>\n+  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n+  <link href=\"file:example\" rel=\"acquire\"/>\n+</metadata>\n+<manifest>\n+  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n+  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n+</manifest>\n+<spine>\n+  <itemref idref=\"content_001\" />\n+</spine>\n+</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml b/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml\nnew file mode 100644\nindex 0000000..bc75bc2\n--- /dev/null\n+++ b/src/test/resources/epub3/03-resources/files/file-url-in-xhtml-content-error.xhtml\n@@ -0,0 +1,12 @@\n+<!DOCTYPE html>\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+\t<head>\n+\t\t<meta charset=\"utf-8\"/>\n+\t\t<title>Minimal EPUB</title>\n+\t</head>\n+\t<body>\n+\t\t<h1>Loomings</h1>\n+\t\t<p>Call me Ishmael.</p>\n+\t\t<a href=\"file:example\">file</a>\n+\t</body>\n+</html>\n", "test_patch": "diff --git a/src/test/resources/epub3/03-resources/resources.feature b/src/test/resources/epub3/03-resources/resources.feature\nindex 105f4ef..16a8080 100644\n--- a/src/test/resources/epub3/03-resources/resources.feature\n+++ b/src/test/resources/epub3/03-resources/resources.feature\n@@ -442,6 +442,27 @@\n     Then error MED-003 is reported\n     And no other errors or warnings are reported\n \n+  ## 3.8 File URLs\n+\n+  @spec @xref:sec-file-urls\n+  Scenario: Report a file URL used in the package document\n+    When checking document 'file-url-in-package-document-error.opf'\n+    Then error RSC-030 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-file-urls\n+  Scenario: Report a file URL used in a content document\n+    When checking document 'file-url-in-xhtml-content-error.xhtml'\n+    Then error RSC-030 is reported\n+    And no other errors or warnings are reported\n+\n+  @spec @xref:sec-file-urls\n+  Scenario: Report a file URL used in a CSS document\n+    When checking EPUB 'file-url-in-css-error'\n+    Then error RSC-030 is reported 2 times (one in the package doc, one in the CSS)\n+    And no other errors or warnings are reported\n+\n+\n   ## 3.9 XML conformance\n \n   @spec @xref:sec-xml-constraints\ndiff --git a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\nindex e3e4cf1..0fa079f 100644\n--- a/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n+++ b/src/test/resources/epub3/06-content-document/content-document-xhtml.feature\n@@ -249,18 +249,10 @@ Feature: EPUB 3 \u2014 Content Documents \u2014 XHTML\n \n   ####  hyperlinks\n \n-  @spec @xref:sec-file-urls\n-  Scenario: Report as an INFO a hyperlink to a resource in the local file system\n-    See issue #289\n-    When checking EPUB 'content-xhtml-link-to-local-file-valid'\n-    Then info HTM-053 is reported\n-    And no errors or warnings are reported\n-\n   Scenario: Do not report escaped hyperlinks to resources in the local file system\n     See issue #1182\n     When checking EPUB 'content-xhtml-link-to-local-file-escaped-valid'\n-    Then info HTM-053 is reported 0 times\n-    And no errors or warnings are reported\n+    Then no errors or warnings are reported\n     \n   @spec @xref:sec-container-iri\n   Scenario: Report a hyperlink to a resource missing from the publication\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/content_001.xhtml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/content_001.xhtml\ndeleted file mode 100644\nindex 1afb25b..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/content_001.xhtml\n+++ /dev/null\n@@ -1,12 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal EPUB</title>\n-\t</head>\n-\t<body>\n-\t\t<h1>Loomings</h1>\n-\t\t<p>Call me Ishmael.</p>\n-\t\t<a class=\"external\" href=\"file:///C:/path/file.pdf\">link to local file</a>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/nav.xhtml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/nav.xhtml\ndeleted file mode 100644\nindex 240745e..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/nav.xhtml\n+++ /dev/null\n@@ -1,14 +0,0 @@\n-<!DOCTYPE html>\n-<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\" xml:lang=\"en\" lang=\"en\">\n-\t<head>\n-\t\t<meta charset=\"utf-8\"/>\n-\t\t<title>Minimal Nav</title>\n-\t</head>\n-\t<body>\n-\t\t<nav epub:type=\"toc\">\n-\t\t\t<ol>\n-\t\t\t\t<li><a href=\"content_001.xhtml\">content 001</a></li>\n-\t\t\t</ol>\n-\t\t</nav>\n-\t</body>\n-</html>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/package.opf b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/package.opf\ndeleted file mode 100644\nindex 0d1eec6..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/EPUB/package.opf\n+++ /dev/null\n@@ -1,16 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<package xmlns=\"http://www.idpf.org/2007/opf\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"q\">\n-<metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n-  <dc:title id=\"title\">Minimal EPUB 3.0</dc:title>\n-  <dc:language>en</dc:language>\n-  <dc:identifier id=\"q\">NOID</dc:identifier>\n-  <meta property=\"dcterms:modified\">2017-06-14T00:00:01Z</meta>\n-</metadata>\n-<manifest>\n-  <item id=\"content_001\"  href=\"content_001.xhtml\" media-type=\"application/xhtml+xml\"/>\n-  <item id=\"nav\"  href=\"nav.xhtml\" media-type=\"application/xhtml+xml\" properties=\"nav\"/>\n-</manifest>\n-<spine>\n-  <itemref idref=\"content_001\" />\n-</spine>\n-</package>\n\\ No newline at end of file\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/META-INF/container.xml b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/META-INF/container.xml\ndeleted file mode 100644\nindex 3187821..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/META-INF/container.xml\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n-<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">\n-\t<rootfiles>\n-\t\t<rootfile full-path=\"EPUB/package.opf\" media-type=\"application/oebps-package+xml\"/>\n-\t</rootfiles>\n-</container>\ndiff --git a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/mimetype b/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/mimetype\ndeleted file mode 100644\nindex 57ef03f..0000000\n--- a/src/test/resources/epub3/06-content-document/files/content-xhtml-link-to-local-file-valid/mimetype\n+++ /dev/null\n@@ -1,1 +0,0 @@\n-application/epub+zip\n\\ No newline at end of file\n"}
